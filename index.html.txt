<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N字戰法：三盤轉折判斷計算機 (V11.1 戰情預判版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 卷軸美化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .invalid-target { text-decoration: line-through; color: #9ca3af; }
        .input-error { border-color: #ef4444 !important; ring: 2px; ring-color: #ef4444; background-color: #fef2f2; }
        
        /* 閃爍提醒特效 */
        @keyframes highlightPulse {
            0% { background-color: #fff; }
            50% { background-color: #fef9c3; } /* yellow-100 */
            100% { background-color: #fff; }
        }
        .highlight-input { animation: highlightPulse 1s ease-in-out; }

        /* 摺疊選單樣式 */
        details > summary { list-style: none; cursor: pointer; transition: all 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { margin-bottom: 0.5rem; }
        details > summary:hover { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden border border-slate-300 relative">
        <!-- Header -->
        <div class="bg-slate-900 p-5 text-white text-center relative z-20">
            <h1 class="text-2xl font-black tracking-wider">N字戰法指揮中心 by.石頭 <span class="text-yellow-400 text-sm align-top">V11.1</span></h1>
            <p class="text-xs text-slate-400 mt-1">實戰圖解 x 盤態判讀 x 模擬演習</p>
        </div>

        <!-- 戰法百科全書 (Accordion Menu) -->
        <div class="bg-slate-50 border-b border-slate-200">
            <div class="p-3 text-center bg-blue-700 text-white font-bold text-sm cursor-pointer hover:bg-blue-800 transition-colors" onclick="toggleEncyclopedia()">
                📖 點我打開：N字戰法全能百科 (圖解精華) ▼
            </div>
            
            <div id="encyclopediaContent" class="hidden max-h-[500px] overflow-y-auto p-4 space-y-3 shadow-inner bg-white">
                
                <!-- Part 1: 基礎趨勢 -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-2 mb-1">第一篇：基礎趨勢與轉折 (定多空)</div>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>1. 趨勢篇：末升低 & 末跌高</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">● 末升低 (Last Rising Low)：</span>多頭創高波段的「起漲點」。<br>邏輯：守住末升低=多頭，跌破=趨勢破壞。</p>
                        <p><span class="font-bold text-green-600">● 末跌高 (Last Falling High)：</span>空頭創低波段的「起跌點」。<br>邏輯：突破末跌高=空翻多。</p>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>2. 轉折訊號：日出線 & 日落線</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">🌅 日出線 (Sunrise)：</span>高過昨高，收盤收高。<br>用途：回檔時的止跌買訊。</p>
                        <p><span class="font-bold text-green-600">🌇 日落線 (Sunset)：</span>低破昨低，收盤收低。<br>用途：上漲時的止漲賣訊。</p>
                        <p class="bg-indigo-50 p-1 rounded font-bold text-center">口訣：回檔找日出，上漲防日落。</p>
                    </div>
                </details>

                <details class="group border border-purple-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-purple-800 bg-purple-50 p-3">
                        <span>3. 防守篇：軋空低 & 翻紅定義</span>
                        <span class="text-purple-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                        <p><span class="font-bold bg-indigo-100 text-indigo-800 px-1 rounded">翻紅K棒：</span> 寶塔線由綠翻紅 (收盤 > 前三高) 當天的那根K棒。</p>
                        <p><span class="font-bold bg-purple-100 text-purple-800 px-1 rounded">軋空低：</span> 翻紅K棒的<span class="text-red-600 font-bold">最低點</span>。</p>
                        
                        <!-- 成本迷思解惑 -->
                        <div class="bg-red-50 p-2 rounded border border-red-200">
                            <p class="font-bold text-red-800 border-b border-red-200 pb-1 mb-1">💡 軋空低填哪一天？</p>
                            <p class="mb-1 text-slate-800 font-bold">N字戰法操作「當下」，不問成本！</p>
                            <div class="grid grid-cols-1 gap-2 mt-2">
                                <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                    <p class="font-bold text-yellow-800">📌 情境 A (空手想買)</p>
                                    <p>輸入：填 <span class="font-bold text-red-600">「今天」</span> 的盤中最低點。</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-200">
                                    <p class="font-bold text-green-800">📌 情境 B (持有續抱)</p>
                                    <p>輸入：填 <span class="font-bold text-red-600">「當初買進那天」</span> 的最低點。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                 <!-- NEW: 寶塔線邏輯 -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">第二篇：寶塔線與盤態圖解 (重點)</div>

                <details class="group border border-blue-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-blue-800 bg-blue-50 p-3">
                        <span>4. 原理篇：寶塔線 (TOW) 邏輯詳解</span>
                        <span class="text-blue-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                         <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                            <p class="font-bold text-yellow-900 border-b border-yellow-200 pb-1 mb-1">💡 為什麼觀察三天？ (參數=3)</p>
                            <ul class="list-decimal list-inside space-y-1 text-yellow-800">
                                <li><span class="font-bold">過濾假訊號：</span>避免「一日行情」。</li>
                                <li><span class="font-bold">心理防線：</span>Day 1 變盤，Day 2 延續，Day 3 確立。</li>
                                <li><span class="font-bold">操作精髓：</span>綠翻紅後，若連續三天不破 Day 1 低點，多頭確立。</li>
                            </ul>
                        </div>
                    </div>
                </details>

                <!-- Part 2: 盤態與攻擊 (依據圖片更新 - NEW) -->
                
                <details class="group border border-orange-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-orange-800 bg-orange-50 p-3">
                        <span>5. 心法篇：盤態分類 (圖解對照)</span>
                        <span class="text-orange-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-4">
                        
                        <!-- 圖解: 多方三盤態 (User Uploaded) -->
                        <div>
                            <p class="font-bold bg-red-100 text-red-800 px-1 rounded inline-block mb-1">📈 多方趨勢 (Bullish)</p>
                            <div class="flex flex-col items-center my-2 p-2 border border-slate-200 rounded bg-white">
                                <div class="w-full text-center text-[10px] text-gray-500 mb-1">▼ 圖一：多方盤態與空頭抵抗 (按圖操作) ▼</div>
                                <div class="w-full h-auto rounded shadow-sm bg-gray-100 p-2 text-center text-xs text-gray-500 flex justify-around">
                                    <!-- 模擬圖示結構 (實際為文字描述圖中精髓) -->
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-orange-600 mb-1">① 盤堅盤</div>
                                        <div class="text-[9px]">空頭抵抗強<br>回檔深<br>守軋空低</div>
                                    </div>
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-blue-600 mb-1">② 軋空盤</div>
                                        <div class="text-[9px]">空頭抵抗弱<br>高檔旗型<br>以盤代跌</div>
                                    </div>
                                    <div class="w-1/3 px-1">
                                        <div class="font-bold text-red-600 mb-1">③ 強軋空</div>
                                        <div class="text-[9px]">抵抗失敗<br>不回頭<br>直接噴出</div>
                                    </div>
                                </div>
                                <div class="mt-2 text-left w-full space-y-1">
                                     <p>① <span class="font-bold text-orange-600">盤堅盤 (Accumulation)：</span> 回檔較深，黑K吞噬紅棒，但<span class="bg-orange-100 px-1 rounded font-bold">守住軋空低</span>。策略：耐心等待。</p>
                                     <p>② <span class="font-bold text-blue-600">軋空盤 (Squeeze)：</span> 高檔整理，<span class="bg-blue-100 px-1 rounded font-bold">空頭抵抗</span>出現但守住昨日高點。策略：續抱看一飽。</p>
                                     <p>③ <span class="font-bold text-red-600">強軋空 (Super Squeeze)：</span> <span class="bg-red-100 px-1 rounded font-bold">空頭抵抗失敗</span>(紅框處)，隔日開高走高。策略：死抱看五倍。</p>
                                </div>
                            </div>
                        </div>

                        <!-- 空方盤態說明 (Updated) -->
                        <div class="border-t border-slate-200 pt-2">
                            <p class="font-bold bg-green-100 text-green-800 px-1 rounded inline-block mb-1">📉 空方趨勢 (Bearish)</p>
                            <ul class="space-y-2 ml-1">
                                <li>
                                    <span class="font-bold text-green-700">① 強殺多：</span>跳空向下，連黑K，完全無反彈。<br>
                                    <span class="text-slate-500">→ 策略：絕對不接刀，反彈就是空。</span>
                                </li>
                                <li>
                                    <span class="font-bold text-green-600">② 殺多盤：</span>弱勢整理再破底。<br>
                                    <span class="text-slate-500">→ 策略：利用反彈逃命，空方續抱。</span>
                                </li>
                                <li><span class="font-bold text-slate-600">③ 盤跌盤：</span>跌破後反彈深(假突破回頸線)，隨後再殺。<br>
                                    <span class="text-slate-500">→ 策略：區間操作，嚴設停損。</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </details>
                
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">第三篇：實戰與離場 (SOP)</div>

                <details class="group border border-green-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-green-800 bg-green-50 p-3">
                        <span>6. 攻擊篇：N字測幅 (手稿公式)</span>
                        <span class="text-green-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p>參數：<span class="font-bold text-red-600">h2 (今日最高)</span>，<span class="font-bold text-green-600">L (前三低)</span></p>
                        <div class="bg-green-50 p-2 rounded border border-green-100 font-mono">
                            <p>● <span class="font-bold">一飽 (1N)：</span> h2 × 2 - L (基本滿足)</p>
                            <p>● <span class="font-bold">二吐 (2N)：</span> 一飽 + (h2 - L) (強勢飆股)</p>
                            <p>● <span class="font-bold">五倍 (5x)：</span> h2 + 5 × (h2 - L) (摺疊翻箱)</p>
                        </div>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>7. 進階篇：長紅隔日強弱判定</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold">突破帶量長紅棒，隔日走勢至關重要：</p>
                        <ol class="list-decimal list-inside space-y-1 ml-1">
                            <li><span class="font-bold text-red-600">繼續漲：</span> 強勢 (Strong)。</li>
                            <li><span class="font-bold text-red-500">不破 1/3：</span> 次強 (Normal)。</li>
                            <li><span class="font-bold text-orange-500">不破 1/2：</span> 次次強 (Weak but Hold)。</li>
                            <li><span class="font-bold text-gray-500">跌破 1/2 或低點：</span> 假突破 (False Breakout)。</li>
                        </ol>
                    </div>
                </details>
                
                <details class="group border border-red-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-red-800 bg-red-50 p-3">
                        <span>8. 離場篇：世紀鋼 (9958) 賣訊</span>
                        <span class="text-red-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-700">賣出三部曲 (世紀鋼教訓)：</p>
                        <ol class="list-decimal list-inside ml-1">
                            <li><span class="font-bold">趨勢轉弱：</span>均線 (EMA 8/21/55) 上漲變緩或走平。</li>
                            <li><span class="font-bold">結構跌破：</span>三盤跌破 + 跌破所有均線。</li>
                            <li><span class="font-bold">指標確認：</span>落尾日落 + 寶塔翻綠。</li>
                        </ol>
                        <p class="bg-red-50 p-1 text-center font-bold text-red-900 mt-1">結論：多頭已死，果斷換股！</p>
                    </div>
                </details>
                
                <!-- 輸入指南 -->
                 <details class="group border border-gray-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-gray-800 bg-gray-50 p-3">
                        <span>9. SOP：盤中輸入指南</span>
                        <span class="text-gray-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white">
                        收盤價(跳動價)、今日最高(算目標)、軋空低(翻紅日低)、前三高/低(昨前大前)
                    </div>
                </details>

                <!-- NEW: 預判教學 -->
                <details class="group border border-sky-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-sky-800 bg-sky-50 p-3">
                        <span>10. 預判篇：如何模擬未來走勢？</span>
                        <span class="text-sky-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-600 border-b border-sky-100 pb-1">Q: 怎麼預測明天？(模擬戰情室用法)</p>
                        <ol class="list-decimal list-inside ml-1 space-y-2">
                            <li><span class="font-bold bg-blue-100 text-blue-800 px-1 rounded">情境按鈕 (新手)：</span>
                                <div class="pl-4 text-slate-500 mt-1">
                                    上方藍色區塊的按鈕 (如：模擬極強)，是<span class="bg-yellow-100 text-slate-800 px-1">系統自動填入假數據</span>，按下去後請直接看最下方的「分析結果」，讓你練習「看到這種數據該怎麼做」。
                                </div>
                            </li>
                            <li><span class="font-bold bg-slate-800 text-white px-1 rounded">手動預演 (老手)：</span>
                                <ul class="list-none list-inside pl-4 text-slate-600 mt-1 space-y-1">
                                    <li>① 填入真實的 <span class="font-bold">前三高、前三低、均量</span> (這是已知歷史)。</li>
                                    <li>② 更改 <span class="text-blue-700 font-bold">目前價</span> (輸入：你假設明天會漲到的價格)。</li>
                                    <li>③ 更改 <span class="text-purple-700 font-bold">成交量</span> (輸入：你預估明天的量)。</li>
                                    <li>④ 按下黑色 <span class="font-bold bg-black text-white px-1 text-[10px] rounded">執行實戰推演</span> 按鈕。</li>
                                </ul>
                                <p class="text-center text-red-600 font-bold mt-1 bg-red-50 p-1">💡 結論：利用假想的明後天價格，先算出下一步策略！</p>
                            </li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>

        <div class="p-6 space-y-5 relative z-0">
            
            <!-- 模擬戰情室 (New) -->
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <h3 class="text-xs font-black text-blue-900 mb-2 flex items-center">
                    🎮 模擬戰情室 (快速演習)
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="simulate('strong')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        🚀 模擬極強
                    </button>
                    <button onclick="simulate('break')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        🔥 模擬突破
                    </button>
                    <button onclick="simulate('crash')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        💀 模擬大跌
                    </button>
                    <button onclick="simulate('flat')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        ➖ 模擬盤整
                    </button>
                </div>
            </div>
            
            <!-- 0. 股票代碼 -->
            <div>
                <label class="block text-slate-700 font-bold mb-1 text-sm">股票名稱/代號</label>
                <input type="text" id="stockName" class="w-full p-2 border-2 border-slate-200 rounded focus:ring-2 focus:ring-slate-500 font-bold placeholder-slate-300 transition-colors" placeholder="例如：世紀鋼 (9958)">
            </div>

            <!-- 1. 狀態選擇 -->
            <div>
                <label class="block text-slate-700 font-bold mb-2 text-sm">1. 目前寶塔線顏色 (狀態)</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setStatus('GREEN')" id="btn-green" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100">
                        🟩 綠色 (空手/盤整)
                    </button>
                    <button onclick="setStatus('RED')" id="btn-red" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60">
                        🟥 紅色 (持有/多方)
                    </button>
                </div>
                <input type="hidden" id="currentStatus" value="GREEN">
            </div>

            <!-- 2. 核心價格 -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-blue-600 pl-2">核心價格 (Price Action)</h3>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-blue-900 font-bold mb-1 text-xs">目前價 (Current)</label>
                            <input type="number" step="0.01" id="closePrice" class="w-full p-2 border-2 border-blue-200 rounded focus:ring-blue-500 text-lg font-mono font-bold text-blue-900" placeholder="跳動價">
                        </div>
                        <div>
                            <label class="block text-red-700 font-bold mb-1 text-xs">今日最高 <span class="bg-red-100 px-1 rounded">h2</span></label>
                            <input type="number" step="0.01" id="todayHigh" class="w-full p-2 border-2 border-red-200 rounded focus:ring-red-500 text-lg font-mono font-bold text-red-700" placeholder="動態測幅用">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">前三高 (頸線)</label>
                        <input type="number" step="0.01" id="high3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="昨/前/大前">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">前三低 (L)</label>
                        <input type="number" step="0.01" id="low3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="昨/前/大前">
                    </div>
                    
                    <!-- 軋空低欄位 -->
                    <div class="col-span-2 bg-red-50 p-3 rounded-lg border-2 border-red-300 mt-2 relative overflow-hidden shadow-sm ring-2 ring-red-100">
                         <div class="absolute right-0 top-0 text-[60px] opacity-10 pointer-events-none transform rotate-12">🛡️</div>
                         <div class="flex justify-between items-center mb-1">
                             <label class="block text-purple-900 font-black mb-1 text-sm">★ 軋空低 (翻紅K棒最低點)</label>
                             <button onclick="toggleEncyclopedia()" class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded hover:bg-red-700 cursor-pointer shadow">❓ 填哪一天？</button>
                         </div>
                        <input type="number" step="0.01" id="breakoutLow" class="w-full p-2 border-2 border-purple-300 rounded font-mono text-lg text-purple-900 font-bold bg-white focus:ring-2 focus:ring-purple-500" placeholder="目標價生存線">
                        
                        <div class="mt-2 space-y-1 text-[11px] font-bold text-slate-600 bg-white/60 p-2 rounded border border-red-100">
                            <p>👉 <span class="text-red-700">若今日剛突破：</span>填「今天盤中」最低點。</p>
                            <p>👉 <span class="text-green-700">若已持有續抱：</span>填「當初買進那天」最低點。</p>
                            <p class="text-red-500 mt-1 border-t border-red-100 pt-1 flex items-center"><span class="text-lg mr-1">⚡</span> 跌破此價 = 攻擊失敗 (目標抵銷)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. 成交量 -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-purple-600 pl-2">成交量結構 (Volume)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-purple-900 font-bold mb-1 text-xs">今日成交量 (Today Vol)</label>
                        <input type="number" id="todayVol" class="w-full p-2 border-2 border-purple-200 rounded focus:ring-purple-500 font-mono text-lg font-bold text-purple-900" placeholder="預估量">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">過去三日均量 (Avg Vol)</label>
                        <input type="number" id="avgVol" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="輸入5T數值">
                    </div>
                </div>
            </div>

            <!-- 4. 強勢股判定參數 (含長紅強弱判定) -->
            <div id="advancedInputs" class="hidden bg-indigo-50 p-3 rounded-lg mt-4 border border-indigo-100">
                <h3 class="text-sm font-black text-indigo-900 mb-2">★ 盤態強弱判定參數 (選填)</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日收盤</label>
                        <input type="number" id="prevClose" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="昨收">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">今日最低</label>
                        <input type="number" id="todayLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="今低">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日最低</label>
                        <input type="number" id="prevLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="昨低">
                    </div>
                    <div class="col-span-3 mt-1 pt-2 border-t border-indigo-200">
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日長紅低點 (用於隔日強弱判定)</label>
                        <input type="number" id="prevLongRedLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="若昨日收黑則免填">
                    </div>
                </div>
            </div>

            <!-- 賣出檢核 -->
            <div id="sellChecklist" class="hidden bg-red-50 p-3 rounded border-2 border-red-200 mt-3">
                <h4 class="font-bold text-red-800 text-xs mb-2 flex items-center">📉 換股操作檢核</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkTrend" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">均線上漲趨勢緩</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkMA" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">三盤跌破所有均線</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkSunset" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">落尾日落 & 寶塔翻綠</span>
                    </label>
                </div>
                <div id="sellAdvice" class="hidden mt-2 p-3 bg-red-600 text-white text-sm font-black rounded text-center animate-pulse shadow-lg transform scale-105">
                    🚨 條件成立：收回資金，換股操作！
                </div>
            </div>

            <!-- 操作按鈕區 -->
            <div class="grid grid-cols-5 gap-2 mt-4">
                <button onclick="calculateStrategy()" class="col-span-3 bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-lg tracking-widest border border-slate-700">
                    執行實戰推演
                </button>
                <button onclick="clearInputs()" class="col-span-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl shadow-md transition-all active:scale-95 text-base border border-gray-300 flex items-center justify-center">
                    🔄 清除重置
                </button>
            </div>

            <!-- 結果顯示區 -->
            <div id="resultArea" class="hidden fade-in mt-4 pb-10">
                <div id="resultBox" class="p-5 rounded-xl border-l-8 shadow-md bg-white relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span id="stockBadge" class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded font-bold mb-1 inline-block"></span>
                                <h2 id="resultTitle" class="text-xl font-black leading-tight"></h2>
                            </div>
                            <span id="resultIcon" class="text-3xl"></span>
                        </div>

                        <div class="mb-3 flex flex-wrap gap-2">
                            <span id="trendTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="volTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="patternTag" class="hidden text-xs font-bold px-2 py-1 rounded border"></span>
                        </div>
                        
                        <p id="resultAction" class="text-2xl font-black mb-3 border-b pb-2"></p>
                        
                        <!-- N字測幅目標區 -->
                        <div id="targetBox" class="hidden bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm transition-all">
                            <h5 id="targetHeader" class="font-bold text-green-800 border-b border-green-200 pb-1 mb-2 flex justify-between">
                                <span>🎯 動態測幅目標 (h2=<span id="valH2"></span>, L=<span id="valL"></span>)</span>
                                <span id="targetStatusBadge" class="text-[10px] bg-green-200 px-1 rounded text-green-800">Active</span>
                            </h5>
                            <div id="targetList" class="space-y-1 font-mono text-slate-700">
                                <div class="flex justify-between">
                                    <span>一飽 (1N)：</span>
                                    <span class="font-bold text-green-700" id="target1"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>二吐 (2N)：</span>
                                    <span class="font-bold text-green-700" id="target2"></span>
                                </div>
                                <div class="flex justify-between bg-green-100 -mx-1 px-1 rounded">
                                    <span class="font-bold text-purple-700">五倍 (5N)：</span>
                                    <span class="font-bold text-purple-700" id="target5"></span>
                                </div>
                            </div>
                            <div id="targetInvalidMsg" class="hidden mt-2 text-center bg-gray-200 text-gray-500 font-bold py-1 rounded text-xs border border-gray-300">
                                ❌ 跌破軋空低，目標已抵銷
                            </div>
                        </div>

                        <div id="inferenceBox" class="hidden bg-slate-50 p-2 rounded border border-slate-200 mb-3 text-xs font-mono text-slate-600"></div>

                        <div class="bg-white/60 p-3 rounded border border-slate-200 mb-4 backdrop-blur-sm shadow-sm">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">★ 戰術指引 (Tactical Advice)</p>
                            <p id="resultAdvice" class="text-sm text-slate-800 font-medium leading-relaxed"></p>
                        </div>
                        
                        <button onclick="copyReport()" id="copyBtn" class="w-full flex items-center justify-center space-x-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg transition-colors text-sm border border-slate-300 shadow-sm">
                            <span>📋 複製完整戰報</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let currentReportText = "";

        // 模擬數據函數
        function simulate(type) {
            clearInputs(false); // 不隱藏結果區
            
            // 基礎設定 (假設一檔股票)
            document.getElementById('stockName').value = "模擬個股 (TEST)";
            document.getElementById('high3d').value = 100;
            document.getElementById('low3d').value = 90;
            document.getElementById('avgVol').value = 1000;
            
            let simType = "";

            if (type === 'strong') { // 極強
                setStatus('RED');
                document.getElementById('closePrice').value = 108;
                document.getElementById('todayHigh').value = 108; // 收最高
                document.getElementById('breakoutLow').value = 98; // 遠高於軋空低
                document.getElementById('todayVol').value = 2000; // 爆量
                
                // 強勢股參數
                document.getElementById('prevClose').value = 104;
                document.getElementById('todayLow').value = 105;
                document.getElementById('prevLow').value = 102;
                simType = "🚀 極強";
                
            } else if (type === 'break') { // 突破
                setStatus('GREEN');
                document.getElementById('closePrice').value = 102;
                document.getElementById('todayHigh').value = 103;
                document.getElementById('breakoutLow').value = 101; // 今日低當防守
                document.getElementById('todayVol').value = 1500; // 攻擊量
                simType = "🔥 突破";
                
            } else if (type === 'crash') { // 大跌
                setStatus('RED'); // 原本持有
                document.getElementById('closePrice').value = 85; // 破低
                document.getElementById('todayHigh').value = 92;
                document.getElementById('breakoutLow').value = 95; // 跌破防守點
                document.getElementById('todayVol').value = 3000; // 恐慌量
                simType = "💀 大跌";
                
            } else if (type === 'flat') { // 盤整
                setStatus('GREEN');
                document.getElementById('closePrice').value = 98; // 未過高
                document.getElementById('todayHigh').value = 99;
                document.getElementById('breakoutLow').value = 95;
                document.getElementById('todayVol').value = 600; // 量縮
                simType = "➖ 盤整";
            }

            // 增加輸入框閃爍特效
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.classList.remove('highlight-input');
                void input.offsetWidth; // trigger reflow
                input.classList.add('highlight-input');
            });
            
            // 自動執行並捲動
            setTimeout(() => {
                calculateStrategy();
                // 強制捲動
                const resultArea = document.getElementById('resultArea');
                resultArea.classList.remove('hidden');
                resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        const checkboxes = document.querySelectorAll('#sellChecklist input[type="checkbox"]');
        const adviceBox = document.getElementById('sellAdvice');
        
        checkboxes.forEach(chk => {
            chk.addEventListener('change', () => {
                const allChecked = Array.from(checkboxes).every(c => c.checked);
                if (allChecked) {
                    adviceBox.classList.remove('hidden');
                } else {
                    adviceBox.classList.add('hidden');
                }
            });
        });

        function toggleEncyclopedia() {
            const content = document.getElementById('encyclopediaContent');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        }

        function clearInputs(hideResult = true) {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                input.value = '';
                input.classList.remove('highlight-input');
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(box => box.checked = false);
            adviceBox.classList.add('hidden');
            if(hideResult) {
                document.getElementById('resultArea').classList.add('hidden');
            }
            setStatus('GREEN');
            if(hideResult) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function formatPrice(num) {
            return parseFloat(num).toFixed(2);
        }

        function setStatus(status) {
            document.getElementById('currentStatus').value = status;
            document.getElementById('btn-green').className = "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            document.getElementById('btn-red').className = "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";

            if(status === 'GREEN') {
                document.getElementById('btn-green').className = "py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100";
                document.getElementById('advancedInputs').classList.add('hidden');
                document.getElementById('sellChecklist').classList.add('hidden');
            } else {
                document.getElementById('btn-red').className = "py-3 px-4 border-2 rounded-lg font-bold transition-all border-red-500 bg-red-50 text-red-700 shadow-inner ring-2 ring-red-100 opacity-100";
                document.getElementById('advancedInputs').classList.remove('hidden');
                document.getElementById('sellChecklist').classList.remove('hidden');
            }
        }

        function calculateStrategy() {
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-error'));

            const stockName = document.getElementById('stockName').value || "未輸入股名";
            const status = document.getElementById('currentStatus').value;
            const close = parseFloat(document.getElementById('closePrice').value);
            const todayH = parseFloat(document.getElementById('todayHigh').value); 
            const high3d = parseFloat(document.getElementById('high3d').value); 
            const L = parseFloat(document.getElementById('low3d').value);   
            const breakoutLow = parseFloat(document.getElementById('breakoutLow').value); 
            const todayVol = parseFloat(document.getElementById('todayVol').value);
            const avgVol = parseFloat(document.getElementById('avgVol').value);
            const isFullSell = Array.from(checkboxes).every(c => c.checked);
            
            const prevClose = parseFloat(document.getElementById('prevClose').value);
            const todayLow = parseFloat(document.getElementById('todayLow').value);
            const prevLow = parseFloat(document.getElementById('prevLow').value);
            const prevLongRedLow = parseFloat(document.getElementById('prevLongRedLow').value);

            let hasError = false;
            let errorMsg = "請檢查紅框欄位：\n";

            if (!status) { errorMsg += "- 請選擇目前狀態\n"; hasError = true; }
            if (isNaN(close)) { document.getElementById('closePrice').classList.add('input-error'); errorMsg += "- 請輸入目前價\n"; hasError = true; }
            if (isNaN(high3d)) { document.getElementById('high3d').classList.add('input-error'); errorMsg += "- 請輸入前三高\n"; hasError = true; }
            if (isNaN(L)) { document.getElementById('low3d').classList.add('input-error'); errorMsg += "- 請輸入前三低\n"; hasError = true; }

            if (hasError) { alert(errorMsg); return; }

            // === 邏輯運算 ===
            let h2 = isNaN(todayH) ? close : todayH; 
            if(h2 < close) h2 = close;

            const gap = h2 - L;
            let target1 = 0, target2 = 0, target5 = 0;
            let targetReport = "";
            let isTargetValid = true;
            
            if (!isNaN(breakoutLow) && close < breakoutLow) {
                isTargetValid = false; 
            }

            // 測幅計算
            if (gap > 0) {
                target1 = h2 + gap;
                target2 = h2 + (2 * gap);
                target5 = h2 + (5 * gap);

                document.getElementById('valH2').innerText = h2;
                document.getElementById('valL').innerText = L;
                document.getElementById('target1').innerText = formatPrice(target1);
                document.getElementById('target2').innerText = formatPrice(target2);
                document.getElementById('target5').innerText = formatPrice(target5);
                
                const targetBox = document.getElementById('targetBox');
                const targetList = document.getElementById('targetList');
                const invalidMsg = document.getElementById('targetInvalidMsg');
                const statusBadge = document.getElementById('targetStatusBadge');
                
                targetBox.classList.remove('hidden');

                if (isTargetValid) {
                    targetBox.className = "bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm";
                    targetList.classList.remove('invalid-target');
                    invalidMsg.classList.add('hidden');
                    statusBadge.innerText = "Active";
                    statusBadge.className = "text-[10px] bg-green-200 px-1 rounded text-green-800";
                    targetReport = `\n🎯 動態測幅 (h2=${h2})\n• 一飽(1N)：${formatPrice(target1)}\n• 二吐(2N)：${formatPrice(target2)}\n• 五倍(5N)：${formatPrice(target5)}`;
                } else {
                    targetBox.className = "bg-gray-100 p-3 rounded border border-gray-300 mb-3 text-xs shadow-sm opacity-75";
                    targetList.classList.add('invalid-target');
                    invalidMsg.classList.remove('hidden');
                    statusBadge.innerText = "Invalid";
                    statusBadge.className = "text-[10px] bg-gray-300 px-1 rounded text-gray-700";
                    targetReport = `\n🎯 動態測幅 (h2=${h2})\n❌ 破軋空低，目標抵銷失效`;
                }
            } else {
                document.getElementById('targetBox').classList.add('hidden');
            }

            // 盤態與長紅強弱判定
            let isStrong = false;
            let patternType = ""; 
            let patternReport = "";
            let patternClass = "";
            let redCandleAdvice = "";
            let tacticalAdvice = "";

            if (status === 'RED') {
                if (!isNaN(prevClose) && !isNaN(todayLow) && !isNaN(prevLow)) {
                    if (close > prevClose && todayLow > prevLow) {
                        isStrong = true;
                        patternType = "🔥 強軋空盤";
                        patternClass = "bg-red-100 text-red-700 border-red-300";
                        tacticalAdvice = "🔥 趨勢：多方強勢 (強軋空)。\n依圖一所示，空頭抵抗失敗，K線連紅，建議死抱不放，目標看五倍。";
                    } else if (close >= high3d) {
                        patternType = "📈 軋空盤";
                        patternClass = "bg-blue-100 text-blue-700 border-blue-300";
                        tacticalAdvice = "📈 趨勢：多方攻擊 (軋空盤)。\n依圖一所示，空頭抵抗微弱，以盤代跌，建議續抱，看一飽二吐。";
                    } else {
                        patternType = "🐢 盤堅盤";
                        patternClass = "bg-orange-100 text-orange-800 border-orange-300";
                        tacticalAdvice = "🐢 趨勢：多方整理 (盤堅盤)。\n依圖一所示，空頭抵抗強烈，回檔較深，但只要不破軋空低，建議耐心等待。";
                    }
                } else {
                    // 若無參數，簡易判斷
                    if (close > high3d) {
                        patternType = "📈 軋空盤"; 
                        patternClass = "bg-blue-100 text-blue-700 border-blue-300";
                        tacticalAdvice = "📈 趨勢：多方強勢 (軋空盤)。\n建議：守住昨日高點，續抱。";
                    } else {
                        patternType = "🐢 盤堅盤";
                        patternClass = "bg-orange-100 text-orange-800 border-orange-300";
                        tacticalAdvice = "🐢 趨勢：多方整理 (盤堅盤)。\n建議：回檔整理，嚴守軋空低。";
                    }
                }

                // 長紅隔日強弱覆蓋
                if (!isNaN(prevClose) && !isNaN(prevLongRedLow)) { 
                    let redLen = prevClose - prevLongRedLow;
                    let p1_3 = prevClose - (redLen * 0.33); 
                    let p1_2 = prevClose - (redLen * 0.5);  
                    
                    if (close > prevClose) {
                        redCandleAdvice = "⚡ 長紅力道：強勢 (續漲)";
                    } else if (close >= p1_3) {
                        redCandleAdvice = "💪 長紅力道：次強 (守1/3)";
                    } else if (close >= p1_2) {
                        redCandleAdvice = "🛡️ 長紅力道：次次強 (守1/2)";
                    } else if (close < p1_2 || close < prevLongRedLow) {
                        redCandleAdvice = "⚠️ 長紅力道：轉弱 (破1/2)";
                        patternType = "⚠️ 疑似假突破"; 
                        patternClass = "bg-yellow-100 text-yellow-800 border-yellow-300";
                        tacticalAdvice = "⚠️ 趨勢：轉弱疑慮 (假突破)。\n建議：跌破長紅1/2，攻擊失敗風險增高，建議減碼觀察。";
                    }
                }
                
                const pTag = document.getElementById('patternTag');
                pTag.innerText = patternType;
                pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                pTag.classList.remove('hidden');
                patternReport = `\n型態：${patternType}`;
            } else { // GREEN (空方)
                if(close < L) { 
                     // 圖二: 空方盤態邏輯 (這裡用簡單判斷模擬，可再細分)
                     patternType = "📉 空方殺多";
                     patternClass = "bg-green-100 text-green-800 border-green-300";
                     tacticalAdvice = "📉 趨勢：空方殺多。\n依圖二所示，空方趨勢確立 (強殺多/殺多盤)，反彈不過殺多高就是空。若持有，請立刻停損，絕不接刀。";
                     
                     const pTag = document.getElementById('patternTag');
                     pTag.innerText = patternType;
                     pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                     pTag.classList.remove('hidden');
                     patternReport = `\n型態：${patternType}`;
                } else {
                     patternType = "💤 盤跌/觀望";
                     patternClass = "bg-gray-100 text-gray-600 border-gray-300";
                     tacticalAdvice = "💤 趨勢：盤勢不明 (盤跌)。\n依圖二所示，反彈深(假突破)，隨後再殺。建議多看少做，保留現金，等待突破訊號。";
                     
                     const pTag = document.getElementById('patternTag');
                     pTag.innerText = patternType;
                     pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                     pTag.classList.remove('hidden');
                     patternReport = `\n型態：${patternType}`;
                }
            }

            // 量價推演
            let volStatus = "一般";
            let volRatio = 0;
            let inferenceReportText = "";
            let inferenceText = "";

            if (!isNaN(avgVol) && avgVol > 0) {
                let targetAttack = Math.round(avgVol * 1.3);
                let targetWash = Math.round(avgVol * 0.8);
                const attackMark = (todayVol >= targetAttack) ? "🔥達標" : "";
                const washMark = (todayVol <= targetWash) ? "✅達標" : "";
                
                inferenceText = `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="text-[10px] text-slate-400 block">攻擊標準 (1.3x)</span>
                            <span class="font-bold text-red-600">${formatNumber(targetAttack)}</span>
                            <span class="text-[10px] text-red-500">${attackMark}</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400 block">洗盤標準 (0.8x)</span>
                            <span class="font-bold text-blue-600">${formatNumber(targetWash)}</span>
                            <span class="text-[10px] text-blue-500">${washMark}</span>
                        </div>
                    </div>`;
                inferenceReportText = `\n★ 量價推演：\n• 攻擊門檻(1.3x)：${formatNumber(targetAttack)} ${(todayVol >= targetAttack) ? "(🔥達標)" : ""}\n• 洗盤門檻(0.8x)：${formatNumber(targetWash)} ${(todayVol <= targetWash) ? "(✅達標)" : ""}`;

                if (!isNaN(todayVol)) {
                    volRatio = todayVol / avgVol;
                    if (volRatio >= 1.3) volStatus = "攻擊量 (紅財神)";
                    else if (volRatio <= 0.8) volStatus = "量縮整理";
                    else volStatus = "量能溫和";
                }
            }

            // 顯示結果
            const resultArea = document.getElementById('resultArea');
            resultArea.classList.remove('hidden');
            // resultArea.scrollIntoView({ behavior: 'smooth' }); // 改由 simulate 控制或手動觸發時控制

            const resultBox = document.getElementById('resultBox');
            const rTitle = document.getElementById('resultTitle');
            const rAction = document.getElementById('resultAction');
            const rIcon = document.getElementById('resultIcon');
            const rTrend = document.getElementById('trendTag');
            const rVol = document.getElementById('volTag');
            const rAdvice = document.getElementById('resultAdvice');
            const rStock = document.getElementById('stockBadge');
            const rInference = document.getElementById('inferenceBox');

            let reportTrend = "";
            let reportAdvice = "";
            let titleText = "";
            let actionText = "";
            let boxClass = "";
            let titleClass = "";
            let actionClass = "";
            let volClass = (volRatio >= 1.3) ? "bg-purple-100 text-purple-700 border-purple-300" : (volRatio <= 0.8 ? "bg-blue-100 text-blue-700 border-blue-300" : "bg-slate-100 text-slate-600 border-slate-200");

            if (status === 'GREEN') {
                if (close > high3d) {
                    titleText = "🔥 三盤突破 (翻紅)";
                    reportTrend = "3. N字起漲 (Day 1)";
                    actionText = "市價買進";
                    reportAdvice = "紅財神確認。守住今日低點(軋空低)。";
                    tacticalAdvice = "🚀 趨勢：多方起漲 (Day 1)。\n【圖解】：突破 N 字頸線，攻擊發起。\n【建議】：空手者建議市價買進，防守今日低點。";
                    boxClass = "bg-red-50 border-red-500";
                    titleClass = "text-xl font-bold text-red-600";
                    actionClass = "text-2xl font-black text-red-700 border-b border-red-200 pb-2 mb-2";
                    rTrend.className = "text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-700 border border-red-200";
                    rIcon.innerText = "🚀";
                } else {
                    titleText = "💤 盤整延續";
                    actionText = "觀望 (WAIT)";
                    reportAdvice = "價格未過頸線。";
                    tacticalAdvice = "💤 趨勢：盤整中。\n【建議】：空手者請觀望，保留現金等待突破訊號。";
                    boxClass = "bg-green-50 border-green-500";
                    titleClass = "text-xl font-bold text-green-700";
                    actionClass = "text-2xl font-black text-green-800 border-b border-green-200 pb-2 mb-2";
                    rTrend.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700 border border-green-200";
                    rIcon.innerText = "🐢";
                }
            } else { // RED
                if (isFullSell) {
                    titleText = "🚨 逃命訊號";
                    actionText = "收回資金，換股";
                    reportAdvice = "世紀鋼模式：多頭力竭，離場。";
                    tacticalAdvice = "🚨 趨勢：多頭力竭 (趨勢反轉)。\n【建議】：無條件離場，換股操作。不要留戀。";
                    boxClass = "bg-red-200 border-red-700";
                    titleClass = "text-xl font-black text-red-900";
                    actionClass = "text-2xl font-black text-red-900 border-b border-red-400 pb-2 mb-2";
                    rIcon.innerText = "📉";
                } else if (close < L) {
                    titleText = "⚠️ 三盤跌破";
                    actionText = "無條件離場";
                    reportAdvice = "結構破壞。";
                    tacticalAdvice = "🏃 趨勢：三盤跌破 (轉空)。\n【圖解】：空方控盤，反彈皆是空點。\n【建議】：持有者反彈逃命，空手者嚴禁進場。";
                    boxClass = "bg-green-100 border-green-600";
                    titleClass = "text-xl font-bold text-green-900";
                    actionClass = "text-2xl font-black text-green-900 underline border-b border-green-300 pb-2 mb-2";
                    rIcon.innerText = "🏃";
                } else {
                    if (!isTargetValid) {
                        titleText = "⚠️ 攻擊失效";
                        actionText = "減碼觀望";
                        reportAdvice = "跌破軋空低，攻擊失敗。";
                        tacticalAdvice = "⚠️ 趨勢：假突破 (破軋空低)。\n【建議】：目標抵銷，建議減碼或移動停損。";
                        boxClass = "bg-yellow-50 border-yellow-500";
                        titleClass = "text-xl font-bold text-yellow-700";
                        actionClass = "text-2xl font-black text-yellow-800 border-b border-yellow-300 pb-2 mb-2";
                        rIcon.innerText = "⚠️";
                    } else {
                        // 使用上面算好的 tacticalAdvice
                        if(isStrong) {
                            titleText = "🐂 強軋空盤";
                            actionText = "死抱不放";
                            boxClass = "bg-red-100 border-red-600";
                            titleClass = "text-xl font-bold text-red-700";
                            actionClass = "text-2xl font-black text-red-800 border-b border-red-300 pb-2 mb-2";
                            rIcon.innerText = "💎";
                        } else {
                            titleText = "✅ 多頭續抱";
                            actionText = "續抱 (HOLD)";
                            boxClass = "bg-orange-50 border-orange-400";
                            titleClass = "text-xl font-bold text-orange-600";
                            actionClass = "text-2xl font-black text-orange-700 border-b border-orange-200 pb-2 mb-2";
                            rIcon.innerText = "✊";
                        }
                        
                        if(redCandleAdvice) {
                            reportAdvice = redCandleAdvice;
                        } else {
                            reportAdvice = "守住軋空低，目標有效。";
                        }
                    }
                }
            }

            // 更新 UI
            resultBox.className = `p-5 rounded-xl border-l-8 shadow-md relative overflow-hidden ${boxClass}`;
            rStock.innerText = stockName;
            rTitle.innerText = titleText;
            rTitle.className = titleClass;
            rAction.innerText = actionText;
            rAction.className = actionClass;
            rAdvice.innerText = tacticalAdvice; // 使用具體的戰術指引
            rTrend.innerText = reportTrend;
            rVol.innerText = volStatus;
            rVol.className = `text-xs font-bold px-2 py-1 rounded border ${volClass}`;
            
            if(inferenceText) {
                rInference.innerHTML = inferenceText;
                rInference.classList.remove('hidden');
            } else {
                rInference.classList.add('hidden');
            }

            // 準備複製文字
            const today = new Date().toLocaleDateString();
            currentReportText = `「嗨，我是石頭，我的N字戰法分析系統希望能讓你勝率💯」\n\n戰報分析結果：\nN字戰法指揮中心 by.石頭 V10.9 (${today})\n股名：${stockName}\n-------------------\n指令：${actionText}\n量能：${volStatus}\n現價：${close}${patternReport}${targetReport}${inferenceReportText}\n本檔「${stockName}」${volRatio >= 1.3 ? "攻擊量能達標 (符合1.3倍)" : (volRatio <= 0.8 ? "量縮洗盤達標 (符合0.8倍)" : "量能溫和")}\n\n★ 戰術指引：\n${tacticalAdvice}\n${redCandleAdvice ? `(${redCandleAdvice})` : ""}\n-------------------\n防守：不破軋空低，目標才有效。`;
            
            document.getElementById('copyBtn').innerHTML = '<span>📋 複製完整戰報</span>';
        }

        function copyReport() {
            if (!currentReportText) return;
            const textarea = document.createElement('textarea');
            textarea.value = currentReportText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = '<span class="text-green-600">✅ 已複製到剪貼簿！</span>';
            setTimeout(() => btn.innerHTML = '<span>📋 複製完整戰報</span>', 2000);
        }
    </script>
</body>
</html>