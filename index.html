<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N字戰法：三盤轉折判斷計算機 (V12.7 終極修復版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 卷軸美化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .invalid-target { text-decoration: line-through; color: #9ca3af; }
        .input-error { border-color: #ef4444 !important; ring: 2px; ring-color: #ef4444; background-color: #fef2f2; }
        
        /* 閃爍提醒特效 */
        @keyframes highlightPulse {
            0% { background-color: #fff; }
            50% { background-color: #fef9c3; } /* yellow-100 */
            100% { background-color: #fff; }
        }
        .highlight-input { animation: highlightPulse 1s ease-in-out; }

        /* 摺疊選單樣式 */
        details > summary { list-style: none; cursor: pointer; transition: all 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { margin-bottom: 0.5rem; }
        details > summary:hover { background-color: #f8fafc; }

        /* AI Loading Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #6366f1; }
            50%, 100% { background-color: #e0e7ff; }
        }
        
        /* Markdown Styles for AI Response */
        .ai-content h1, .ai-content h2, .ai-content h3 { font-weight: 800; margin-top: 0.5em; margin-bottom: 0.3em; color: #1e1b4b; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .ai-content p { margin-bottom: 0.5em; line-height: 1.6; }
        .ai-content strong { color: #b91c1c; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden border border-slate-300 relative">
        <!-- Header -->
        <div class="bg-slate-900 p-5 text-white text-center relative z-20">
            <h1 class="text-2xl font-black tracking-wider">N字戰法指揮中心 by.石頭 <span class="text-yellow-400 text-sm align-top">V12.7</span></h1>
            <p class="text-xs text-slate-400 mt-1">量能劇本 x 盤態判讀 x AI 戰略</p>
        </div>

        <!-- 戰法百科全書 (Accordion Menu) -->
        <div class="bg-slate-50 border-b border-slate-200">
            <div class="p-3 text-center bg-blue-700 text-white font-bold text-sm cursor-pointer hover:bg-blue-800 transition-colors" onclick="toggleEncyclopedia()">
                📖 點我打開：N字戰法全能百科 (圖解精華) ▼
            </div>
            
            <div id="encyclopediaContent" class="hidden max-h-[500px] overflow-y-auto p-4 space-y-3 shadow-inner bg-white">
                
                <!-- Part 1: 基礎趨勢 -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-2 mb-1">第一篇：基礎趨勢與轉折 (定多空)</div>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>1. 趨勢篇：末升低 & 末跌高</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">● 末升低 (Last Rising Low)：</span>多頭創高波段的「起漲點」。<br>邏輯：守住末升低=多頭，跌破=趨勢破壞。</p>
                        <p><span class="font-bold text-green-600">● 末跌高 (Last Falling High)：</span>空頭創低波段的「起跌點」。<br>邏輯：突破末跌高=空翻多。</p>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>2. 轉折訊號：日出線 & 日落線</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">🌅 日出線 (Sunrise)：</span>高過昨高，收盤收高。<br>用途：回檔時的止跌買訊。</p>
                        <p><span class="font-bold text-green-600">🌇 日落線 (Sunset)：</span>低破昨低，收盤收低。<br>用途：上漲時的止漲賣訊。</p>
                        <p class="bg-indigo-50 p-1 rounded font-bold text-center">口訣：回檔找日出，上漲防日落。</p>
                    </div>
                </details>

                <details class="group border border-purple-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-purple-800 bg-purple-50 p-3">
                        <span>3. 防守篇：軋空低 & 翻紅定義</span>
                        <span class="text-purple-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                        <p><span class="font-bold bg-indigo-100 text-indigo-800 px-1 rounded">翻紅K棒：</span> 寶塔線由綠翻紅 (收盤 > 前三高) 當天的那根K棒。</p>
                        <p><span class="font-bold bg-purple-100 text-purple-800 px-1 rounded">軋空低：</span> 翻紅K棒的<span class="text-red-600 font-bold">最低點</span>。</p>
                        
                        <!-- 成本迷思解惑 -->
                        <div class="bg-red-50 p-2 rounded border border-red-200">
                            <p class="font-bold text-red-800 border-b border-red-200 pb-1 mb-1">💡 軋空低填哪一天？</p>
                            <p class="mb-1 text-slate-800 font-bold">N字戰法操作「當下」，不問成本！</p>
                            <div class="grid grid-cols-1 gap-2 mt-2">
                                <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                    <p class="font-bold text-yellow-800">📌 情境 A (空手想買)</p>
                                    <p>輸入：填 <span class="font-bold text-red-600">「今天」</span> 的盤中最低點。</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-200">
                                    <p class="font-bold text-green-800">📌 情境 B (持有續抱)</p>
                                    <p>輸入：填 <span class="font-bold text-red-600">「當初買進那天」</span> 的最低點。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                 <!-- NEW: 寶塔線邏輯 -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">第二篇：寶塔線與盤態圖解 (重點)</div>

                <details class="group border border-blue-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-blue-800 bg-blue-50 p-3">
                        <span>4. 原理篇：寶塔線 (TOW) 邏輯詳解</span>
                        <span class="text-blue-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                         <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                            <p class="font-bold text-yellow-900 border-b border-yellow-200 pb-1 mb-1">💡 為什麼觀察三天？ (參數=3)</p>
                            <ul class="list-decimal list-inside space-y-1 text-yellow-800">
                                <li><span class="font-bold">過濾假訊號：</span>避免「一日行情」。</li>
                                <li><span class="font-bold">心理防線：</span>Day 1 變盤，Day 2 延續，Day 3 確立。</li>
                                <li><span class="font-bold">操作精髓：</span>綠翻紅後，若連續三天不破 Day 1 低點，多頭確立。</li>
                            </ul>
                        </div>
                    </div>
                </details>

                <!-- Part 2: 盤態與攻擊 (依據圖片更新 - NEW) -->
                
                <details class="group border border-orange-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-orange-800 bg-orange-50 p-3">
                        <span>5. 心法篇：盤態分類 (圖解對照)</span>
                        <span class="text-orange-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-4">
                        
                        <!-- 圖解: 多方三盤態 (User Uploaded) -->
                        <div>
                            <p class="font-bold bg-red-100 text-red-800 px-1 rounded inline-block mb-1">📈 多方趨勢 (Bullish)</p>
                            <div class="flex flex-col items-center my-2 p-2 border border-slate-200 rounded bg-white">
                                <div class="w-full text-center text-[10px] text-gray-500 mb-1">▼ 圖一：多方盤態與空頭抵抗 (按圖操作) ▼</div>
                                <div class="w-full h-auto rounded shadow-sm bg-gray-100 p-2 text-center text-xs text-gray-500 flex justify-around">
                                    <!-- 模擬圖示結構 (實際為文字描述圖中精髓) -->
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-orange-600 mb-1">① 盤堅盤</div>
                                        <div class="text-[9px]">空頭抵抗強<br>回檔深<br>守軋空低</div>
                                    </div>
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-blue-600 mb-1">② 軋空盤</div>
                                        <div class="text-[9px]">空頭抵抗弱<br>高檔旗型<br>以盤代跌</div>
                                    </div>
                                    <div class="w-1/3 px-1">
                                        <div class="font-bold text-red-600 mb-1">③ 強軋空</div>
                                        <div class="text-[9px]">抵抗失敗<br>不回頭<br>直接噴出</div>
                                    </div>
                                </div>
                                <div class="mt-2 text-left w-full space-y-1">
                                     <p>① <span class="font-bold text-orange-600">盤堅盤 (Accumulation)：</span> 回檔較深，黑K吞噬紅棒，但<span class="bg-orange-100 px-1 rounded font-bold">守住軋空低</span>。策略：耐心等待。</p>
                                     <p>② <span class="font-bold text-blue-600">軋空盤 (Squeeze)：</span> 高檔整理，<span class="bg-blue-100 px-1 rounded font-bold">空頭抵抗</span>出現但守住昨日高點。策略：續抱看一飽。</p>
                                     <p>③ <span class="font-bold text-red-600">強軋空 (Super Squeeze)：</span> <span class="bg-red-100 px-1 rounded font-bold">空頭抵抗失敗</span>(紅框處)，隔日開高走高。策略：死抱看五倍。</p>
                                </div>
                            </div>
                        </div>

                        <!-- 空方盤態說明 (Updated) -->
                        <div class="border-t border-slate-200 pt-2">
                            <p class="font-bold bg-green-100 text-green-800 px-1 rounded inline-block mb-1">📉 空方趨勢 (Bearish)</p>
                            <ul class="space-y-2 ml-1">
                                <li>
                                    <span class="font-bold text-green-700">① 強殺多：</span>跳空向下，連黑K，完全無反彈。<br>
                                    <span class="text-slate-500">→ 策略：絕對不接刀，反彈就是空。</span>
                                </li>
                                <li>
                                    <span class="font-bold text-green-600">② 殺多盤：</span>弱勢整理再破底。<br>
                                    <span class="text-slate-500">→ 策略：利用反彈逃命，空方續抱。</span>
                                </li>
                                <li><span class="font-bold text-slate-600">③ 盤跌盤：</span>跌破後反彈深(假突破回頸線)，隨後再殺。<br>
                                    <span class="text-slate-500">→ 策略：區間操作，嚴設停損。</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </details>
                
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">第三篇：實戰與離場 (SOP)</div>

                <details class="group border border-green-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-green-800 bg-green-50 p-3">
                        <span>6. 攻擊篇：N字測幅 (手稿公式)</span>
                        <span class="text-green-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p>參數：<span class="font-bold text-red-600">h2 (今日最高)</span>，<span class="font-bold text-green-600">L (前三低)</span></p>
                        <div class="bg-green-50 p-2 rounded border border-green-100 font-mono">
                            <p>● <span class="font-bold">一飽 (1N)：</span> h2 × 2 - L (基本滿足)</p>
                            <p>● <span class="font-bold">二吐 (2N)：</span> 一飽 + (h2 - L) (強勢飆股)</p>
                            <p>● <span class="font-bold">五倍 (5x)：</span> h2 + 5 × (h2 - L) (摺疊翻箱)</p>
                        </div>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>7. 進階篇：長紅隔日強弱判定</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold">突破帶量長紅棒，隔日走勢至關重要：</p>
                        <ol class="list-decimal list-inside space-y-1 ml-1">
                            <li><span class="font-bold text-red-600">繼續漲：</span> 強勢 (Strong)。</li>
                            <li><span class="font-bold text-red-500">不破 1/3：</span> 次強 (Normal)。</li>
                            <li><span class="font-bold text-orange-500">不破 1/2：</span> 次次強 (Weak but Hold)。</li>
                            <li><span class="font-bold text-gray-500">跌破 1/2 或低點：</span> 假突破 (False Breakout)。</li>
                        </ol>
                    </div>
                </details>
                
                <details class="group border border-red-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-red-800 bg-red-50 p-3">
                        <span>8. 離場篇：世紀鋼 (9958) 賣訊</span>
                        <span class="text-red-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-700">賣出三部曲 (世紀鋼教訓)：</p>
                        <ol class="list-decimal list-inside ml-1">
                            <li><span class="font-bold">趨勢轉弱：</span>均線 (EMA 8/21/55) 上漲變緩或走平。</li>
                            <li><span class="font-bold">結構跌破：</span>三盤跌破 + 跌破所有均線。</li>
                            <li><span class="font-bold">指標確認：</span>落尾日落 + 寶塔翻綠。</li>
                        </ol>
                        <p class="bg-red-50 p-1 text-center font-bold text-red-900 mt-1">結論：多頭已死，果斷換股！</p>
                    </div>
                </details>
                
                <!-- 輸入指南 -->
                 <details class="group border border-gray-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-gray-800 bg-gray-50 p-3">
                        <span>9. SOP：盤中輸入指南</span>
                        <span class="text-gray-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white">
                        收盤價(跳動價)、今日最高(算目標)、軋空低(翻紅日低)、前三高/低(昨前大前)
                    </div>
                </details>

                <!-- NEW: 預判教學 -->
                <details class="group border border-sky-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-sky-800 bg-sky-50 p-3">
                        <span>10. 預判篇：如何模擬未來走勢？</span>
                        <span class="text-sky-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-600 border-b border-sky-100 pb-1">Q: 怎麼預測明天？(模擬戰情室用法)</p>
                        <ol class="list-decimal list-inside ml-1 space-y-2">
                            <li><span class="font-bold bg-blue-100 text-blue-800 px-1 rounded">情境按鈕 (新手)：</span>
                                <div class="pl-4 text-slate-500 mt-1">
                                    上方藍色區塊的按鈕 (如：模擬極強)，是<span class="bg-yellow-100 text-slate-800 px-1">系統自動填入假數據</span>，按下去後請直接看最下方的「分析結果」，讓你練習「看到這種數據該怎麼做」。
                                </div>
                            </li>
                            <li><span class="font-bold bg-slate-800 text-white px-1 rounded">手動預演 (老手)：</span>
                                <ul class="list-none list-inside pl-4 text-slate-600 mt-1 space-y-1">
                                    <li>① 填入真實的 <span class="font-bold">前三高、前三低、均量</span> (這是已知歷史)。</li>
                                    <li>② 更改 <span class="text-blue-700 font-bold">目前價</span> (輸入：你假設明天會漲到的價格)。</li>
                                    <li>③ 更改 <span class="text-purple-700 font-bold">成交量</span> (輸入：你預估明天的量)。</li>
                                    <li>④ 按下黑色 <span class="font-bold bg-black text-white px-1 text-[10px] rounded">執行實戰推演</span> 按鈕。</li>
                                </ul>
                                <p class="text-center text-red-600 font-bold mt-1 bg-red-50 p-1">💡 結論：利用假想的明後天價格，先算出下一步策略！</p>
                            </li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>

        <div class="p-6 space-y-5 relative z-0">
            
            <!-- 模擬戰情室 (New) -->
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <h3 class="text-xs font-black text-blue-900 mb-2 flex items-center">
                    🎮 模擬戰情室 (快速演習)
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="simulate('strong')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        🚀 模擬極強
                    </button>
                    <button onclick="simulate('break')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        🔥 模擬突破
                    </button>
                    <button onclick="simulate('crash')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        💀 模擬大跌
                    </button>
                    <button onclick="simulate('flat')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        ➖ 模擬盤整
                    </button>
                </div>
            </div>
            
            <!-- 0. 股票代碼 -->
            <div>
                <label class="block text-slate-700 font-bold mb-1 text-sm">股票名稱/代號</label>
                <input type="text" id="stockName" class="w-full p-2 border-2 border-slate-200 rounded focus:ring-2 focus:ring-slate-500 font-bold placeholder-slate-300 transition-colors" placeholder="例如：世紀鋼 (9958)">
            </div>

            <!-- 1. 狀態選擇 -->
            <div>
                <label class="block text-slate-700 font-bold mb-2 text-sm">1. 目前寶塔線顏色 (狀態)</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setStatus('GREEN')" id="btn-green" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100">
                        🟩 綠色 (空手/盤整)
                    </button>
                    <button onclick="setStatus('RED')" id="btn-red" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60">
                        🟥 紅色 (持有/多方)
                    </button>
                </div>
                <input type="hidden" id="currentStatus" value="GREEN">
            </div>

            <!-- 2. 核心價格 -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-blue-600 pl-2">核心價格 (Price Action)</h3>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-blue-900 font-bold mb-1 text-xs">目前價 (Current)</label>
                            <input type="number" step="0.01" id="closePrice" class="w-full p-2 border-2 border-blue-200 rounded focus:ring-blue-500 text-lg font-mono font-bold text-blue-900" placeholder="跳動價">
                        </div>
                        <div>
                            <label class="block text-red-700 font-bold mb-1 text-xs">今日最高 <span class="bg-red-100 px-1 rounded">h2</span></label>
                            <input type="number" step="0.01" id="todayHigh" class="w-full p-2 border-2 border-red-200 rounded focus:ring-red-500 text-lg font-mono font-bold text-red-700" placeholder="動態測幅用">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">前三高 (頸線)</label>
                        <input type="number" step="0.01" id="high3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="昨/前/大前">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">前三低 (L)</label>
                        <input type="number" step="0.01" id="low3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="昨/前/大前">
                    </div>
                    
                    <!-- 軋空低欄位 -->
                    <div class="col-span-2 bg-red-50 p-3 rounded-lg border-2 border-red-300 mt-2 relative overflow-hidden shadow-sm ring-2 ring-red-100">
                         <div class="absolute right-0 top-0 text-[60px] opacity-10 pointer-events-none transform rotate-12">🛡️</div>
                         <div class="flex justify-between items-center mb-1">
                             <label class="block text-purple-900 font-black mb-1 text-sm">★ 軋空低 (翻紅K棒最低點)</label>
                             <button onclick="toggleEncyclopedia()" class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded hover:bg-red-700 cursor-pointer shadow">❓ 填哪一天？</button>
                         </div>
                        <input type="number" step="0.01" id="breakoutLow" class="w-full p-2 border-2 border-purple-300 rounded font-mono text-lg text-purple-900 font-bold bg-white focus:ring-2 focus:ring-purple-500" placeholder="目標價生存線">
                        
                        <div class="mt-2 space-y-1 text-[11px] font-bold text-slate-600 bg-white/60 p-2 rounded border border-red-100">
                            <p>👉 <span class="text-red-700">若今日剛突破：</span>填「今天盤中」最低點。</p>
                            <p>👉 <span class="text-green-700">若已持有續抱：</span>填「當初買進那天」最低點。</p>
                            <p class="text-red-500 mt-1 border-t border-red-100 pt-1 flex items-center"><span class="text-lg mr-1">⚡</span> 跌破此價 = 攻擊失敗 (目標抵銷)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. 成交量 -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-purple-600 pl-2">成交量結構 (Volume)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-purple-900 font-bold mb-1 text-xs">今日成交量 (Today Vol)</label>
                        <input type="number" id="todayVol" class="w-full p-2 border-2 border-purple-200 rounded focus:ring-purple-500 font-mono text-lg font-bold text-purple-900" placeholder="預估量">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">過去三日均量 (Avg Vol)</label>
                        <input type="number" id="avgVol" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="輸入5T數值">
                    </div>
                </div>
            </div>

            <!-- 4. 強勢股判定參數 (含長紅強弱判定) -->
            <div id="advancedInputs" class="hidden bg-indigo-50 p-3 rounded-lg mt-4 border border-indigo-100">
                <h3 class="text-sm font-black text-indigo-900 mb-2">★ 盤態強弱判定參數 (選填)</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日收盤</label>
                        <input type="number" id="prevClose" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="昨收">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">今日最低</label>
                        <input type="number" id="todayLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="今低">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日最低</label>
                        <input type="number" id="prevLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="昨低">
                    </div>
                    <div class="col-span-3 mt-1 pt-2 border-t border-indigo-200">
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日長紅低點 (用於隔日強弱判定)</label>
                        <input type="number" id="prevLongRedLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="若昨日收黑則免填">
                    </div>
                </div>
            </div>

            <!-- 賣出檢核 -->
            <div id="sellChecklist" class="hidden bg-red-50 p-3 rounded border-2 border-red-200 mt-3">
                <h4 class="font-bold text-red-800 text-xs mb-2 flex items-center">📉 換股操作檢核</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkTrend" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">均線上漲趨勢緩</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkMA" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">三盤跌破所有均線</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkSunset" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">落尾日落 & 寶塔翻綠</span>
                    </label>
                </div>
                <div id="sellAdvice" class="hidden mt-2 p-3 bg-red-600 text-white text-sm font-black rounded text-center animate-pulse shadow-lg transform scale-105">
                    🚨 條件成立：收回資金，換股操作！
                </div>
            </div>

            <!-- 操作按鈕區 -->
            <div class="grid grid-cols-5 gap-2 mt-4">
                <button onclick="calculateStrategy()" class="col-span-3 bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-lg tracking-widest border border-slate-700">
                    執行實戰推演
                </button>
                <button onclick="clearInputs()" class="col-span-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl shadow-md transition-all active:scale-95 text-base border border-gray-300 flex items-center justify-center">
                    🔄 清除重置
                </button>
            </div>

            <!-- 結果顯示區 -->
            <div id="resultArea" class="hidden fade-in mt-4 pb-10">
                <div id="resultBox" class="p-5 rounded-xl border-l-8 shadow-md bg-white relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span id="stockBadge" class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded font-bold mb-1 inline-block"></span>
                                <h2 id="resultTitle" class="text-xl font-black leading-tight"></h2>
                            </div>
                            <span id="resultIcon" class="text-3xl"></span>
                        </div>

                        <div class="mb-3 flex flex-wrap gap-2">
                            <span id="trendTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="volTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="patternTag" class="hidden text-xs font-bold px-2 py-1 rounded border"></span>
                        </div>
                        
                        <p id="resultAction" class="text-2xl font-black mb-3 border-b pb-2"></p>
                        
                        <!-- N字測幅目標區 -->
                        <div id="targetBox" class="hidden bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm transition-all">
                            <h5 id="targetHeader" class="font-bold text-green-800 border-b border-green-200 pb-1 mb-2 flex justify-between">
                                <span>🎯 動態測幅目標 (h2=<span id="valH2"></span>, L=<span id="valL"></span>)</span>
                                <span id="targetStatusBadge" class="text-[10px] bg-green-200 px-1 rounded text-green-800">Active</span>
                            </h5>
                            <div id="targetList" class="space-y-1 font-mono text-slate-700">
                                <div class="flex justify-between">
                                    <span>一飽 (1N)：</span>
                                    <span class="font-bold text-green-700" id="target1"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>二吐 (2N)：</span>
                                    <span class="font-bold text-green-700" id="target2"></span>
                                </div>
                                <div class="flex justify-between bg-green-100 -mx-1 px-1 rounded">
                                    <span class="font-bold text-purple-700">五倍 (5N)：</span>
                                    <span class="font-bold text-purple-700" id="target5"></span>
                                </div>
                            </div>
                            <div id="targetInvalidMsg" class="hidden mt-2 text-center bg-gray-200 text-gray-500 font-bold py-1 rounded text-xs border border-gray-300">
                                ❌ 跌破軋空低，目標已抵銷
                            </div>
                        </div>

                        <div id="inferenceBox" class="hidden bg-slate-50 p-2 rounded border border-slate-200 mb-3 text-xs font-mono text-slate-600"></div>

                        <div class="bg-white/60 p-3 rounded border border-slate-200 mb-4 backdrop-blur-sm shadow-sm">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">★ 戰術指引 (Tactical Advice)</p>
                            <p id="resultAdvice" class="text-sm text-slate-800 font-medium leading-relaxed"></p>
                        </div>
                        
                        <div id="aiAnalysisBox" class="hidden mt-3 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-slate-700 shadow-inner relative">
                            <div class="absolute top-0 right-0 p-1 opacity-20 text-4xl">🤖</div>
                            <h4 id="aiReportTitle" class="font-black text-indigo-900 mb-2 border-b border-indigo-200 pb-1 flex items-center">
                                🧠 石頭戰略分析報告
                            </h4>
                            <div id="aiContent" class="ai-content">
                                <!-- AI Content will be injected here -->
                            </div>
                            <div id="aiLoading" class="hidden flex flex-col items-center justify-center py-4">
                                <div class="dot-flashing"></div>
                                <p class="text-xs text-indigo-400 mt-3 animate-pulse">正在解讀盤勢心理...</p>
                            </div>
                        </div>

                        <button onclick="copyReport()" id="copyBtn" class="w-full flex items-center justify-center space-x-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg transition-colors text-sm border border-slate-300 shadow-sm mt-2">
                            <span>📋 複製完整戰報</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- API Key 設定區 (選用) -->
            <details class="group mt-4 bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                <summary class="flex justify-between items-center font-bold text-gray-700 p-3 cursor-pointer hover:bg-gray-100">
                    <span>⚙️ 設定 API Key (選用：增強文采)</span>
                    <span class="text-gray-400 transition-transform group-open:rotate-180">▼</span>
                </summary>
                <div class="p-3 bg-white">
                    <p class="text-xs text-gray-500 mb-2">本系統已內建「石頭戰略邏輯庫」，不需 Key 也能產出完整報告！<br>若您有 Gemini API Key，填入後可獲得更多變化的 AI 文案。</p>
                    <input type="password" id="userApiKey" class="w-full p-2 border border-gray-300 rounded text-sm mb-2" placeholder="貼上 API Key (選填)">
                    <button onclick="saveApiKey()" class="bg-gray-800 text-white text-xs px-3 py-1.5 rounded hover:bg-gray-900 transition-colors w-full">💾 儲存設定</button>
                </div>
            </details>

        </div>
    </div>

    <script>
        const apiKey = ""; // Keep empty for local usage logic
        let baseReportText = "";
        let aiReportContent = "";
        let lastStockName = "";

        // 初始化：讀取儲存的 API Key
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('userApiKey').value = savedKey;
            }
        });

        // 定義 copyReport 在最上方，確保全域可見
        function copyReport() {
            if (!baseReportText) return;
            
            // Combine base report with AI content if available
            let fullReport = baseReportText;
            if (aiReportContent) {
                // Ensure proper spacing and the standard header for AI report
                fullReport += `\n\n三、🧠 石頭戰略 (${document.getElementById('stockName').value}) 分析報告\n${aiReportContent}`;
            }

            const textarea = document.createElement('textarea');
            textarea.value = fullReport;
            textarea.style.position = 'fixed';  // Prevent scrolling to bottom of page in MS Edge.
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            // Mobile safe copy
            if (navigator.userAgent.match(/ipad|iphone/i)) {
                const range = document.createRange();
                range.selectNodeContents(textarea);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textarea.setSelectionRange(0, 999999);
            } else {
                textarea.select();
            }
            
            try {
                document.execCommand('copy');
                const btn = document.getElementById('copyBtn');
                btn.innerHTML = '<span class="text-green-600">✅ 已複製到剪貼簿！</span>';
                setTimeout(() => btn.innerHTML = '<span>📋 複製完整戰報</span>', 2000);
            } catch (err) {
                console.error('複製失敗', err);
                alert('複製失敗，請手動複製');
            }
            document.body.removeChild(textarea);
        }

        // 定義其他全域函數
        window.copyReport = copyReport;

        function saveApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert("✅ API Key 已儲存！將啟用增強版 AI 分析。");
            } else {
                localStorage.removeItem('gemini_api_key');
                alert("⚠️ API Key 已清除，將切換回內建戰略邏輯庫。");
            }
        }

        // 模擬數據函數
        function simulate(type) {
            clearInputs(false); 
            // 基礎設定
            document.getElementById('stockName').value = "模擬個股 (TEST)";
            document.getElementById('high3d').value = 100;
            document.getElementById('low3d').value = 90;
            document.getElementById('avgVol').value = 1000;
            
            if (type === 'strong') {
                setStatus('RED');
                document.getElementById('closePrice').value = 108;
                document.getElementById('todayHigh').value = 108; 
                document.getElementById('breakoutLow').value = 98; 
                document.getElementById('todayVol').value = 2000;
                document.getElementById('prevClose').value = 104;
                document.getElementById('todayLow').value = 105;
                document.getElementById('prevLow').value = 102;
            } else if (type === 'break') {
                setStatus('GREEN');
                document.getElementById('closePrice').value = 102;
                document.getElementById('todayHigh').value = 103;
                document.getElementById('breakoutLow').value = 101; 
                document.getElementById('todayVol').value = 1500;
            } else if (type === 'crash') {
                setStatus('RED'); 
                document.getElementById('closePrice').value = 85; 
                document.getElementById('todayHigh').value = 92;
                document.getElementById('breakoutLow').value = 95; 
                document.getElementById('todayVol').value = 3000;
            } else if (type === 'flat') {
                setStatus('GREEN');
                document.getElementById('closePrice').value = 98; 
                document.getElementById('todayHigh').value = 99;
                document.getElementById('breakoutLow').value = 95;
                document.getElementById('todayVol').value = 600;
            }

            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.classList.remove('highlight-input');
                void input.offsetWidth;
                input.classList.add('highlight-input');
            });
            
            setTimeout(() => {
                calculateStrategy();
                const resultArea = document.getElementById('resultArea');
                resultArea.classList.remove('hidden');
                resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        const checkboxes = document.querySelectorAll('#sellChecklist input[type="checkbox"]');
        const adviceBox = document.getElementById('sellAdvice');
        checkboxes.forEach(chk => {
            chk.addEventListener('change', () => {
                const allChecked = Array.from(checkboxes).every(c => c.checked);
                if (allChecked) adviceBox.classList.remove('hidden');
                else adviceBox.classList.add('hidden');
            });
        });

        function toggleEncyclopedia() {
            const content = document.getElementById('encyclopediaContent');
            content.classList.toggle('hidden');
        }

        function clearInputs(hideResult = true) {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
            document.querySelectorAll('input[type="checkbox"]').forEach(box => box.checked = false);
            adviceBox.classList.add('hidden');
            document.getElementById('aiAnalysisBox').classList.add('hidden');
            document.getElementById('aiContent').innerHTML = '';
            aiReportContent = ""; 
            if(hideResult) document.getElementById('resultArea').classList.add('hidden');
            setStatus('GREEN');
            if(hideResult) window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        function formatPrice(num) {
            return parseFloat(num).toFixed(2);
        }
        function setStatus(status) {
            document.getElementById('currentStatus').value = status;
            document.getElementById('btn-green').className = status === 'GREEN' ? "py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100" : "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            document.getElementById('btn-red').className = status === 'RED' ? "py-3 px-4 border-2 rounded-lg font-bold transition-all border-red-500 bg-red-50 text-red-700 shadow-inner ring-2 ring-red-100 opacity-100" : "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            
            if(status === 'GREEN') {
                document.getElementById('advancedInputs').classList.add('hidden');
                document.getElementById('sellChecklist').classList.add('hidden');
            } else {
                document.getElementById('advancedInputs').classList.remove('hidden');
                document.getElementById('sellChecklist').classList.remove('hidden');
            }
        }

        function calculateStrategy() {
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-error'));
            document.getElementById('aiAnalysisBox').classList.add('hidden');
            document.getElementById('aiContent').innerHTML = '';
            aiReportContent = "";

            const stockName = document.getElementById('stockName').value || "未輸入股名";
            const status = document.getElementById('currentStatus').value;
            const close = parseFloat(document.getElementById('closePrice').value);
            const todayH = parseFloat(document.getElementById('todayHigh').value); 
            const high3d = parseFloat(document.getElementById('high3d').value); 
            const L = parseFloat(document.getElementById('low3d').value);   
            const breakoutLow = parseFloat(document.getElementById('breakoutLow').value); 
            const todayVol = parseFloat(document.getElementById('todayVol').value);
            const avgVol = parseFloat(document.getElementById('avgVol').value);
            const isFullSell = Array.from(checkboxes).every(c => c.checked);
            const prevClose = parseFloat(document.getElementById('prevClose').value);
            const todayLow = parseFloat(document.getElementById('todayLow').value);
            const prevLow = parseFloat(document.getElementById('prevLow').value);
            const prevLongRedLow = parseFloat(document.getElementById('prevLongRedLow').value);

            let hasError = false;
            let errorMsg = "請檢查紅框欄位：\n";
            if (!status) { errorMsg += "- 請選擇目前狀態\n"; hasError = true; }
            if (isNaN(close)) { document.getElementById('closePrice').classList.add('input-error'); errorMsg += "- 請輸入目前價\n"; hasError = true; }
            if (isNaN(high3d)) { document.getElementById('high3d').classList.add('input-error'); errorMsg += "- 請輸入前三高\n"; hasError = true; }
            if (isNaN(L)) { document.getElementById('low3d').classList.add('input-error'); errorMsg += "- 請輸入前三低\n"; hasError = true; }
            if (hasError) { alert(errorMsg); return; }

            let h2 = isNaN(todayH) ? close : todayH; 
            if(h2 < close) h2 = close;
            const gap = h2 - L;
            let target1 = 0, target2 = 0, target5 = 0;
            let targetReport = "";
            let isTargetValid = true;
            if (!isNaN(breakoutLow) && close < breakoutLow) isTargetValid = false; 

            if (gap > 0) {
                target1 = h2 + gap;
                target2 = h2 + (2 * gap);
                target5 = h2 + (5 * gap);
                document.getElementById('valH2').innerText = h2;
                document.getElementById('valL').innerText = L;
                document.getElementById('target1').innerText = formatPrice(target1);
                document.getElementById('target2').innerText = formatPrice(target2);
                document.getElementById('target5').innerText = formatPrice(target5);
                const targetBox = document.getElementById('targetBox');
                targetBox.classList.remove('hidden');
                if (isTargetValid) {
                    targetBox.className = "bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm";
                    document.getElementById('targetList').classList.remove('invalid-target');
                    document.getElementById('targetInvalidMsg').classList.add('hidden');
                    document.getElementById('targetStatusBadge').innerText = "Active";
                    document.getElementById('targetStatusBadge').className = "text-[10px] bg-green-200 px-1 rounded text-green-800";
                } else {
                    targetBox.className = "bg-gray-100 p-3 rounded border border-gray-300 mb-3 text-xs shadow-sm opacity-75";
                    document.getElementById('targetList').classList.add('invalid-target');
                    document.getElementById('targetInvalidMsg').classList.remove('hidden');
                    document.getElementById('targetStatusBadge').innerText = "Invalid";
                    document.getElementById('targetStatusBadge').className = "text-[10px] bg-gray-300 px-1 rounded text-gray-700";
                }
            } else {
                document.getElementById('targetBox').classList.add('hidden');
            }

            let isStrong = false;
            let patternType = ""; 
            let patternClass = "";
            let redCandleAdvice = "";
            let tacticalAdvice = "";
            let trendVerdict = "";
            let marketDesc = "";
            let reportTrend = "";

            if (status === 'RED') {
                if (!isNaN(prevClose) && !isNaN(todayLow) && !isNaN(prevLow)) {
                    if (close > prevClose && todayLow > prevLow) {
                        isStrong = true;
                        patternType = "🔥 強軋空盤";
                        patternClass = "bg-red-100 text-red-700 border-red-300";
                        tacticalAdvice = "🔥 趨勢：多方強勢 (強軋空)。\n依圖一所示，空頭抵抗失敗，K線連紅，建議死抱不放，目標看五倍。";
                        trendVerdict = "🔥 多方強勢 (強軋空)";
                        marketDesc = "空頭抵抗失敗，K線連紅，建議死抱不放。";
                    } else if (close >= high3d) {
                        patternType = "📈 軋空盤";
                        patternClass = "bg-blue-100 text-blue-700 border-blue-300";
                        tacticalAdvice = "📈 趨勢：多方攻擊 (軋空盤)。\n依圖一所示，空頭抵抗微弱，以盤代跌，建議續抱，看一飽二吐。";
                        trendVerdict = "📈 多方攻擊 (軋空盤)";
                        marketDesc = "空頭抵抗微弱，以盤代跌，建議續抱。";
                    } else {
                        patternType = "🐢 盤堅盤";
                        patternClass = "bg-orange-100 text-orange-800 border-orange-300";
                        tacticalAdvice = "🐢 趨勢：多方整理 (盤堅盤)。\n依圖一所示，空頭抵抗強烈，回檔較深，但只要不破軋空低，建議耐心等待。";
                        trendVerdict = "🐢 多方整理 (盤堅盤)";
                        marketDesc = "空頭抵抗強烈，回檔深，守住軋空低即可。";
                    }
                } else {
                    if (close > high3d) {
                        patternType = "📈 軋空盤"; 
                        patternClass = "bg-blue-100 text-blue-700 border-blue-300";
                        tacticalAdvice = "📈 趨勢：多方強勢 (軋空盤)。\n建議：守住昨日高點，續抱。";
                        trendVerdict = "📈 多方強勢 (軋空盤)";
                        marketDesc = "多方控盤，守住前高續抱。";
                    } else {
                        patternType = "🐢 盤堅盤";
                        patternClass = "bg-orange-100 text-orange-800 border-orange-300";
                        tacticalAdvice = "🐢 趨勢：多方整理 (盤堅盤)。\n建議：回檔整理，嚴守軋空低。";
                        trendVerdict = "🐢 多方整理 (盤堅盤)";
                        marketDesc = "回檔整理中，嚴守軋空低。";
                    }
                }

                if (!isNaN(prevClose) && !isNaN(prevLongRedLow)) { 
                    let redLen = prevClose - prevLongRedLow;
                    let p1_3 = prevClose - (redLen * 0.33); 
                    let p1_2 = prevClose - (redLen * 0.5);  
                    if (close > prevClose) redCandleAdvice = "強勢續漲";
                    else if (close >= p1_3) redCandleAdvice = "次強 (守1/3)";
                    else if (close >= p1_2) redCandleAdvice = "次次強 (守1/2)";
                    else if (close < p1_2 || close < prevLongRedLow) {
                        redCandleAdvice = "轉弱 (破1/2)";
                        patternType = "⚠️ 疑似假突破"; 
                        patternClass = "bg-yellow-100 text-yellow-800 border-yellow-300";
                        tacticalAdvice = "⚠️ 趨勢：轉弱疑慮 (假突破)。\n建議：跌破長紅1/2，攻擊失敗風險增高，建議減碼觀察。";
                        trendVerdict = "⚠️ 轉弱疑慮 (假突破)";
                        marketDesc = "攻擊失敗風險增高，建議減碼。";
                    }
                }
                const pTag = document.getElementById('patternTag');
                pTag.innerText = patternType;
                pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                pTag.classList.remove('hidden');
            } else { 
                if(close < L) { 
                      patternType = "📉 空方殺多";
                      patternClass = "bg-green-100 text-green-800 border-green-300";
                      tacticalAdvice = "📉 趨勢：空方殺多。\n依圖二所示，空方趨勢確立 (強殺多/殺多盤)，反彈不過殺多高就是空。若持有，請立刻停損，絕不接刀。";
                      trendVerdict = "📉 空方殺多";
                      marketDesc = "空方趨勢確立，反彈皆是空點。";
                      const pTag = document.getElementById('patternTag');
                      pTag.innerText = patternType;
                      pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                      pTag.classList.remove('hidden');
                } else {
                      patternType = "💤 盤跌/觀望";
                      patternClass = "bg-gray-100 text-gray-600 border-gray-300";
                      tacticalAdvice = "💤 趨勢：盤勢不明 (盤跌)。\n依圖二所示，反彈深(假突破)，隨後再殺。建議多看少做，保留現金，等待突破訊號。";
                      trendVerdict = "💤 盤勢不明 (盤跌)";
                      marketDesc = "反彈深似假突破，多看少做。";
                      const pTag = document.getElementById('patternTag');
                      pTag.innerText = patternType;
                      pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                      pTag.classList.remove('hidden');
                }
            }

            let volStatus = "一般";
            let volRatio = 0;
            let inferenceReportText = "";
            let inferenceText = "";
            let scenarioScript = "";
            let v_strong = 0, v_break = 0, v_wash = 0;
            const safeTarget5 = isNaN(target5) || target5 === 0 ? "待計算" : formatPrice(target5);
            const safeHigh3d = isNaN(high3d) ? "前高" : high3d;
            const safeBreakoutLow = isNaN(breakoutLow) ? "防守點" : breakoutLow;

            if (!isNaN(avgVol) && avgVol > 0) {
                v_strong = Math.round(avgVol * 1.5);
                v_break = Math.round(avgVol * 1.3);
                v_wash = Math.round(avgVol * 0.8);
                const targetAttackFormatted = formatNumber(Math.round(avgVol * 1.3));
                const targetWashFormatted = formatNumber(Math.round(avgVol * 0.8));
                const isAttack = todayVol >= (avgVol * 1.3) ? "(🔥達標)" : "";
                const isWash = todayVol <= (avgVol * 0.8) ? "(✅達標)" : "";
                
                inferenceReportText = `★量價推演：
• 攻擊門檻(1.3x)：${targetAttackFormatted} ${isAttack}
• 洗盤門檻(0.8x)：${targetWashFormatted} ${isWash}`;

                inferenceText = `
                    <div class="bg-slate-50 p-3 rounded border border-slate-300 mb-3 text-xs">
                        <h5 class="font-bold text-slate-700 border-b border-slate-200 pb-1 mb-2">【明日開盤・量能作戰劇本】(依均量 ${formatNumber(avgVol)})</h5>
                        <div class="space-y-2">
                            <div class="bg-red-50 p-2 rounded border border-red-100">
                                <div class="flex justify-between font-bold text-red-800 mb-1">
                                    <span>🔴 劇本 A：模擬極強 (主力強攻)</span>
                                    <span>> ${formatNumber(v_strong)}張</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>● 行為：跳空開高，不破開盤，直攻漲停。</p>
                                    <p>● 指令：<span class="bg-red-600 text-white px-1 rounded font-bold">追價 (Buy)</span> 目標直指 5N (${safeTarget5})。</p>
                                </div>
                            </div>
                            <div class="bg-green-50 p-2 rounded border border-green-100">
                                <div class="flex justify-between font-bold text-green-800 mb-1">
                                    <span>🟢 劇本 B：模擬突破 (趨勢延續)</span>
                                    <span>${formatNumber(v_break)}~${formatNumber(v_strong)}張</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>● 行為：穩健推升，確認突破前高 ${safeHigh3d}。</p>
                                    <p>● 指令：<span class="bg-green-600 text-white px-1 rounded font-bold">加碼 (Add)</span> 確認過頸線後進場。</p>
                                </div>
                            </div>
                            <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                <div class="flex justify-between font-bold text-yellow-800 mb-1">
                                    <span>🟡 劇本 C：模擬盤整 (量縮洗盤)</span>
                                    <span>< ${formatNumber(v_wash)}張</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>● 行為：價格震盪，無攻擊意圖。</p>
                                    <p>● 指令：<span class="bg-yellow-600 text-white px-1 rounded font-bold">觀望 (Hold)</span> 守住防守點即可。</p>
                                </div>
                            </div>
                            <div class="bg-gray-100 p-2 rounded border border-gray-300">
                                <div class="flex justify-between font-bold text-gray-800 mb-1">
                                    <span>⚫ 劇本 D：模擬大跌 (出貨/假突破)</span>
                                    <span>爆量但收黑</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>● 行為：爆量不漲 (> ${formatNumber(v_break)}張)，或跌破 ${safeBreakoutLow}。</p>
                                    <p>● 指令：<span class="bg-black text-white px-1 rounded font-bold">快逃 (Sell)</span> 主力倒貨，無條件離場。</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-white border border-slate-200 rounded shadow-sm">
                            <p class="font-bold text-slate-700 border-b border-slate-100 pb-1 mb-1">💡 石頭戰術小卡：如何計算「預估量」？</p>
                            <p class="text-[10px] text-slate-500">公式：<span class="font-bold text-blue-600">09:15 成交量 x 8</span> = 預估全日量</p>
                        </div>
                    </div>`;
                
                scenarioScript = `【明日開盤・量能作戰劇本】(均量 ${formatNumber(avgVol)})
🔴 劇本 A (極強)
預估量 > ${formatNumber(v_strong)} 張 (1.5倍↑)
→ 指令：追價 (Buy)，目標直指 5N (${safeTarget5})。
🟢 劇本 B (突破)
預估量 ${formatNumber(v_break)} ~ ${formatNumber(v_strong)} 張
→ 指令：加碼 (Add)，確認突破前高 ${safeHigh3d}。
🟡 劇本 C (盤整)
預估量 < ${formatNumber(v_wash)} 張 (0.8倍↓)
→ 指令：觀望 (Hold)，嚴守防守位。
⚫ 劇本 D (大跌)
爆量 (> ${formatNumber(v_break)}) 但收黑或跌破 ${safeBreakoutLow}
→ 指令：快逃 (Sell)，此為主力倒貨訊號。
💡 戰術小卡：預估量 = 09:15 成交量 x 8`;

                if (!isNaN(todayVol)) {
                    volRatio = todayVol / avgVol;
                    if (volRatio >= 1.5) volStatus = "極強攻擊量 (1.5倍↑)";
                    else if (volRatio >= 1.3) volStatus = "攻擊量 (紅財神)";
                    else if (volRatio <= 0.8) volStatus = "量縮整理";
                    else volStatus = "量能溫和";
                }
            }

            const resultArea = document.getElementById('resultArea');
            resultArea.classList.remove('hidden');
            const resultBox = document.getElementById('resultBox');
            const rTitle = document.getElementById('resultTitle');
            const rAction = document.getElementById('resultAction');
            const rIcon = document.getElementById('resultIcon');
            const rTrend = document.getElementById('trendTag');
            const rVol = document.getElementById('volTag');
            const rAdvice = document.getElementById('resultAdvice');
            const rStock = document.getElementById('stockBadge');
            const rInference = document.getElementById('inferenceBox');

            let titleText = "", actionText = "", boxClass = "", titleClass = "", actionClass = "", volClass = "";
            volClass = (volRatio >= 1.3) ? "bg-purple-100 text-purple-700 border-purple-300" : (volRatio <= 0.8 ? "bg-blue-100 text-blue-700 border-blue-300" : "bg-slate-100 text-slate-600 border-slate-200");

            if (status === 'GREEN') {
                if (close > high3d) {
                    titleText = "🔥 三盤突破 (翻紅)"; reportTrend = "3. N字起漲 (Day 1)"; actionText = "市價買進";
                    boxClass = "bg-red-50 border-red-500"; titleClass = "text-xl font-bold text-red-600"; actionClass = "text-2xl font-black text-red-700 border-b border-red-200 pb-2 mb-2"; rTrend.className = "text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-700 border border-red-200"; rIcon.innerText = "🚀";
                } else {
                    titleText = "💤 盤整延續"; actionText = "觀望 (WAIT)";
                    boxClass = "bg-green-50 border-green-500"; titleClass = "text-xl font-bold text-green-700"; actionClass = "text-2xl font-black text-green-800 border-b border-green-200 pb-2 mb-2"; rTrend.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700 border border-green-200"; rIcon.innerText = "🐢";
                }
            } else {
                if (isFullSell) {
                    titleText = "🚨 逃命訊號"; actionText = "收回資金，換股";
                    boxClass = "bg-red-200 border-red-700"; titleClass = "text-xl font-black text-red-900"; actionClass = "text-2xl font-black text-red-900 border-b border-red-400 pb-2 mb-2"; rIcon.innerText = "📉";
                } else if (close < L) {
                    titleText = "⚠️ 三盤跌破"; actionText = "無條件離場";
                    boxClass = "bg-green-100 border-green-600"; titleClass = "text-xl font-bold text-green-900"; actionClass = "text-2xl font-black text-green-900 underline border-b border-green-300 pb-2 mb-2"; rIcon.innerText = "🏃";
                } else {
                    if (!isTargetValid) {
                        titleText = "⚠️ 攻擊失效"; actionText = "減碼觀望";
                        boxClass = "bg-yellow-50 border-yellow-500"; titleClass = "text-xl font-bold text-yellow-700"; actionClass = "text-2xl font-black text-yellow-800 border-b border-yellow-300 pb-2 mb-2"; rIcon.innerText = "⚠️";
                    } else {
                        if(isStrong) { titleText = "🐂 強軋空盤"; actionText = "死抱不放"; boxClass = "bg-red-100 border-red-600"; titleClass = "text-xl font-bold text-red-700"; actionClass = "text-2xl font-black text-red-800 border-b border-red-300 pb-2 mb-2"; rIcon.innerText = "💎"; } 
                        else { titleText = "✅ 多頭續抱"; actionText = "續抱 (HOLD)"; boxClass = "bg-orange-50 border-orange-400"; titleClass = "text-xl font-bold text-orange-600"; actionClass = "text-2xl font-black text-orange-700 border-b border-orange-200 pb-2 mb-2"; rIcon.innerText = "✊"; }
                    }
                }
            }

            resultBox.className = `p-5 rounded-xl border-l-8 shadow-md relative overflow-hidden ${boxClass}`;
            rStock.innerText = stockName; rTitle.innerText = titleText; rTitle.className = titleClass;
            rAction.innerText = actionText; rAction.className = actionClass;
            rAdvice.innerText = tacticalAdvice; rTrend.innerText = reportTrend; rVol.innerText = volStatus; rVol.className = `text-xs font-bold px-2 py-1 rounded border ${volClass}`;
            if(inferenceText) { rInference.innerHTML = inferenceText; rInference.classList.remove('hidden'); } else { rInference.classList.add('hidden'); }

            const today = new Date().toLocaleDateString('zh-TW');
            let targetSection = '・無測幅 (未過頸線)';
            if (gap > 0) targetSection = `• 一飽(1N)：${formatPrice(target1)}\n• 二吐(2N)：${formatPrice(target2)}\n• 五倍(5N)：${formatPrice(target5)}`;

            let volumeCheck = "量能溫和";
            if(volRatio >= 1.3) volumeCheck = "攻擊量能達標 (符合1.3倍↑)";
            else if (volRatio <= 0.8) volumeCheck = "量縮洗盤達標 (符合0.8倍↓)";

            let nextDayKey = "";
            if(!isNaN(avgVol) && avgVol > 0) {
                 const v_target = Math.round(avgVol * 1.3);
                 nextDayKey = `關鍵提醒：明日開盤請緊盯成交量，若預估量能未達 ${formatNumber(v_target)} 張 (攻擊門檻)，則強軋空攻勢可能減弱。`;
            }

            let targetGoal = "待確認";
            if(isStrong) targetGoal = `5N (${formatPrice(target5)})`;
            else if(patternType.includes("軋空")) targetGoal = `2N (${formatPrice(target2)})`;
            else if(gap > 0) targetGoal = `1N (${formatPrice(target1)})`;
            
            let safeGuard = `不破軋空低點 (${breakoutLow})，上述目標才有效。`;
            if (isNaN(breakoutLow)) safeGuard = "請設定軋空低以確認防守點。";

            baseReportText = `「嗨，我是石頭，我的N字戰法分析系統希望能讓你勝率💯」
N字戰法指揮中心 by.石頭 V12.2 (${today})
股名：${stockName}

一、個股現況分析
📌 操作指令：【 ${actionText} 】
量能：${volStatus}
現價：${close}
型態：${patternType || '一般盤整'}
🎯 動態測幅 (h2=${h2})
${targetSection}
${inferenceReportText}

二、明日策略分析
${scenarioScript}

★ 戰術指引：
趨勢判定：${trendVerdict}
盤勢現狀：${marketDesc}
長紅力道：${redCandleAdvice || '無特殊訊號'}
⚠️ 防守要點：不破軋空低點(${breakoutLow})，上述目標才有效。`;
            
            triggerAnalysis(stockName, close, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isStrong, patternType);
            document.getElementById('copyBtn').innerHTML = '<span>📋 複製完整戰報</span>';
        }

        // 整合邏輯：判斷是有 Key (AI) 還是無 Key (內建邏輯)
        async function triggerAnalysis(stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isStrong, patternType) {
            const userKey = localStorage.getItem('gemini_api_key');
            document.getElementById('aiAnalysisBox').classList.remove('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiReportTitle').innerText = `🧠 石頭戰略(${stockName})分析報告`;

            if (userKey) {
                // 有 Key -> 呼叫 Gemini
                await askGeminiStrategy(userKey, stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1);
            } else {
                // 無 Key -> 使用內建邏輯庫 (JS)
                setTimeout(() => generateLocalAnalysis(isStrong, patternType, status), 800); // 模擬運算時間
            }
        }

        // 本地端邏輯產生器 (免 Key 核心)
        function generateLocalAnalysis(isStrong, patternType, status) {
            document.getElementById('aiLoading').classList.add('hidden');
            let psychology = "", trap = "", mantra = "", conclusion = "";

            if (status === 'RED') {
                if (isStrong) {
                    psychology = "根據量價結構，主力正進行積極操作。現價穩站頸線與軋空低防守點，成交量放大顯示資金積極湧入而非震盪。主力的目的在於利用買盤壓力迫使空單回補，目前處於明確的進貨拉抬階段，目標直接衝擊第一測幅，此為積極的籌碼集中，並非出貨。";
                    trap = "在強軋空行情中，散戶最易掉入兩大陷阱：\n1. 過早下車：持有者因無法承受浮盈誘惑或擔心回檔，在接近 1N 目標前提前了結，錯失主升段精華。\n2. 追高恐懼：空手者因價格持續上攻而恐懼，等待不曾出現的「完美拉回點」，最後在最高點情緒性進場。";
                    mantra = "「趨勢確立，死抱是功德。」";
                    conclusion = "● 盤勢定調：處於「強勢攻擊區」，多方擁有絕對控盤權。\n● 關鍵指標：若預估量能持續放大，代表多頭動能猛烈。\n● 防守底線：嚴守軋空低關卡，不破此位，5N 路徑依然成立。\n● 操作核心：對抗小利即安的心態，鎖定 1N 目標後再考慮分批停利。";
                } else if (patternType.includes("軋空")) {
                    psychology = "目前主力採取「穩健推升」策略，透過盤中震盪消化獲利了結賣壓。成交量溫和放大，顯示主力控盤穩定，意在清洗浮額而非拉高出貨。";
                    trap = "散戶容易因盤中震盪而失去耐心，誤將主力洗盤視為轉弱訊號而提早離場。";
                    mantra = "「買在分歧，抱在一致。」";
                    conclusion = "● 盤勢定調：多方架構完整，屬於標準攻擊型態。\n● 操作核心：續抱，移動停損點至今日低點。";
                } else {
                    psychology = "主力目前進行防守型操作，雖未發動猛攻，但堅守關鍵支撐位。此階段多為蓄力期，測試下方買盤支撐力道。";
                    trap = "容易陷入「不耐久盤」的心理，在發動攻擊前夕因無聊而賣出。";
                    mantra = "「耐心是交易者的美德。」";
                    conclusion = "● 盤勢定調：多方整理，等待放量攻擊訊號。";
                }
            } else {
                psychology = "目前由空方掌控節奏，主力利用反彈測試壓力並減碼。任何上漲皆可能為誘多陷阱。";
                trap = "散戶常誤以為跌深即是買點，試圖「抄底」卻接住掉落的刀子。";
                mantra = "「空頭不猜底，現金為王。」";
                conclusion = "● 盤勢定調：空方趨勢或盤整偏弱。\n● 操作核心：空手觀望，持有者反彈減碼。";
            }

            const reportHTML = `
                <div class="space-y-4">
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(一)、 主力心理透視</h5>
                        <p>${psychology}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(二)、 散戶心理陷阱</h5>
                        <p>${trap.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(三)、 教練心法</h5>
                        <p class="bg-indigo-50 p-2 rounded text-indigo-800 font-bold italic">${mantra}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(四)、 石頭戰略結論</h5>
                        <p>${conclusion.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('aiContent').innerHTML = reportHTML;
            aiReportContent = `(一)、 主力心理透視
${psychology}
(二)、 散戶心理陷阱
${trap}
(三)、 教練心法
${mantra}
(四)、 石頭戰略結論
${conclusion}`;
        }

        async function askGeminiStrategy(key, stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1) {
            const promptText = `
                你現在是精通「N字戰法」的資深操盤手教練。請根據以下數據，為使用者進行盤勢心理分析與操作建議。
                
                【當前數據】
                股名：${stockName}
                現價：${closePrice}
                狀態：${status === 'RED' ? '多方 (持有/攻擊)' : '空方 (觀望/整理)'}
                成交量：${todayVol} (均量: ${avgVol})
                關鍵價位：頸線 ${high3d}, 軋空低防守點 ${breakoutLow}
                系統判斷：${tacticalAdvice}
                測幅目標：一飽 ${target1}

                【任務要求】
                請用直白、專業、不誇飾的語氣 (繁體中文)，提供以下分析 (請使用 Markdown 格式)：
                
                請嚴格依照以下格式輸出（不要有額外的開場白）：
                (一)、 主力心理透視
                (內容：根據量價結構，推測主力是在進貨、洗盤還是出貨？)
                (二)、 散戶心理陷阱
                (內容：現在散戶容易犯什麼錯？例如追高、不敢買、過早下車)
                (三)、 教練心法
                (內容：一句簡短有力的操作格言)
                (四)、 石頭戰略結論 (第四點結論法)
                (內容：請用條列式總結 1.盤勢定調 2.關鍵指標 3.防守底線 4.操作核心)
                
                請不要重複列出數據，直接進行定性分析。
            `;

            try {
                const responseText = await callGeminiAPI(key, promptText);
                document.getElementById('aiLoading').classList.add('hidden');
                aiReportContent = responseText;
                const htmlContent = marked.parse(responseText);
                document.getElementById('aiContent').innerHTML = htmlContent;
                document.getElementById('aiAnalysisBox').scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiContent').innerHTML = `<p class="text-red-500 font-bold">⚠️ 連線異常 (請檢查 Key): ${error.message} <br> <button onclick="generateLocalAnalysis(true, '🔥 強軋空盤', 'RED')" class="text-blue-500 underline mt-2">切換至內建邏輯庫</button></p>`;
            }
        }

        async function callGeminiAPI(key, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if(response.status === 429) throw new Error("請求過於頻繁 (429)，請稍候再試");
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "無法取得分析結果。";
        }
    </script>
</body>
</html>
