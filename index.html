<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nå­—æˆ°æ³•ï¼šä¸‰ç›¤è½‰æŠ˜åˆ¤æ–·è¨ˆç®—æ©Ÿ (V13.0 AIæˆ°ç•¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å·è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .invalid-target { text-decoration: line-through; color: #9ca3af; }
        .input-error { border-color: #ef4444 !important; ring: 2px; ring-color: #ef4444; background-color: #fef2f2; }
        
        /* é–ƒçˆæé†’ç‰¹æ•ˆ */
        @keyframes highlightPulse {
            0% { background-color: #fff; }
            50% { background-color: #fef9c3; } /* yellow-100 */
            100% { background-color: #fff; }
        }
        .highlight-input { animation: highlightPulse 1s ease-in-out; }

        /* æ‘ºç–Šé¸å–®æ¨£å¼ */
        details > summary { list-style: none; cursor: pointer; transition: all 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { margin-bottom: 0.5rem; }
        details > summary:hover { background-color: #f8fafc; }

        /* AI Loading Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #6366f1; }
            50%, 100% { background-color: #e0e7ff; }
        }
        
        /* Markdown Styles for AI Response */
        .ai-content h1, .ai-content h2, .ai-content h3 { font-weight: 800; margin-top: 0.5em; margin-bottom: 0.3em; color: #1e1b4b; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .ai-content p { margin-bottom: 0.5em; line-height: 1.6; }
        .ai-content strong { color: #b91c1c; }

        /* Audio Wave Animation */
        .audio-wave {
            display: flex;
            align-items: center;
            height: 20px;
        }
        .audio-wave .bar {
            width: 4px;
            height: 100%;
            background: #4f46e5;
            margin: 0 2px;
            border-radius: 2px;
            animation: sound 0ms -800ms linear infinite alternate;
        }
        .audio-wave.playing .bar {
            animation-duration: 400ms;
        }
        @keyframes sound {
            0% { opacity: .35; height: 3px; }
            100% { opacity: 1; height: 20px; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden border border-slate-300 relative">
        <!-- Header -->
        <div class="bg-slate-900 p-5 text-white text-center relative z-20">
            <h1 class="text-2xl font-black tracking-wider">Nå­—æˆ°æ³•æŒ‡æ®ä¸­å¿ƒ by.çŸ³é ­ <span class="text-yellow-400 text-sm align-top">V13.0</span></h1>
            <p class="text-xs text-slate-400 mt-1">âœ¨ AI èªéŸ³æŒ‡æ®å®˜ x æ™ºèƒ½æ•™ç·´å°è©±</p>
        </div>

        <!-- æˆ°æ³•ç™¾ç§‘å…¨æ›¸ (Accordion Menu) -->
        <div class="bg-slate-50 border-b border-slate-200">
            <div class="p-3 text-center bg-blue-700 text-white font-bold text-sm cursor-pointer hover:bg-blue-800 transition-colors" onclick="toggleEncyclopedia()">
                ğŸ“– é»æˆ‘æ‰“é–‹ï¼šNå­—æˆ°æ³•å…¨èƒ½ç™¾ç§‘ (åœ–è§£ç²¾è¯) â–¼
            </div>
            
            <div id="encyclopediaContent" class="hidden max-h-[500px] overflow-y-auto p-4 space-y-3 shadow-inner bg-white">
                <!-- Part 1: åŸºç¤è¶¨å‹¢ -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-2 mb-1">ç¬¬ä¸€ç¯‡ï¼šåŸºç¤è¶¨å‹¢èˆ‡è½‰æŠ˜ (å®šå¤šç©º)</div>
                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>1. è¶¨å‹¢ç¯‡ï¼šæœ«å‡ä½ & æœ«è·Œé«˜</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">â— æœ«å‡ä½ (Last Rising Low)ï¼š</span>å¤šé ­å‰µé«˜æ³¢æ®µçš„ã€Œèµ·æ¼²é»ã€ã€‚<br>é‚è¼¯ï¼šå®ˆä½æœ«å‡ä½=å¤šé ­ï¼Œè·Œç ´=è¶¨å‹¢ç ´å£ã€‚</p>
                        <p><span class="font-bold text-green-600">â— æœ«è·Œé«˜ (Last Falling High)ï¼š</span>ç©ºé ­å‰µä½æ³¢æ®µçš„ã€Œèµ·è·Œé»ã€ã€‚<br>é‚è¼¯ï¼šçªç ´æœ«è·Œé«˜=ç©ºç¿»å¤šã€‚</p>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>2. è½‰æŠ˜è¨Šè™Ÿï¼šæ—¥å‡ºç·š & æ—¥è½ç·š</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">ğŸŒ… æ—¥å‡ºç·š (Sunrise)ï¼š</span>é«˜éæ˜¨é«˜ï¼Œæ”¶ç›¤æ”¶é«˜ã€‚<br>ç”¨é€”ï¼šå›æª”æ™‚çš„æ­¢è·Œè²·è¨Šã€‚</p>
                        <p><span class="font-bold text-green-600">ğŸŒ‡ æ—¥è½ç·š (Sunset)ï¼š</span>ä½ç ´æ˜¨ä½ï¼Œæ”¶ç›¤æ”¶ä½ã€‚<br>ç”¨é€”ï¼šä¸Šæ¼²æ™‚çš„æ­¢æ¼²è³£è¨Šã€‚</p>
                        <p class="bg-indigo-50 p-1 rounded font-bold text-center">å£è¨£ï¼šå›æª”æ‰¾æ—¥å‡ºï¼Œä¸Šæ¼²é˜²æ—¥è½ã€‚</p>
                    </div>
                </details>

                <details class="group border border-purple-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-purple-800 bg-purple-50 p-3">
                        <span>3. é˜²å®ˆç¯‡ï¼šè»‹ç©ºä½ & ç¿»ç´…å®šç¾©</span>
                        <span class="text-purple-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                        <p><span class="font-bold bg-indigo-100 text-indigo-800 px-1 rounded">ç¿»ç´…Kæ£’ï¼š</span> å¯¶å¡”ç·šç”±ç¶ ç¿»ç´… (æ”¶ç›¤ > å‰ä¸‰é«˜) ç•¶å¤©çš„é‚£æ ¹Kæ£’ã€‚</p>
                        <p><span class="font-bold bg-purple-100 text-purple-800 px-1 rounded">è»‹ç©ºä½ï¼š</span> ç¿»ç´…Kæ£’çš„<span class="text-red-600 font-bold">æœ€ä½é»</span>ã€‚</p>
                        
                        <!-- æˆæœ¬è¿·æ€è§£æƒ‘ -->
                        <div class="bg-red-50 p-2 rounded border border-red-200">
                            <p class="font-bold text-red-800 border-b border-red-200 pb-1 mb-1">ğŸ’¡ è»‹ç©ºä½å¡«å“ªä¸€å¤©ï¼Ÿ</p>
                            <p class="mb-1 text-slate-800 font-bold">Nå­—æˆ°æ³•æ“ä½œã€Œç•¶ä¸‹ã€ï¼Œä¸å•æˆæœ¬ï¼</p>
                            <div class="grid grid-cols-1 gap-2 mt-2">
                                <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                    <p class="font-bold text-yellow-800">ğŸ“Œ æƒ…å¢ƒ A (ç©ºæ‰‹æƒ³è²·)</p>
                                    <p>è¼¸å…¥ï¼šå¡« <span class="font-bold text-red-600">ã€Œä»Šå¤©ã€</span> çš„ç›¤ä¸­æœ€ä½é»ã€‚</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-200">
                                    <p class="font-bold text-green-800">ğŸ“Œ æƒ…å¢ƒ B (æŒæœ‰çºŒæŠ±)</p>
                                    <p>è¼¸å…¥ï¼šå¡« <span class="font-bold text-red-600">ã€Œç•¶åˆè²·é€²é‚£å¤©ã€</span> çš„æœ€ä½é»ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                 <!-- NEW: å¯¶å¡”ç·šé‚è¼¯ -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">ç¬¬äºŒç¯‡ï¼šå¯¶å¡”ç·šèˆ‡ç›¤æ…‹åœ–è§£ (é‡é»)</div>

                <details class="group border border-blue-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-blue-800 bg-blue-50 p-3">
                        <span>4. åŸç†ç¯‡ï¼šå¯¶å¡”ç·š (TOW) é‚è¼¯è©³è§£</span>
                        <span class="text-blue-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                         <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                            <p class="font-bold text-yellow-900 border-b border-yellow-200 pb-1 mb-1">ğŸ’¡ ç‚ºä»€éº¼è§€å¯Ÿä¸‰å¤©ï¼Ÿ (åƒæ•¸=3)</p>
                            <ul class="list-decimal list-inside space-y-1 text-yellow-800">
                                <li><span class="font-bold">éæ¿¾å‡è¨Šè™Ÿï¼š</span>é¿å…ã€Œä¸€æ—¥è¡Œæƒ…ã€ã€‚</li>
                                <li><span class="font-bold">å¿ƒç†é˜²ç·šï¼š</span>Day 1 è®Šç›¤ï¼ŒDay 2 å»¶çºŒï¼ŒDay 3 ç¢ºç«‹ã€‚</li>
                                <li><span class="font-bold">æ“ä½œç²¾é«“ï¼š</span>ç¶ ç¿»ç´…å¾Œï¼Œè‹¥é€£çºŒä¸‰å¤©ä¸ç ´ Day 1 ä½é»ï¼Œå¤šé ­ç¢ºç«‹ã€‚</li>
                            </ul>
                        </div>
                    </div>
                </details>

                <!-- Part 2: ç›¤æ…‹èˆ‡æ”»æ“Š (ä¾æ“šåœ–ç‰‡æ›´æ–° - NEW) -->
                
                <details class="group border border-orange-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-orange-800 bg-orange-50 p-3">
                        <span>5. å¿ƒæ³•ç¯‡ï¼šç›¤æ…‹åˆ†é¡ (åœ–è§£å°ç…§)</span>
                        <span class="text-orange-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-4">
                        
                        <!-- åœ–è§£: å¤šæ–¹ä¸‰ç›¤æ…‹ (User Uploaded) -->
                        <div>
                            <p class="font-bold bg-red-100 text-red-800 px-1 rounded inline-block mb-1">ğŸ“ˆ å¤šæ–¹è¶¨å‹¢ (Bullish)</p>
                            <div class="flex flex-col items-center my-2 p-2 border border-slate-200 rounded bg-white">
                                <div class="w-full text-center text-[10px] text-gray-500 mb-1">â–¼ åœ–ä¸€ï¼šå¤šæ–¹ç›¤æ…‹èˆ‡ç©ºé ­æŠµæŠ— (æŒ‰åœ–æ“ä½œ) â–¼</div>
                                <div class="w-full h-auto rounded shadow-sm bg-gray-100 p-2 text-center text-xs text-gray-500 flex justify-around">
                                    <!-- æ¨¡æ“¬åœ–ç¤ºçµæ§‹ (å¯¦éš›ç‚ºæ–‡å­—æè¿°åœ–ä¸­ç²¾é«“) -->
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-orange-600 mb-1">â‘  ç›¤å …ç›¤</div>
                                        <div class="text-[9px]">ç©ºé ­æŠµæŠ—å¼·<br>å›æª”æ·±<br>å®ˆè»‹ç©ºä½</div>
                                    </div>
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-blue-600 mb-1">â‘¡ è»‹ç©ºç›¤</div>
                                        <div class="text-[9px]">ç©ºé ­æŠµæŠ—å¼±<br>é«˜æª”æ——å‹<br>ä»¥ç›¤ä»£è·Œ</div>
                                    </div>
                                    <div class="w-1/3 px-1">
                                        <div class="font-bold text-red-600 mb-1">â‘¢ å¼·è»‹ç©º</div>
                                        <div class="text-[9px]">æŠµæŠ—å¤±æ•—<br>ä¸å›é ­<br>ç›´æ¥å™´å‡º</div>
                                    </div>
                                </div>
                                <div class="mt-2 text-left w-full space-y-1">
                                     <p>â‘  <span class="font-bold text-orange-600">ç›¤å …ç›¤ (Accumulation)ï¼š</span> å›æª”è¼ƒæ·±ï¼Œé»‘Kåå™¬ç´…æ£’ï¼Œä½†<span class="bg-orange-100 px-1 rounded font-bold">å®ˆä½è»‹ç©ºä½</span>ã€‚ç­–ç•¥ï¼šè€å¿ƒç­‰å¾…ã€‚</p>
                                     <p>â‘¡ <span class="font-bold text-blue-600">è»‹ç©ºç›¤ (Squeeze)ï¼š</span> é«˜æª”æ•´ç†ï¼Œ<span class="bg-blue-100 px-1 rounded font-bold">ç©ºé ­æŠµæŠ—</span>å‡ºç¾ä½†å®ˆä½æ˜¨æ—¥é«˜é»ã€‚ç­–ç•¥ï¼šçºŒæŠ±çœ‹ä¸€é£½ã€‚</p>
                                     <p>â‘¢ <span class="font-bold text-red-600">å¼·è»‹ç©º (Super Squeeze)ï¼š</span> <span class="bg-red-100 px-1 rounded font-bold">ç©ºé ­æŠµæŠ—å¤±æ•—</span>(ç´…æ¡†è™•)ï¼Œéš”æ—¥é–‹é«˜èµ°é«˜ã€‚ç­–ç•¥ï¼šæ­»æŠ±çœ‹äº”å€ã€‚</p>
                                </div>
                            </div>
                        </div>

                        <!-- ç©ºæ–¹ç›¤æ…‹èªªæ˜ (Updated) -->
                        <div class="border-t border-slate-200 pt-2">
                            <p class="font-bold bg-green-100 text-green-800 px-1 rounded inline-block mb-1">ğŸ“‰ ç©ºæ–¹è¶¨å‹¢ (Bearish)</p>
                            <ul class="space-y-2 ml-1">
                                <li>
                                    <span class="font-bold text-green-700">â‘  å¼·æ®ºå¤šï¼š</span>è·³ç©ºå‘ä¸‹ï¼Œé€£é»‘Kï¼Œå®Œå…¨ç„¡åå½ˆã€‚<br>
                                    <span class="text-slate-500">â†’ ç­–ç•¥ï¼šçµ•å°ä¸æ¥åˆ€ï¼Œåå½ˆå°±æ˜¯ç©ºã€‚</span>
                                </li>
                                <li>
                                    <span class="font-bold text-green-600">â‘¡ æ®ºå¤šç›¤ï¼š</span>å¼±å‹¢æ•´ç†å†ç ´åº•ã€‚<br>
                                    <span class="text-slate-500">â†’ ç­–ç•¥ï¼šåˆ©ç”¨åå½ˆé€ƒå‘½ï¼Œç©ºæ–¹çºŒæŠ±ã€‚</span>
                                </li>
                                <li><span class="font-bold text-slate-600">â‘¢ ç›¤è·Œç›¤ï¼š</span>è·Œç ´å¾Œåå½ˆæ·±(å‡çªç ´å›é ¸ç·š)ï¼Œéš¨å¾Œå†æ®ºã€‚<br>
                                    <span class="text-slate-500">â†’ ç­–ç•¥ï¼šå€é–“æ“ä½œï¼Œåš´è¨­åœæã€‚</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </details>
                
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">ç¬¬ä¸‰ç¯‡ï¼šå¯¦æˆ°èˆ‡é›¢å ´ (SOP)</div>

                <details class="group border border-green-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-green-800 bg-green-50 p-3">
                        <span>6. æ”»æ“Šç¯‡ï¼šNå­—æ¸¬å¹… (æ‰‹ç¨¿å…¬å¼)</span>
                        <span class="text-green-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p>åƒæ•¸ï¼š<span class="font-bold text-red-600">h2 (ä»Šæ—¥æœ€é«˜)</span>ï¼Œ<span class="font-bold text-green-600">L (å‰ä¸‰ä½)</span></p>
                        <div class="bg-green-50 p-2 rounded border border-green-100 font-mono">
                            <p>â— <span class="font-bold">ä¸€é£½ (1N)ï¼š</span> h2 Ã— 2 - L (åŸºæœ¬æ»¿è¶³)</p>
                            <p>â— <span class="font-bold">äºŒå (2N)ï¼š</span> ä¸€é£½ + (h2 - L) (å¼·å‹¢é£†è‚¡)</p>
                            <p>â— <span class="font-bold">äº”å€ (5x)ï¼š</span> h2 + 5 Ã— (h2 - L) (æ‘ºç–Šç¿»ç®±)</p>
                        </div>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>7. é€²éšç¯‡ï¼šé•·ç´…éš”æ—¥å¼·å¼±åˆ¤å®š</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold">çªç ´å¸¶é‡é•·ç´…æ£’ï¼Œéš”æ—¥èµ°å‹¢è‡³é—œé‡è¦ï¼š</p>
                        <ol class="list-decimal list-inside space-y-1 ml-1">
                            <li><span class="font-bold text-red-600">ç¹¼çºŒæ¼²ï¼š</span> å¼·å‹¢ (Strong)ã€‚</li>
                            <li><span class="font-bold text-red-500">ä¸ç ´ 1/3ï¼š</span> æ¬¡å¼· (Normal)ã€‚</li>
                            <li><span class="font-bold text-orange-500">ä¸ç ´ 1/2ï¼š</span> æ¬¡æ¬¡å¼· (Weak but Hold)ã€‚</li>
                            <li><span class="font-bold text-gray-500">è·Œç ´ 1/2 æˆ–ä½é»ï¼š</span> å‡çªç ´ (False Breakout)ã€‚</li>
                        </ol>
                    </div>
                </details>
                
                <details class="group border border-red-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-red-800 bg-red-50 p-3">
                        <span>8. é›¢å ´ç¯‡ï¼šä¸–ç´€é‹¼ (9958) è³£è¨Š</span>
                        <span class="text-red-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-700">è³£å‡ºä¸‰éƒ¨æ›² (ä¸–ç´€é‹¼æ•™è¨“)ï¼š</p>
                        <ol class="list-decimal list-inside ml-1">
                            <li><span class="font-bold">è¶¨å‹¢è½‰å¼±ï¼š</span>å‡ç·š (EMA 8/21/55) ä¸Šæ¼²è®Šç·©æˆ–èµ°å¹³ã€‚</li>
                            <li><span class="font-bold">çµæ§‹è·Œç ´ï¼š</span>ä¸‰ç›¤è·Œç ´ + è·Œç ´æ‰€æœ‰å‡ç·šã€‚</li>
                            <li><span class="font-bold">æŒ‡æ¨™ç¢ºèªï¼š</span>è½å°¾æ—¥è½ + å¯¶å¡”ç¿»ç¶ ã€‚</li>
                        </ol>
                        <p class="bg-red-50 p-1 text-center font-bold text-red-900 mt-1">çµè«–ï¼šå¤šé ­å·²æ­»ï¼Œæœæ–·æ›è‚¡ï¼</p>
                    </div>
                </details>
                
                <!-- è¼¸å…¥æŒ‡å— -->
                 <details class="group border border-gray-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-gray-800 bg-gray-50 p-3">
                        <span>9. SOPï¼šç›¤ä¸­è¼¸å…¥æŒ‡å—</span>
                        <span class="text-gray-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white">
                        æ”¶ç›¤åƒ¹(è·³å‹•åƒ¹)ã€ä»Šæ—¥æœ€é«˜(ç®—ç›®æ¨™)ã€è»‹ç©ºä½(ç¿»ç´…æ—¥ä½)ã€å‰ä¸‰é«˜/ä½(æ˜¨å‰å¤§å‰)
                    </div>
                </details>

                <!-- NEW: é åˆ¤æ•™å­¸ -->
                <details class="group border border-sky-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-sky-800 bg-sky-50 p-3">
                        <span>10. é åˆ¤ç¯‡ï¼šå¦‚ä½•æ¨¡æ“¬æœªä¾†èµ°å‹¢ï¼Ÿ</span>
                        <span class="text-sky-500 transition-transform group-open:rotate-180">â–¼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-600 border-b border-sky-100 pb-1">Q: æ€éº¼é æ¸¬æ˜å¤©ï¼Ÿ(æ¨¡æ“¬æˆ°æƒ…å®¤ç”¨æ³•)</p>
                        <ol class="list-decimal list-inside ml-1 space-y-2">
                            <li><span class="font-bold bg-blue-100 text-blue-800 px-1 rounded">æƒ…å¢ƒæŒ‰éˆ• (æ–°æ‰‹)ï¼š</span>
                                <div class="pl-4 text-slate-500 mt-1">
                                    ä¸Šæ–¹è—è‰²å€å¡Šçš„æŒ‰éˆ• (å¦‚ï¼šæ¨¡æ“¬æ¥µå¼·)ï¼Œæ˜¯<span class="bg-yellow-100 text-slate-800 px-1">ç³»çµ±è‡ªå‹•å¡«å…¥å‡æ•¸æ“š</span>ï¼ŒæŒ‰ä¸‹å»å¾Œè«‹ç›´æ¥çœ‹æœ€ä¸‹æ–¹çš„ã€Œåˆ†æçµæœã€ï¼Œè®“ä½ ç·´ç¿’ã€Œçœ‹åˆ°é€™ç¨®æ•¸æ“šè©²æ€éº¼åšã€ã€‚
                                </div>
                            </li>
                            <li><span class="font-bold bg-slate-800 text-white px-1 rounded">æ‰‹å‹•é æ¼” (è€æ‰‹)ï¼š</span>
                                <ul class="list-none list-inside pl-4 text-slate-600 mt-1 space-y-1">
                                    <li>â‘  å¡«å…¥çœŸå¯¦çš„ <span class="font-bold">å‰ä¸‰é«˜ã€å‰ä¸‰ä½ã€å‡é‡</span> (é€™æ˜¯å·²çŸ¥æ­·å²)ã€‚</li>
                                    <li>â‘¡ æ›´æ”¹ <span class="text-blue-700 font-bold">ç›®å‰åƒ¹</span> (è¼¸å…¥ï¼šä½ å‡è¨­æ˜å¤©æœƒæ¼²åˆ°çš„åƒ¹æ ¼)ã€‚</li>
                                    <li>â‘¢ æ›´æ”¹ <span class="text-purple-700 font-bold">æˆäº¤é‡</span> (è¼¸å…¥ï¼šä½ é ä¼°æ˜å¤©çš„é‡)ã€‚</li>
                                    <li>â‘£ æŒ‰ä¸‹é»‘è‰² <span class="font-bold bg-black text-white px-1 text-[10px] rounded">åŸ·è¡Œå¯¦æˆ°æ¨æ¼”</span> æŒ‰éˆ•ã€‚</li>
                                </ul>
                                <p class="text-center text-red-600 font-bold mt-1 bg-red-50 p-1">ğŸ’¡ çµè«–ï¼šåˆ©ç”¨å‡æƒ³çš„æ˜å¾Œå¤©åƒ¹æ ¼ï¼Œå…ˆç®—å‡ºä¸‹ä¸€æ­¥ç­–ç•¥ï¼</p>
                            </li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>

        <div class="p-6 space-y-5 relative z-0">
            
            <!-- æ¨¡æ“¬æˆ°æƒ…å®¤ (New) -->
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <h3 class="text-xs font-black text-blue-900 mb-2 flex items-center">
                    ğŸ® æ¨¡æ“¬æˆ°æƒ…å®¤ (å¿«é€Ÿæ¼”ç¿’)
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="simulate('strong')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        ğŸš€ æ¨¡æ“¬æ¥µå¼·
                    </button>
                    <button onclick="simulate('break')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        ğŸ”¥ æ¨¡æ“¬çªç ´
                    </button>
                    <button onclick="simulate('crash')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        ğŸ’€ æ¨¡æ“¬å¤§è·Œ
                    </button>
                    <button onclick="simulate('flat')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        â– æ¨¡æ“¬ç›¤æ•´
                    </button>
                </div>
            </div>
            
            <!-- 0. è‚¡ç¥¨ä»£ç¢¼ -->
            <div>
                <label class="block text-slate-700 font-bold mb-1 text-sm">è‚¡ç¥¨åç¨±/ä»£è™Ÿ</label>
                <input type="text" id="stockName" class="w-full p-2 border-2 border-slate-200 rounded focus:ring-2 focus:ring-slate-500 font-bold placeholder-slate-300 transition-colors" placeholder="ä¾‹å¦‚ï¼šä¸–ç´€é‹¼ (9958)">
            </div>

            <!-- 1. ç‹€æ…‹é¸æ“‡ -->
            <div>
                <label class="block text-slate-700 font-bold mb-2 text-sm">1. ç›®å‰å¯¶å¡”ç·šé¡è‰² (ç‹€æ…‹)</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setStatus('GREEN')" id="btn-green" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100">
                        ğŸŸ© ç¶ è‰² (ç©ºæ‰‹/ç›¤æ•´)
                    </button>
                    <button onclick="setStatus('RED')" id="btn-red" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60">
                        ğŸŸ¥ ç´…è‰² (æŒæœ‰/å¤šæ–¹)
                    </button>
                </div>
                <input type="hidden" id="currentStatus" value="GREEN">
            </div>

            <!-- 2. æ ¸å¿ƒåƒ¹æ ¼ -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-blue-600 pl-2">æ ¸å¿ƒåƒ¹æ ¼ (Price Action)</h3>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-blue-900 font-bold mb-1 text-xs">ç›®å‰åƒ¹ (Current)</label>
                            <input type="number" step="0.01" id="closePrice" class="w-full p-2 border-2 border-blue-200 rounded focus:ring-blue-500 text-lg font-mono font-bold text-blue-900" placeholder="è·³å‹•åƒ¹">
                        </div>
                        <div>
                            <label class="block text-red-700 font-bold mb-1 text-xs">ä»Šæ—¥æœ€é«˜ <span class="bg-red-100 px-1 rounded">h2</span></label>
                            <input type="number" step="0.01" id="todayHigh" class="w-full p-2 border-2 border-red-200 rounded focus:ring-red-500 text-lg font-mono font-bold text-red-700" placeholder="å‹•æ…‹æ¸¬å¹…ç”¨">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">å‰ä¸‰é«˜ (é ¸ç·š)</label>
                        <input type="number" step="0.01" id="high3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="æ˜¨/å‰/å¤§å‰">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">å‰ä¸‰ä½ (L)</label>
                        <input type="number" step="0.01" id="low3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="æ˜¨/å‰/å¤§å‰">
                    </div>
                    
                    <!-- è»‹ç©ºä½æ¬„ä½ -->
                    <div class="col-span-2 bg-red-50 p-3 rounded-lg border-2 border-red-300 mt-2 relative overflow-hidden shadow-sm ring-2 ring-red-100">
                         <div class="absolute right-0 top-0 text-[60px] opacity-10 pointer-events-none transform rotate-12">ğŸ›¡ï¸</div>
                         <div class="flex justify-between items-center mb-1">
                             <label class="block text-purple-900 font-black mb-1 text-sm">â˜… è»‹ç©ºä½ (ç¿»ç´…Kæ£’æœ€ä½é»)</label>
                             <button onclick="toggleEncyclopedia()" class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded hover:bg-red-700 cursor-pointer shadow">â“ å¡«å“ªä¸€å¤©ï¼Ÿ</button>
                         </div>
                        <input type="number" step="0.01" id="breakoutLow" class="w-full p-2 border-2 border-purple-300 rounded font-mono text-lg text-purple-900 font-bold bg-white focus:ring-2 focus:ring-purple-500" placeholder="ç›®æ¨™åƒ¹ç”Ÿå­˜ç·š">
                        
                        <div class="mt-2 space-y-1 text-[11px] font-bold text-slate-600 bg-white/60 p-2 rounded border border-red-100">
                            <p>ğŸ‘‰ <span class="text-red-700">è‹¥ä»Šæ—¥å‰›çªç ´ï¼š</span>å¡«ã€Œä»Šå¤©ç›¤ä¸­ã€æœ€ä½é»ã€‚</p>
                            <p>ğŸ‘‰ <span class="text-green-700">è‹¥å·²æŒæœ‰çºŒæŠ±ï¼š</span>å¡«ã€Œç•¶åˆè²·é€²é‚£å¤©ã€æœ€ä½é»ã€‚</p>
                            <p class="text-red-500 mt-1 border-t border-red-100 pt-1 flex items-center"><span class="text-lg mr-1">âš¡</span> è·Œç ´æ­¤åƒ¹ = æ”»æ“Šå¤±æ•— (ç›®æ¨™æŠµéŠ·)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. æˆäº¤é‡ -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-purple-600 pl-2">æˆäº¤é‡çµæ§‹ (Volume)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-purple-900 font-bold mb-1 text-xs">ä»Šæ—¥æˆäº¤é‡ (Today Vol)</label>
                        <input type="number" id="todayVol" class="w-full p-2 border-2 border-purple-200 rounded focus:ring-purple-500 font-mono text-lg font-bold text-purple-900" placeholder="é ä¼°é‡">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">éå»ä¸‰æ—¥å‡é‡ (Avg Vol)</label>
                        <input type="number" id="avgVol" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="è¼¸å…¥5Tæ•¸å€¼">
                    </div>
                </div>
            </div>

            <!-- 4. å¼·å‹¢è‚¡åˆ¤å®šåƒæ•¸ (å«é•·ç´…å¼·å¼±åˆ¤å®š) -->
            <div id="advancedInputs" class="hidden bg-indigo-50 p-3 rounded-lg mt-4 border border-indigo-100">
                <h3 class="text-sm font-black text-indigo-900 mb-2">â˜… ç›¤æ…‹å¼·å¼±åˆ¤å®šåƒæ•¸ (é¸å¡«)</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">æ˜¨æ—¥æ”¶ç›¤</label>
                        <input type="number" id="prevClose" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="æ˜¨æ”¶">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">ä»Šæ—¥æœ€ä½</label>
                        <input type="number" id="todayLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="ä»Šä½">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">æ˜¨æ—¥æœ€ä½</label>
                        <input type="number" id="prevLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="æ˜¨ä½">
                    </div>
                    <div class="col-span-3 mt-1 pt-2 border-t border-indigo-200">
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">æ˜¨æ—¥é•·ç´…ä½é» (ç”¨æ–¼éš”æ—¥å¼·å¼±åˆ¤å®š)</label>
                        <input type="number" id="prevLongRedLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="è‹¥æ˜¨æ—¥æ”¶é»‘å‰‡å…å¡«">
                    </div>
                </div>
            </div>

            <!-- è³£å‡ºæª¢æ ¸ -->
            <div id="sellChecklist" class="hidden bg-red-50 p-3 rounded border-2 border-red-200 mt-3">
                <h4 class="font-bold text-red-800 text-xs mb-2 flex items-center">ğŸ“‰ æ›è‚¡æ“ä½œæª¢æ ¸</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkTrend" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">å‡ç·šä¸Šæ¼²è¶¨å‹¢ç·©</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkMA" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">ä¸‰ç›¤è·Œç ´æ‰€æœ‰å‡ç·š</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkSunset" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">è½å°¾æ—¥è½ & å¯¶å¡”ç¿»ç¶ </span>
                    </label>
                </div>
                <div id="sellAdvice" class="hidden mt-2 p-3 bg-red-600 text-white text-sm font-black rounded text-center animate-pulse shadow-lg transform scale-105">
                    ğŸš¨ æ¢ä»¶æˆç«‹ï¼šæ”¶å›è³‡é‡‘ï¼Œæ›è‚¡æ“ä½œï¼
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ•å€ -->
            <div class="grid grid-cols-5 gap-2 mt-4">
                <button onclick="calculateStrategy()" class="col-span-3 bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-lg tracking-widest border border-slate-700">
                    åŸ·è¡Œå¯¦æˆ°æ¨æ¼”
                </button>
                <button onclick="clearInputs()" class="col-span-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl shadow-md transition-all active:scale-95 text-base border border-gray-300 flex items-center justify-center">
                    ğŸ”„ æ¸…é™¤é‡ç½®
                </button>
            </div>

            <!-- çµæœé¡¯ç¤ºå€ -->
            <div id="resultArea" class="hidden fade-in mt-4 pb-10">
                <div id="resultBox" class="p-5 rounded-xl border-l-8 shadow-md bg-white relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span id="stockBadge" class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded font-bold mb-1 inline-block"></span>
                                <h2 id="resultTitle" class="text-xl font-black leading-tight"></h2>
                            </div>
                            <span id="resultIcon" class="text-3xl"></span>
                        </div>

                        <div class="mb-3 flex flex-wrap gap-2">
                            <span id="trendTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="volTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="patternTag" class="hidden text-xs font-bold px-2 py-1 rounded border"></span>
                        </div>
                        
                        <p id="resultAction" class="text-2xl font-black mb-3 border-b pb-2"></p>
                        
                        <!-- Nå­—æ¸¬å¹…ç›®æ¨™å€ -->
                        <div id="targetBox" class="hidden bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm transition-all">
                            <h5 id="targetHeader" class="font-bold text-green-800 border-b border-green-200 pb-1 mb-2 flex justify-between">
                                <span>ğŸ¯ å‹•æ…‹æ¸¬å¹…ç›®æ¨™ (h2=<span id="valH2"></span>, L=<span id="valL"></span>)</span>
                                <span id="targetStatusBadge" class="text-[10px] bg-green-200 px-1 rounded text-green-800">Active</span>
                            </h5>
                            <div id="targetList" class="space-y-1 font-mono text-slate-700">
                                <div class="flex justify-between">
                                    <span>ä¸€é£½ (1N)ï¼š</span>
                                    <span class="font-bold text-green-700" id="target1"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>äºŒå (2N)ï¼š</span>
                                    <span class="font-bold text-green-700" id="target2"></span>
                                </div>
                                <div class="flex justify-between bg-green-100 -mx-1 px-1 rounded">
                                    <span class="font-bold text-purple-700">äº”å€ (5N)ï¼š</span>
                                    <span class="font-bold text-purple-700" id="target5"></span>
                                </div>
                            </div>
                            <div id="targetInvalidMsg" class="hidden mt-2 text-center bg-gray-200 text-gray-500 font-bold py-1 rounded text-xs border border-gray-300">
                                âŒ è·Œç ´è»‹ç©ºä½ï¼Œç›®æ¨™å·²æŠµéŠ·
                            </div>
                        </div>

                        <div id="inferenceBox" class="hidden bg-slate-50 p-2 rounded border border-slate-200 mb-3 text-xs font-mono text-slate-600"></div>

                        <div class="bg-white/60 p-3 rounded border border-slate-200 mb-4 backdrop-blur-sm shadow-sm">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">â˜… æˆ°è¡“æŒ‡å¼• (Tactical Advice)</p>
                            <p id="resultAdvice" class="text-sm text-slate-800 font-medium leading-relaxed"></p>
                        </div>
                        
                        <div id="aiAnalysisBox" class="hidden mt-3 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-slate-700 shadow-inner relative">
                            <div class="absolute top-0 right-0 p-1 opacity-20 text-4xl">ğŸ¤–</div>
                            <h4 id="aiReportTitle" class="font-black text-indigo-900 mb-2 border-b border-indigo-200 pb-1 flex items-center">
                                ğŸ§  çŸ³é ­æˆ°ç•¥åˆ†æå ±å‘Š
                            </h4>
                            <div id="aiContent" class="ai-content">
                                <!-- AI Content will be injected here -->
                            </div>
                            <div id="aiLoading" class="hidden flex flex-col items-center justify-center py-4">
                                <div class="dot-flashing"></div>
                                <p class="text-xs text-indigo-400 mt-3 animate-pulse">æ­£åœ¨è§£è®€ç›¤å‹¢å¿ƒç†...</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-2">
                             <button onclick="copyReport()" id="copyBtn" class="flex items-center justify-center space-x-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg transition-colors text-sm border border-slate-300 shadow-sm">
                                <span>ğŸ“‹ è¤‡è£½å®Œæ•´æˆ°å ±</span>
                            </button>
                            <button onclick="playAudioReport()" id="ttsBtn" class="flex items-center justify-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-sm border border-indigo-700 shadow-sm disabled:opacity-50">
                                <span id="ttsIcon">âœ¨</span>
                                <span id="ttsText">æ’­æ”¾èªéŸ³æŒ‡æ®å®˜</span>
                                <div id="audioWave" class="hidden audio-wave ml-2">
                                    <div class="bar"></div><div class="bar"></div><div class="bar"></div>
                                </div>
                            </button>
                        </div>

                        <!-- Chat Section -->
                        <div id="aiChatSection" class="hidden mt-4 pt-4 border-t border-slate-200">
                             <h4 class="font-black text-slate-700 mb-2 flex items-center text-sm">
                                âœ¨ AI æˆ°ç•¥æ•™ç·´å•ç­”å®¤
                            </h4>
                            <div id="chatHistory" class="bg-slate-50 border border-slate-200 rounded-lg p-3 h-40 overflow-y-auto mb-2 text-xs space-y-2">
                                <div class="text-center text-slate-400 italic">è«‹åœ¨ä¸‹æ–¹è¼¸å…¥å•é¡Œï¼Œæ•™ç·´å°‡åŸºæ–¼ä¸Šè¿°ç›¤å‹¢æ•¸æ“šå›ç­”...</div>
                            </div>
                            <div class="flex space-x-2">
                                <input type="text" id="chatInput" class="flex-1 p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ˜å¤©å¦‚æœé–‹é«˜æ€éº¼åšï¼Ÿ" onkeypress="if(event.key==='Enter') askCoach()">
                                <button onclick="askCoach()" class="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold hover:bg-slate-900 transition-colors">ç™¼é€</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- API Key è¨­å®šå€ (é¸ç”¨) -->
            <details class="group mt-4 bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                <summary class="flex justify-between items-center font-bold text-gray-700 p-3 cursor-pointer hover:bg-gray-100">
                    <span>âš™ï¸ è¨­å®š API Key (é¸ç”¨ï¼šè§£é– AI åŠŸèƒ½)</span>
                    <span class="text-gray-400 transition-transform group-open:rotate-180">â–¼</span>
                </summary>
                <div class="p-3 bg-white">
                    <p class="text-xs text-gray-500 mb-2">æœ¬ç³»çµ±å·²å…§å»ºã€ŒçŸ³é ­æˆ°ç•¥é‚è¼¯åº«ã€ï¼Œä¸éœ€ Key ä¹Ÿèƒ½ç”¢å‡ºå®Œæ•´å ±å‘Šï¼<br>
                    <span class="text-indigo-600 font-bold">âœ¨ è‹¥éœ€å•Ÿç”¨ã€ŒèªéŸ³æˆ°å ±ã€èˆ‡ã€Œæ•™ç·´å•ç­”ã€ï¼Œè«‹å¡«å…¥ Gemini API Keyã€‚</span></p>
                    <input type="password" id="userApiKey" class="w-full p-2 border border-gray-300 rounded text-sm mb-2" placeholder="è²¼ä¸Š API Key (é¸å¡«)">
                    <button onclick="saveApiKey()" class="bg-gray-800 text-white text-xs px-3 py-1.5 rounded hover:bg-gray-900 transition-colors w-full">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </details>

        </div>
    </div>

    <script>
        const apiKey = ""; // Keep empty for local usage logic
        let baseReportText = "";
        let aiReportContent = "";
        let lastStockName = "";
        let globalContext = {}; // Store current analysis context for chatbot

        // åˆå§‹åŒ–ï¼šè®€å–å„²å­˜çš„ API Key
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('userApiKey').value = savedKey;
            }
        });
        
        // --- æ ¸å¿ƒè¤‡è£½åŠŸèƒ½ (V12.9.1 iOS ä¿®æ­£ç‰ˆ) ---
        async function copyReport() {
            if (!baseReportText) {
                alert("è«‹å…ˆåŸ·è¡Œé‹ç®—ä»¥ç”Ÿæˆæˆ°å ±ï¼");
                return;
            }

            let fullReport = baseReportText;
            if (aiReportContent) {
                fullReport += `\n\nä¸‰ã€ğŸ§  çŸ³é ­æˆ°ç•¥ (${document.getElementById('stockName').value}) åˆ†æå ±å‘Š\n${aiReportContent}`;
            }

            // å˜—è©¦æ–¹æ³• 1: ç¾ä»£ API (navigator.clipboard) - å„ªå…ˆä½¿ç”¨
            try {
                await navigator.clipboard.writeText(fullReport);
                showCopySuccess();
                return; // æˆåŠŸå°±çµæŸ
            } catch (err) {
                console.warn('Clipboard API failed, trying fallback...', err);
            }

            // å˜—è©¦æ–¹æ³• 2: Legacy execCommand (é‡å° iOS å„ªåŒ–)
            const textarea = document.createElement('textarea');
            textarea.value = fullReport;
            textarea.style.position = 'fixed'; 
            textarea.style.bottom = '0';
            textarea.style.left = '0';
            textarea.style.width = '2em';
            textarea.style.height = '2em';
            textarea.style.padding = '0';
            textarea.style.border = 'none';
            textarea.style.outline = 'none';
            textarea.style.boxShadow = 'none';
            textarea.style.background = 'transparent';
            textarea.setAttribute('readonly', '');
            document.body.appendChild(textarea);

            if (navigator.userAgent.match(/ipad|iphone/i)) {
                const range = document.createRange();
                range.selectNodeContents(textarea); 
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textarea.setSelectionRange(0, 999999);
            } else {
                textarea.select();
            }

            try {
                const successful = document.execCommand('copy');
                if (successful) showCopySuccess();
                else alert('è¤‡è£½å¤±æ•—ï¼Œè«‹é•·æŒ‰æ–‡å­—æ‰‹å‹•è¤‡è£½');
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼Œç€è¦½å™¨ä¸æ”¯æ´');
            }

            document.body.removeChild(textarea);
        }

        function showCopySuccess() {
           const btn = document.getElementById('copyBtn');
           const originalText = btn.innerHTML;
           btn.innerHTML = '<span class="text-green-600">âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼</span>';
           setTimeout(() => btn.innerHTML = originalText, 2000);
        }
        
        window.copyReport = copyReport;

        function saveApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert("âœ… API Key å·²å„²å­˜ï¼å·²å•Ÿç”¨å¢å¼·ç‰ˆ AI åˆ†æã€èªéŸ³æˆ°å ±èˆ‡æ•™ç·´å•ç­”åŠŸèƒ½ã€‚");
            } else {
                localStorage.removeItem('gemini_api_key');
                alert("âš ï¸ API Key å·²æ¸…é™¤ï¼Œå°‡åˆ‡æ›å›å…§å»ºæˆ°ç•¥é‚è¼¯åº«ã€‚");
            }
        }

        function simulate(type) {
            clearInputs(false); 
            document.getElementById('stockName').value = "æ¨¡æ“¬å€‹è‚¡ (TEST)";
            document.getElementById('high3d').value = 100;
            document.getElementById('low3d').value = 90;
            document.getElementById('avgVol').value = 1000;
            
            if (type === 'strong') {
                setStatus('RED');
                document.getElementById('closePrice').value = 108;
                document.getElementById('todayHigh').value = 108; 
                document.getElementById('breakoutLow').value = 98; 
                document.getElementById('todayVol').value = 2000;
                document.getElementById('prevClose').value = 104;
                document.getElementById('todayLow').value = 105;
                document.getElementById('prevLow').value = 102;
            } else if (type === 'break') {
                setStatus('GREEN');
                document.getElementById('closePrice').value = 102;
                document.getElementById('todayHigh').value = 103;
                document.getElementById('breakoutLow').value = 101; 
                document.getElementById('todayVol').value = 1500;
            } else if (type === 'crash') {
                setStatus('RED'); 
                document.getElementById('closePrice').value = 85; 
                document.getElementById('todayHigh').value = 92;
                document.getElementById('breakoutLow').value = 95; 
                document.getElementById('todayVol').value = 3000;
            } else if (type === 'flat') {
                setStatus('GREEN');
                document.getElementById('closePrice').value = 98; 
                document.getElementById('todayHigh').value = 99;
                document.getElementById('breakoutLow').value = 95;
                document.getElementById('todayVol').value = 600;
            }

            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.classList.remove('highlight-input');
                void input.offsetWidth;
                input.classList.add('highlight-input');
            });
            
            setTimeout(() => {
                calculateStrategy();
                const resultArea = document.getElementById('resultArea');
                resultArea.classList.remove('hidden');
                resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        const checkboxes = document.querySelectorAll('#sellChecklist input[type="checkbox"]');
        const adviceBox = document.getElementById('sellAdvice');
        checkboxes.forEach(chk => {
            chk.addEventListener('change', () => {
                const allChecked = Array.from(checkboxes).every(c => c.checked);
                if (allChecked) adviceBox.classList.remove('hidden');
                else adviceBox.classList.add('hidden');
            });
        });

        function toggleEncyclopedia() {
            const content = document.getElementById('encyclopediaContent');
            content.classList.toggle('hidden');
        }

        function clearInputs(hideResult = true) {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
            document.querySelectorAll('input[type="checkbox"]').forEach(box => box.checked = false);
            adviceBox.classList.add('hidden');
            document.getElementById('aiAnalysisBox').classList.add('hidden');
            document.getElementById('aiContent').innerHTML = '';
            document.getElementById('aiChatSection').classList.add('hidden');
            document.getElementById('chatHistory').innerHTML = '<div class="text-center text-slate-400 italic">è«‹åœ¨ä¸‹æ–¹è¼¸å…¥å•é¡Œï¼Œæ•™ç·´å°‡åŸºæ–¼ä¸Šè¿°ç›¤å‹¢æ•¸æ“šå›ç­”...</div>';
            aiReportContent = ""; 
            if(hideResult) document.getElementById('resultArea').classList.add('hidden');
            setStatus('GREEN');
            if(hideResult) window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        function formatPrice(num) {
            return parseFloat(num).toFixed(2);
        }
        function setStatus(status) {
            document.getElementById('currentStatus').value = status;
            document.getElementById('btn-green').className = status === 'GREEN' ? "py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100" : "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            document.getElementById('btn-red').className = status === 'RED' ? "py-3 px-4 border-2 rounded-lg font-bold transition-all border-red-500 bg-red-50 text-red-700 shadow-inner ring-2 ring-red-100 opacity-100" : "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            
            if(status === 'GREEN') {
                document.getElementById('advancedInputs').classList.add('hidden');
                document.getElementById('sellChecklist').classList.add('hidden');
            } else {
                document.getElementById('advancedInputs').classList.remove('hidden');
                document.getElementById('sellChecklist').classList.remove('hidden');
            }
        }

        function calculateStrategy() {
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-error'));
            document.getElementById('aiAnalysisBox').classList.add('hidden');
            document.getElementById('aiContent').innerHTML = '';
            document.getElementById('aiChatSection').classList.add('hidden');
            aiReportContent = "";

            const stockName = document.getElementById('stockName').value || "æœªè¼¸å…¥è‚¡å";
            const status = document.getElementById('currentStatus').value;
            const close = parseFloat(document.getElementById('closePrice').value);
            const todayH = parseFloat(document.getElementById('todayHigh').value); 
            const high3d = parseFloat(document.getElementById('high3d').value); 
            const L = parseFloat(document.getElementById('low3d').value);   
            const breakoutLow = parseFloat(document.getElementById('breakoutLow').value); 
            const todayVol = parseFloat(document.getElementById('todayVol').value);
            const avgVol = parseFloat(document.getElementById('avgVol').value);
            const isFullSell = Array.from(checkboxes).every(c => c.checked);
            const prevClose = parseFloat(document.getElementById('prevClose').value);
            const todayLow = parseFloat(document.getElementById('todayLow').value);
            const prevLow = parseFloat(document.getElementById('prevLow').value);
            const prevLongRedLow = parseFloat(document.getElementById('prevLongRedLow').value);

            let hasError = false;
            let errorMsg = "è«‹æª¢æŸ¥ç´…æ¡†æ¬„ä½ï¼š\n";
            if (!status) { errorMsg += "- è«‹é¸æ“‡ç›®å‰ç‹€æ…‹\n"; hasError = true; }
            if (isNaN(close)) { document.getElementById('closePrice').classList.add('input-error'); errorMsg += "- è«‹è¼¸å…¥ç›®å‰åƒ¹\n"; hasError = true; }
            if (isNaN(high3d)) { document.getElementById('high3d').classList.add('input-error'); errorMsg += "- è«‹è¼¸å…¥å‰ä¸‰é«˜\n"; hasError = true; }
            if (isNaN(L)) { document.getElementById('low3d').classList.add('input-error'); errorMsg += "- è«‹è¼¸å…¥å‰ä¸‰ä½\n"; hasError = true; }
            if (hasError) { alert(errorMsg); return; }

            let h2 = isNaN(todayH) ? close : todayH; 
            if(h2 < close) h2 = close;
            const gap = h2 - L;
            let target1 = 0, target2 = 0, target5 = 0;
            let targetReport = "";
            let isTargetValid = true;
            if (!isNaN(breakoutLow) && close < breakoutLow) isTargetValid = false; 

            if (gap > 0) {
                target1 = h2 + gap;
                target2 = h2 + (2 * gap);
                target5 = h2 + (5 * gap);
                document.getElementById('valH2').innerText = h2;
                document.getElementById('valL').innerText = L;
                document.getElementById('target1').innerText = formatPrice(target1);
                document.getElementById('target2').innerText = formatPrice(target2);
                document.getElementById('target5').innerText = formatPrice(target5);
                const targetBox = document.getElementById('targetBox');
                targetBox.classList.remove('hidden');
                if (isTargetValid) {
                    targetBox.className = "bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm";
                    document.getElementById('targetList').classList.remove('invalid-target');
                    document.getElementById('targetInvalidMsg').classList.add('hidden');
                    document.getElementById('targetStatusBadge').innerText = "Active";
                    document.getElementById('targetStatusBadge').className = "text-[10px] bg-green-200 px-1 rounded text-green-800";
                } else {
                    targetBox.className = "bg-gray-100 p-3 rounded border border-gray-300 mb-3 text-xs shadow-sm opacity-75";
                    document.getElementById('targetList').classList.add('invalid-target');
                    document.getElementById('targetInvalidMsg').classList.remove('hidden');
                    document.getElementById('targetStatusBadge').innerText = "Invalid";
                    document.getElementById('targetStatusBadge').className = "text-[10px] bg-gray-300 px-1 rounded text-gray-700";
                }
            } else {
                document.getElementById('targetBox').classList.add('hidden');
            }

            let isStrong = false;
            let patternType = ""; 
            let patternClass = "";
            let redCandleAdvice = "";
            let tacticalAdvice = "";
            let trendVerdict = "";
            let marketDesc = "";
            let reportTrend = "";

            if (status === 'RED') {
                if (!isNaN(prevClose) && !isNaN(todayLow) && !isNaN(prevLow)) {
                    if (close > prevClose && todayLow > prevLow) {
                        isStrong = true;
                        patternType = "ğŸ”¥ å¼·è»‹ç©ºç›¤";
                        patternClass = "bg-red-100 text-red-700 border-red-300";
                        tacticalAdvice = "ğŸ”¥ è¶¨å‹¢ï¼šå¤šæ–¹å¼·å‹¢ (å¼·è»‹ç©º)ã€‚\nä¾åœ–ä¸€æ‰€ç¤ºï¼Œç©ºé ­æŠµæŠ—å¤±æ•—ï¼ŒKç·šé€£ç´…ï¼Œå»ºè­°æ­»æŠ±ä¸æ”¾ï¼Œç›®æ¨™çœ‹äº”å€ã€‚";
                        trendVerdict = "ğŸ”¥ å¤šæ–¹å¼·å‹¢ (å¼·è»‹ç©º)";
                        marketDesc = "ç©ºé ­æŠµæŠ—å¤±æ•—ï¼ŒKç·šé€£ç´…ï¼Œå»ºè­°æ­»æŠ±ä¸æ”¾ã€‚";
                    } else if (close >= high3d) {
                        patternType = "ğŸ“ˆ è»‹ç©ºç›¤";
                        patternClass = "bg-blue-100 text-blue-700 border-blue-300";
                        tacticalAdvice = "ğŸ“ˆ è¶¨å‹¢ï¼šå¤šæ–¹æ”»æ“Š (è»‹ç©ºç›¤)ã€‚\nä¾åœ–ä¸€æ‰€ç¤ºï¼Œç©ºé ­æŠµæŠ—å¾®å¼±ï¼Œä»¥ç›¤ä»£è·Œï¼Œå»ºè­°çºŒæŠ±ï¼Œçœ‹ä¸€é£½äºŒåã€‚";
                        trendVerdict = "ğŸ“ˆ å¤šæ–¹æ”»æ“Š (è»‹ç©ºç›¤)";
                        marketDesc = "ç©ºé ­æŠµæŠ—å¾®å¼±ï¼Œä»¥ç›¤ä»£è·Œï¼Œå»ºè­°çºŒæŠ±ã€‚";
                    } else {
                        patternType = "ğŸ¢ ç›¤å …ç›¤";
                        patternClass = "bg-orange-100 text-orange-800 border-orange-300";
                        tacticalAdvice = "ğŸ¢ è¶¨å‹¢ï¼šå¤šæ–¹æ•´ç† (ç›¤å …ç›¤)ã€‚\nä¾åœ–ä¸€æ‰€ç¤ºï¼Œç©ºé ­æŠµæŠ—å¼·çƒˆï¼Œå›æª”è¼ƒæ·±ï¼Œä½†åªè¦ä¸ç ´è»‹ç©ºä½ï¼Œå»ºè­°è€å¿ƒç­‰å¾…ã€‚";
                        trendVerdict = "ğŸ¢ å¤šæ–¹æ•´ç† (ç›¤å …ç›¤)";
                        marketDesc = "ç©ºé ­æŠµæŠ—å¼·çƒˆï¼Œå›æª”æ·±ï¼Œå®ˆä½è»‹ç©ºä½å³å¯ã€‚";
                    }
                } else {
                    if (close > high3d) {
                        patternType = "ğŸ“ˆ è»‹ç©ºç›¤"; 
                        patternClass = "bg-blue-100 text-blue-700 border-blue-300";
                        tacticalAdvice = "ğŸ“ˆ è¶¨å‹¢ï¼šå¤šæ–¹å¼·å‹¢ (è»‹ç©ºç›¤)ã€‚\nå»ºè­°ï¼šå®ˆä½æ˜¨æ—¥é«˜é»ï¼ŒçºŒæŠ±ã€‚";
                        trendVerdict = "ğŸ“ˆ å¤šæ–¹å¼·å‹¢ (è»‹ç©ºç›¤)";
                        marketDesc = "å¤šæ–¹æ§ç›¤ï¼Œå®ˆä½å‰é«˜çºŒæŠ±ã€‚";
                    } else {
                        patternType = "ğŸ¢ ç›¤å …ç›¤";
                        patternClass = "bg-orange-100 text-orange-800 border-orange-300";
                        tacticalAdvice = "ğŸ¢ è¶¨å‹¢ï¼šå¤šæ–¹æ•´ç† (ç›¤å …ç›¤)ã€‚\nå»ºè­°ï¼šå›æª”æ•´ç†ï¼Œåš´å®ˆè»‹ç©ºä½ã€‚";
                        trendVerdict = "ğŸ¢ å¤šæ–¹æ•´ç† (ç›¤å …ç›¤)";
                        marketDesc = "å›æª”æ•´ç†ä¸­ï¼Œåš´å®ˆè»‹ç©ºä½ã€‚";
                    }
                }

                if (!isNaN(prevClose) && !isNaN(prevLongRedLow)) { 
                    let redLen = prevClose - prevLongRedLow;
                    let p1_3 = prevClose - (redLen * 0.33); 
                    let p1_2 = prevClose - (redLen * 0.5);  
                    if (close > prevClose) redCandleAdvice = "å¼·å‹¢çºŒæ¼²";
                    else if (close >= p1_3) redCandleAdvice = "æ¬¡å¼· (å®ˆ1/3)";
                    else if (close >= p1_2) redCandleAdvice = "æ¬¡æ¬¡å¼· (å®ˆ1/2)";
                    else if (close < p1_2 || close < prevLongRedLow) {
                        redCandleAdvice = "è½‰å¼± (ç ´1/2)";
                        patternType = "âš ï¸ ç–‘ä¼¼å‡çªç ´"; 
                        patternClass = "bg-yellow-100 text-yellow-800 border-yellow-300";
                        tacticalAdvice = "âš ï¸ è¶¨å‹¢ï¼šè½‰å¼±ç–‘æ…® (å‡çªç ´)ã€‚\nå»ºè­°ï¼šè·Œç ´é•·ç´…1/2ï¼Œæ”»æ“Šå¤±æ•—é¢¨éšªå¢é«˜ï¼Œå»ºè­°æ¸›ç¢¼è§€å¯Ÿã€‚";
                        trendVerdict = "âš ï¸ è½‰å¼±ç–‘æ…® (å‡çªç ´)";
                        marketDesc = "æ”»æ“Šå¤±æ•—é¢¨éšªå¢é«˜ï¼Œå»ºè­°æ¸›ç¢¼ã€‚";
                    }
                }
                const pTag = document.getElementById('patternTag');
                pTag.innerText = patternType;
                pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                pTag.classList.remove('hidden');
            } else { 
                if(close < L) { 
                      patternType = "ğŸ“‰ ç©ºæ–¹æ®ºå¤š";
                      patternClass = "bg-green-100 text-green-800 border-green-300";
                      tacticalAdvice = "ğŸ“‰ è¶¨å‹¢ï¼šç©ºæ–¹æ®ºå¤šã€‚\nä¾åœ–äºŒæ‰€ç¤ºï¼Œç©ºæ–¹è¶¨å‹¢ç¢ºç«‹ (å¼·æ®ºå¤š/æ®ºå¤šç›¤)ï¼Œåå½ˆä¸éæ®ºå¤šé«˜å°±æ˜¯ç©ºã€‚è‹¥æŒæœ‰ï¼Œè«‹ç«‹åˆ»åœæï¼Œçµ•ä¸æ¥åˆ€ã€‚";
                      trendVerdict = "ğŸ“‰ ç©ºæ–¹æ®ºå¤š";
                      marketDesc = "ç©ºæ–¹è¶¨å‹¢ç¢ºç«‹ï¼Œåå½ˆçš†æ˜¯ç©ºé»ã€‚";
                      const pTag = document.getElementById('patternTag');
                      pTag.innerText = patternType;
                      pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                      pTag.classList.remove('hidden');
                } else {
                      patternType = "ğŸ’¤ ç›¤è·Œ/è§€æœ›";
                      patternClass = "bg-gray-100 text-gray-600 border-gray-300";
                      tacticalAdvice = "ğŸ’¤ è¶¨å‹¢ï¼šç›¤å‹¢ä¸æ˜ (ç›¤è·Œ)ã€‚\nä¾åœ–äºŒæ‰€ç¤ºï¼Œåå½ˆæ·±(å‡çªç ´)ï¼Œéš¨å¾Œå†æ®ºã€‚å»ºè­°å¤šçœ‹å°‘åšï¼Œä¿ç•™ç¾é‡‘ï¼Œç­‰å¾…çªç ´è¨Šè™Ÿã€‚";
                      trendVerdict = "ğŸ’¤ ç›¤å‹¢ä¸æ˜ (ç›¤è·Œ)";
                      marketDesc = "åå½ˆæ·±ä¼¼å‡çªç ´ï¼Œå¤šçœ‹å°‘åšã€‚";
                      const pTag = document.getElementById('patternTag');
                      pTag.innerText = patternType;
                      pTag.className = `text-xs font-bold px-2 py-1 rounded border ${patternClass}`;
                      pTag.classList.remove('hidden');
                }
            }

            let volStatus = "ä¸€èˆ¬";
            let volRatio = 0;
            let inferenceReportText = "";
            let inferenceText = "";
            let scenarioScript = "";
            let v_strong = 0, v_break = 0, v_wash = 0;
            const safeTarget5 = isNaN(target5) || target5 === 0 ? "å¾…è¨ˆç®—" : formatPrice(target5);
            const safeHigh3d = isNaN(high3d) ? "å‰é«˜" : high3d;
            const safeBreakoutLow = isNaN(breakoutLow) ? "é˜²å®ˆé»" : breakoutLow;

            if (!isNaN(avgVol) && avgVol > 0) {
                v_strong = Math.round(avgVol * 1.5);
                v_break = Math.round(avgVol * 1.3);
                v_wash = Math.round(avgVol * 0.8);
                const targetAttackFormatted = formatNumber(Math.round(avgVol * 1.3));
                const targetWashFormatted = formatNumber(Math.round(avgVol * 0.8));
                const isAttack = todayVol >= (avgVol * 1.3) ? "(è¾¾æ¨™) âœ…" : "";
                const isWash = todayVol <= (avgVol * 0.8) ? "(è¾¾æ¨™) âœ…" : "";
                
                inferenceReportText = `â˜… é‡åƒ¹æ¨æ¼” (å‡é‡ ${formatNumber(avgVol)})ï¼š
â€¢ æ”»æ“Šé–€æª» (1.3x)ï¼š${targetAttackFormatted} ${isAttack}
â€¢ æ´—ç›¤é–€æª» (0.8x)ï¼š${targetWashFormatted} ${isWash}`;

                inferenceText = `
                    <div class="bg-slate-50 p-3 rounded border border-slate-300 mb-3 text-xs">
                        <h5 class="font-bold text-slate-700 border-b border-slate-200 pb-1 mb-2">ã€æ˜æ—¥é–‹ç›¤ãƒ»é‡èƒ½ä½œæˆ°åŠ‡æœ¬ã€‘(ä¾å‡é‡ ${formatNumber(avgVol)})</h5>
                        <div class="space-y-2">
                            <div class="bg-red-50 p-2 rounded border border-red-100">
                                <div class="flex justify-between font-bold text-red-800 mb-1">
                                    <span>ğŸ”´ åŠ‡æœ¬ Aï¼šæ¨¡æ“¬æ¥µå¼· (ä¸»åŠ›å¼·æ”»)</span>
                                    <span>> ${formatNumber(v_strong)}å¼µ</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>â— è¡Œç‚ºï¼šè·³ç©ºé–‹é«˜ï¼Œä¸ç ´é–‹ç›¤ï¼Œç›´æ”»æ¼²åœã€‚</p>
                                    <p>â— æŒ‡ä»¤ï¼š<span class="bg-red-600 text-white px-1 rounded font-bold">è¿½åƒ¹ (Buy)</span> ç›®æ¨™ç›´æŒ‡ 5N (${safeTarget5})ã€‚</p>
                                </div>
                            </div>
                            <div class="bg-green-50 p-2 rounded border border-green-100">
                                <div class="flex justify-between font-bold text-green-800 mb-1">
                                    <span>ğŸŸ¢ åŠ‡æœ¬ Bï¼šæ¨¡æ“¬çªç ´ (è¶¨å‹¢å»¶çºŒ)</span>
                                    <span>${formatNumber(v_break)}~${formatNumber(v_strong)}å¼µ</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>â— è¡Œç‚ºï¼šç©©å¥æ¨å‡ï¼Œç¢ºèªçªç ´å‰é«˜ ${safeHigh3d}ã€‚</p>
                                    <p>â— æŒ‡ä»¤ï¼š<span class="bg-green-600 text-white px-1 rounded font-bold">åŠ ç¢¼ (Add)</span> ç¢ºèªéé ¸ç·šå¾Œé€²å ´ã€‚</p>
                                </div>
                            </div>
                            <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                <div class="flex justify-between font-bold text-yellow-800 mb-1">
                                    <span>ğŸŸ¡ åŠ‡æœ¬ Cï¼šæ¨¡æ“¬ç›¤æ•´ (é‡ç¸®æ´—ç›¤)</span>
                                    <span>< ${formatNumber(v_wash)}å¼µ</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>â— è¡Œç‚ºï¼šåƒ¹æ ¼éœ‡ç›ªï¼Œç„¡æ”»æ“Šæ„åœ–ã€‚</p>
                                    <p>â— æŒ‡ä»¤ï¼š<span class="bg-yellow-600 text-white px-1 rounded font-bold">è§€æœ› (Hold)</span> å®ˆä½é˜²å®ˆé»å³å¯ã€‚</p>
                                </div>
                            </div>
                            <div class="bg-gray-100 p-2 rounded border border-gray-300">
                                <div class="flex justify-between font-bold text-gray-800 mb-1">
                                    <span>âš« åŠ‡æœ¬ Dï¼šæ¨¡æ“¬å¤§è·Œ (å‡ºè²¨/å‡çªç ´)</span>
                                    <span>çˆ†é‡ä½†æ”¶é»‘</span>
                                </div>
                                <div class="text-[10px] text-slate-600 space-y-0.5">
                                    <p>â— è¡Œç‚ºï¼šçˆ†é‡ä¸æ¼² (> ${formatNumber(v_break)}å¼µ)ï¼Œæˆ–è·Œç ´ ${safeBreakoutLow}ã€‚</p>
                                    <p>â— æŒ‡ä»¤ï¼š<span class="bg-black text-white px-1 rounded font-bold">å¿«é€ƒ (Sell)</span> ä¸»åŠ›å€’è²¨ï¼Œç„¡æ¢ä»¶é›¢å ´ã€‚</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-white border border-slate-200 rounded shadow-sm">
                            <p class="font-bold text-slate-700 border-b border-slate-100 pb-1 mb-1">ğŸ’¡ çŸ³é ­æˆ°è¡“å°å¡ï¼šå¦‚ä½•è¨ˆç®—ã€Œé ä¼°é‡ã€ï¼Ÿ</p>
                            <p class="text-[10px] text-slate-500">å…¬å¼ï¼š<span class="font-bold text-blue-600">09:15 æˆäº¤é‡ x 8</span> = é ä¼°å…¨æ—¥é‡</p>
                        </div>
                    </div>`;
                
                scenarioScript = `ã€æ˜æ—¥é–‹ç›¤ãƒ»é‡èƒ½ä½œæˆ°åŠ‡æœ¬ã€‘(å‡é‡ ${formatNumber(avgVol)})
ğŸ”´ åŠ‡æœ¬ A (æ¥µå¼·)
é ä¼°é‡ > ${formatNumber(v_strong)} å¼µ (1.5å€â†‘)
â†’ æŒ‡ä»¤ï¼šè¿½åƒ¹ (Buy)ï¼Œç›®æ¨™ç›´æŒ‡ 5N (${safeTarget5})ã€‚
ğŸŸ¢ åŠ‡æœ¬ B (çªç ´)
é ä¼°é‡ ${formatNumber(v_break)} ~ ${formatNumber(v_strong)} å¼µ
â†’ æŒ‡ä»¤ï¼šåŠ ç¢¼ (Add)ï¼Œç¢ºèªçªç ´å‰é«˜ ${safeHigh3d}ã€‚
ğŸŸ¡ åŠ‡æœ¬ C (ç›¤æ•´)
é ä¼°é‡ < ${formatNumber(v_wash)} å¼µ (0.8å€â†“)
â†’ æŒ‡ä»¤ï¼šè§€æœ› (Hold)ï¼Œåš´å®ˆé˜²å®ˆä½ã€‚
âš« åŠ‡æœ¬ D (å¤§è·Œ)
çˆ†é‡ (> ${formatNumber(v_break)}) ä½†æ”¶é»‘æˆ–è·Œç ´ ${safeBreakoutLow}
â†’ æŒ‡ä»¤ï¼šå¿«é€ƒ (Sell)ï¼Œæ­¤ç‚ºä¸»åŠ›å€’è²¨è¨Šè™Ÿã€‚
ğŸ’¡ æˆ°è¡“å°å¡ï¼šé ä¼°é‡ = 09:15 æˆäº¤é‡ x 8`;

                if (!isNaN(todayVol)) {
                    volRatio = todayVol / avgVol;
                    if (volRatio >= 1.5) volStatus = "æ¥µå¼·æ”»æ“Šé‡ (1.5å€â†‘)";
                    else if (volRatio >= 1.3) volStatus = "æ”»æ“Šé‡ (ç´…è²¡ç¥)";
                    else if (volRatio <= 0.8) volStatus = "é‡ç¸®æ•´ç†";
                    else volStatus = "é‡èƒ½æº«å’Œ";
                }
            }

            const resultArea = document.getElementById('resultArea');
            resultArea.classList.remove('hidden');
            const resultBox = document.getElementById('resultBox');
            const rTitle = document.getElementById('resultTitle');
            const rAction = document.getElementById('resultAction');
            const rIcon = document.getElementById('resultIcon');
            const rTrend = document.getElementById('trendTag');
            const rVol = document.getElementById('volTag');
            const rAdvice = document.getElementById('resultAdvice');
            const rStock = document.getElementById('stockBadge');
            const rInference = document.getElementById('inferenceBox');

            let titleText = "", actionText = "", boxClass = "", titleClass = "", actionClass = "", volClass = "";
            volClass = (volRatio >= 1.3) ? "bg-purple-100 text-purple-700 border-purple-300" : (volRatio <= 0.8 ? "bg-blue-100 text-blue-700 border-blue-300" : "bg-slate-100 text-slate-600 border-slate-200");

            if (status === 'GREEN') {
                if (close > high3d) {
                    titleText = "ğŸ”¥ ä¸‰ç›¤çªç ´ (ç¿»ç´…)"; reportTrend = "3. Nå­—èµ·æ¼² (Day 1)"; actionText = "å¸‚åƒ¹è²·é€²";
                    boxClass = "bg-red-50 border-red-500"; titleClass = "text-xl font-bold text-red-600"; actionClass = "text-2xl font-black text-red-700 border-b border-red-200 pb-2 mb-2"; rTrend.className = "text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-700 border border-red-200"; rIcon.innerText = "ğŸš€";
                } else {
                    titleText = "ğŸ’¤ ç›¤æ•´å»¶çºŒ"; actionText = "è§€æœ› (WAIT)";
                    boxClass = "bg-green-50 border-green-500"; titleClass = "text-xl font-bold text-green-700"; actionClass = "text-2xl font-black text-green-800 border-b border-green-200 pb-2 mb-2"; rTrend.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700 border border-green-200"; rIcon.innerText = "ğŸ¢";
                }
            } else {
                if (isFullSell) {
                    titleText = "ğŸš¨ é€ƒå‘½è¨Šè™Ÿ"; actionText = "æ”¶å›è³‡é‡‘ï¼Œæ›è‚¡";
                    boxClass = "bg-red-200 border-red-700"; titleClass = "text-xl font-black text-red-900"; actionClass = "text-2xl font-black text-red-900 border-b border-red-400 pb-2 mb-2"; rIcon.innerText = "ğŸ“‰";
                } else if (close < L) {
                    titleText = "âš ï¸ ä¸‰ç›¤è·Œç ´"; actionText = "ç„¡æ¢ä»¶é›¢å ´";
                    boxClass = "bg-green-100 border-green-600"; titleClass = "text-xl font-bold text-green-900"; actionClass = "text-2xl font-black text-green-900 underline border-b border-green-300 pb-2 mb-2"; rIcon.innerText = "ğŸƒ";
                } else {
                    if (!isTargetValid) {
                        titleText = "âš ï¸ æ”»æ“Šå¤±æ•ˆ"; actionText = "æ¸›ç¢¼è§€æœ›";
                        boxClass = "bg-yellow-50 border-yellow-500"; titleClass = "text-xl font-bold text-yellow-700"; actionClass = "text-2xl font-black text-yellow-800 border-b border-yellow-300 pb-2 mb-2"; rIcon.innerText = "âš ï¸";
                    } else {
                        if(isStrong) { titleText = "ğŸ‚ å¼·è»‹ç©ºç›¤"; actionText = "æ­»æŠ±ä¸æ”¾"; boxClass = "bg-red-100 border-red-600"; titleClass = "text-xl font-bold text-red-700"; actionClass = "text-2xl font-black text-red-800 border-b border-red-300 pb-2 mb-2"; rIcon.innerText = "ğŸ’"; } 
                        else { titleText = "âœ… å¤šé ­çºŒæŠ±"; actionText = "çºŒæŠ± (HOLD)"; boxClass = "bg-orange-50 border-orange-400"; titleClass = "text-xl font-bold text-orange-600"; actionClass = "text-2xl font-black text-orange-700 border-b border-orange-200 pb-2 mb-2"; rIcon.innerText = "âœŠ"; }
                    }
                }
            }

            resultBox.className = `p-5 rounded-xl border-l-8 shadow-md relative overflow-hidden ${boxClass}`;
            rStock.innerText = stockName; rTitle.innerText = titleText; rTitle.className = titleClass;
            rAction.innerText = actionText; rAction.className = actionClass;
            rAdvice.innerText = tacticalAdvice; rTrend.innerText = reportTrend; rVol.innerText = volStatus; rVol.className = `text-xs font-bold px-2 py-1 rounded border ${volClass}`;
            if(inferenceText) { rInference.innerHTML = inferenceText; rInference.classList.remove('hidden'); } else { rInference.classList.add('hidden'); }

            const today = new Date().toLocaleDateString('zh-TW');
            let targetSection = 'ãƒ»ç„¡æ¸¬å¹… (æœªéé ¸ç·š)';
            if (gap > 0) targetSection = `â€¢ ä¸€é£½(1N)ï¼š${formatPrice(target1)}\nâ€¢ äºŒå(2N)ï¼š${formatPrice(target2)}\nâ€¢ äº”å€(5N)ï¼š${formatPrice(target5)}`;

            let volumeCheck = "é‡èƒ½æº«å’Œ";
            if(volRatio >= 1.3) volumeCheck = "æ”»æ“Šé‡èƒ½é”æ¨™ (ç¬¦åˆ1.3å€â†‘)";
            else if (volRatio <= 0.8) volumeCheck = "é‡ç¸®æ´—ç›¤é”æ¨™ (ç¬¦åˆ0.8å€â†“)";

            let nextDayKey = "";
            if(!isNaN(avgVol) && avgVol > 0) {
                 const v_target = Math.round(avgVol * 1.3);
                 nextDayKey = `é—œéµæé†’ï¼šæ˜æ—¥é–‹ç›¤è«‹ç·Šç›¯æˆäº¤é‡ï¼Œè‹¥é ä¼°é‡èƒ½æœªé” ${formatNumber(v_target)} å¼µ (æ”»æ“Šé–€æª»)ï¼Œå‰‡å¼·è»‹ç©ºæ”»å‹¢å¯èƒ½æ¸›å¼±ã€‚`;
            }

            let targetGoal = "å¾…ç¢ºèª";
            if(isStrong) targetGoal = `5N (${formatPrice(target5)})`;
            else if(patternType.includes("è»‹ç©º")) targetGoal = `2N (${formatPrice(target2)})`;
            else if(gap > 0) targetGoal = `1N (${formatPrice(target1)})`;
            
            let safeGuard = `ä¸ç ´è»‹ç©ºä½é» (${breakoutLow})ï¼Œä¸Šè¿°ç›®æ¨™æ‰æœ‰æ•ˆã€‚`;
            if (isNaN(breakoutLow)) safeGuard = "è«‹è¨­å®šè»‹ç©ºä½ä»¥ç¢ºèªé˜²å®ˆé»ã€‚";

            baseReportText = `å—¨ï¼Œæˆ‘æ˜¯çŸ³é ­ï¼Œæˆ‘çš„Nå­—æˆ°æ³•åˆ†æç³»çµ±å¸Œæœ›èƒ½è®“ä½ å¤§å¹…æå‡å‹ç‡
Nå­—æˆ°æ³•æŒ‡æ®ä¸­å¿ƒ by.çŸ³é ­ V13.0 (${today})
è‚¡åï¼š${stockName}

ã€å€‹è‚¡ç¾æ³åˆ†æã€‘
ğŸ“Œ æ“ä½œæŒ‡ä»¤ï¼šã€ ${actionText} ã€‘
âš¡ é‡èƒ½ç‹€æ…‹ï¼š${volStatus}
ğŸ’° ç•¶å‰ç¾åƒ¹ï¼š${close}
ğŸ“ˆ ç›¤å‹¢å‹æ…‹ï¼š${patternType || 'ä¸€èˆ¬ç›¤æ•´'}
âœ… ç›®æ¨™ç›´æŒ‡ï¼š${targetGoal}
âš ï¸ é˜²å®ˆè¦é»ï¼š${safeGuard}
${inferenceReportText}
æœ¬æª”ã€Œ${stockName}ã€${volumeCheck}
ğŸ¯ å‹•æ…‹æ¸¬å¹…åŸºæº– (h2=${h2})
${targetSection}

ã€æ˜æ—¥é–‹ç›¤ãƒ»é‡èƒ½ä½œæˆ°åŠ‡æœ¬ã€‘
${scenarioScript}

â˜… æˆ°è¡“æŒ‡å¼•ï¼š
è¶¨å‹¢åˆ¤å®šï¼š${trendVerdict}
ç›¤å‹¢ç¾ç‹€ï¼š${marketDesc}
${nextDayKey}`;
            
            // å„²å­˜å…¨åŸŸä¸Šä¸‹æ–‡ä¾›èŠå¤©æ©Ÿå™¨äººä½¿ç”¨
            globalContext = {
                stockName, close, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isStrong, patternType, trendVerdict, marketDesc
            };

            triggerAnalysis(stockName, close, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isStrong, patternType);
        }

        async function triggerAnalysis(stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isStrong, patternType) {
            const userKey = localStorage.getItem('gemini_api_key');
            document.getElementById('aiAnalysisBox').classList.remove('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiReportTitle').innerText = `ğŸ§  çŸ³é ­æˆ°ç•¥(${stockName})åˆ†æå ±å‘Š`;

            if (userKey) {
                document.getElementById('aiChatSection').classList.remove('hidden');
                document.getElementById('ttsBtn').disabled = false;
                await askGeminiStrategy(userKey, stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1);
            } else {
                document.getElementById('ttsBtn').disabled = true;
                setTimeout(() => generateLocalAnalysis(isStrong, patternType, status), 800);
            }
        }

        function generateLocalAnalysis(isStrong, patternType, status) {
            document.getElementById('aiLoading').classList.add('hidden');
            let psychology = "", trap = "", mantra = "", conclusion = "";

            if (status === 'RED') {
                if (isStrong) {
                    psychology = "æ ¹æ“šé‡åƒ¹çµæ§‹ï¼Œä¸»åŠ›æ­£é€²è¡Œç©æ¥µæ“ä½œã€‚ç¾åƒ¹ç©©ç«™é ¸ç·šèˆ‡è»‹ç©ºä½é˜²å®ˆé»ï¼Œæˆäº¤é‡æ”¾å¤§é¡¯ç¤ºè³‡é‡‘ç©æ¥µæ¹§å…¥è€Œééœ‡ç›ªã€‚ä¸»åŠ›çš„ç›®çš„åœ¨æ–¼åˆ©ç”¨è²·ç›¤å£“åŠ›è¿«ä½¿ç©ºå–®å›è£œï¼Œç›®å‰è™•æ–¼æ˜ç¢ºçš„é€²è²¨æ‹‰æŠ¬éšæ®µï¼Œç›®æ¨™ç›´æ¥è¡æ“Šç¬¬ä¸€æ¸¬å¹…ï¼Œæ­¤ç‚ºç©æ¥µçš„ç±Œç¢¼é›†ä¸­ï¼Œä¸¦éå‡ºè²¨ã€‚";
                    trap = "åœ¨å¼·è»‹ç©ºè¡Œæƒ…ä¸­ï¼Œæ•£æˆ¶æœ€æ˜“æ‰å…¥å…©å¤§é™·é˜±ï¼š\n1. éæ—©ä¸‹è»Šï¼šæŒæœ‰è€…å› ç„¡æ³•æ‰¿å—æµ®ç›ˆèª˜æƒ‘æˆ–æ“”å¿ƒå›æª”ï¼Œåœ¨æ¥è¿‘ 1N ç›®æ¨™å‰æå‰äº†çµï¼ŒéŒ¯å¤±ä¸»å‡æ®µç²¾è¯ã€‚\n2. è¿½é«˜ææ‡¼ï¼šç©ºæ‰‹è€…å› åƒ¹æ ¼æŒçºŒä¸Šæ”»è€Œææ‡¼ï¼Œç­‰å¾…ä¸æ›¾å‡ºç¾çš„ã€Œå®Œç¾æ‹‰å›é»ã€ï¼Œæœ€å¾Œåœ¨æœ€é«˜é»æƒ…ç·’æ€§é€²å ´ã€‚";
                    mantra = "ã€Œè¶¨å‹¢ç¢ºç«‹ï¼Œæ­»æŠ±æ˜¯åŠŸå¾·ã€‚ã€";
                    conclusion = "â— ç›¤å‹¢å®šèª¿ï¼šè™•æ–¼ã€Œå¼·å‹¢æ”»æ“Šå€ã€ï¼Œå¤šæ–¹æ“æœ‰çµ•å°æ§ç›¤æ¬Šã€‚\nâ— é—œéµæŒ‡æ¨™ï¼šè‹¥é ä¼°é‡èƒ½æŒçºŒæ”¾å¤§ï¼Œä»£è¡¨å¤šé ­å‹•èƒ½çŒ›çƒˆã€‚\nâ— é˜²å®ˆåº•ç·šï¼šåš´å®ˆè»‹ç©ºä½é—œå¡ï¼Œä¸ç ´æ­¤ä½ï¼Œ5N è·¯å¾‘ä¾ç„¶æˆç«‹ã€‚\nâ— æ“ä½œæ ¸å¿ƒï¼šå°æŠ—å°åˆ©å³å®‰çš„å¿ƒæ…‹ï¼Œé–å®š 1N ç›®æ¨™å¾Œå†è€ƒæ…®åˆ†æ‰¹åœåˆ©ã€‚";
                } else if (patternType.includes("è»‹ç©º")) {
                    psychology = "ç›®å‰ä¸»åŠ›æ¡å–ã€Œç©©å¥æ¨å‡ã€ç­–ç•¥ï¼Œé€éç›¤ä¸­éœ‡ç›ªæ¶ˆåŒ–ç²åˆ©äº†çµè³£å£“ã€‚æˆäº¤é‡æº«å’Œæ”¾å¤§ï¼Œé¡¯ç¤ºä¸»åŠ›æ§ç›¤ç©©å®šï¼Œæ„åœ¨æ¸…æ´—æµ®é¡è€Œéæ‹‰é«˜å‡ºè²¨ã€‚";
                    trap = "æ•£æˆ¶å®¹æ˜“å› ç›¤ä¸­éœ‡ç›ªè€Œå¤±å»è€å¿ƒï¼Œèª¤å°‡ä¸»åŠ›æ´—ç›¤è¦–ç‚ºè½‰å¼±è¨Šè™Ÿè€Œææ—©é›¢å ´ã€‚";
                    mantra = "ã€Œè²·åœ¨åˆ†æ­§ï¼ŒæŠ±åœ¨ä¸€è‡´ã€‚ã€";
                    conclusion = "â— ç›¤å‹¢å®šèª¿ï¼šå¤šæ–¹æ¶æ§‹å®Œæ•´ï¼Œå±¬æ–¼æ¨™æº–æ”»æ“Šå‹æ…‹ã€‚\nâ— æ“ä½œæ ¸å¿ƒï¼šçºŒæŠ±ï¼Œç§»å‹•åœæé»è‡³ä»Šæ—¥ä½é»ã€‚";
                } else {
                    psychology = "ä¸»åŠ›ç›®å‰é€²è¡Œé˜²å®ˆå‹æ“ä½œï¼Œé›–æœªç™¼å‹•çŒ›æ”»ï¼Œä½†å …å®ˆé—œéµæ”¯æ’ä½ã€‚æ­¤éšæ®µå¤šç‚ºè“„åŠ›æœŸï¼Œæ¸¬è©¦ä¸‹æ–¹è²·ç›¤æ”¯æ’åŠ›é“ã€‚";
                    trap = "å®¹æ˜“é™·å…¥ã€Œä¸è€ä¹…ç›¤ã€çš„å¿ƒç†ï¼Œåœ¨ç™¼å‹•æ”»æ“Šå‰å¤•å› ç„¡èŠè€Œè³£å‡ºã€‚";
                    mantra = "ã€Œè€å¿ƒæ˜¯äº¤æ˜“è€…çš„ç¾å¾·ã€‚ã€";
                    conclusion = "â— ç›¤å‹¢å®šèª¿ï¼šå¤šæ–¹æ•´ç†ï¼Œç­‰å¾…æ”¾é‡æ”»æ“Šè¨Šè™Ÿã€‚";
                }
            } else {
                psychology = "ç›®å‰ç”±ç©ºæ–¹æŒæ§ç¯€å¥ï¼Œä¸»åŠ›åˆ©ç”¨åå½ˆæ¸¬è©¦å£“åŠ›ä¸¦æ¸›ç¢¼ã€‚ä»»ä½•ä¸Šæ¼²çš†å¯èƒ½ç‚ºèª˜å¤šé™·é˜±ã€‚";
                trap = "æ•£æˆ¶å¸¸èª¤ä»¥ç‚ºè·Œæ·±å³æ˜¯è²·é»ï¼Œè©¦åœ–ã€ŒæŠ„åº•ã€å»æ¥ä½æ‰è½çš„åˆ€å­ã€‚";
                mantra = "ã€Œç©ºé ­ä¸çŒœåº•ï¼Œç¾é‡‘ç‚ºç‹ã€‚ã€";
                conclusion = "â— ç›¤å‹¢å®šèª¿ï¼šç©ºæ–¹è¶¨å‹¢æˆ–ç›¤æ•´åå¼±ã€‚\nâ— æ“ä½œæ ¸å¿ƒï¼šç©ºæ‰‹è§€æœ›ï¼ŒæŒæœ‰è€…åå½ˆæ¸›ç¢¼ã€‚";
            }

            const reportHTML = `
                <div class="space-y-4">
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(ä¸€)ã€ ä¸»åŠ›å¿ƒç†é€è¦–</h5>
                        <p>${psychology}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(äºŒ)ã€ æ•£æˆ¶å¿ƒç†é™·é˜±</h5>
                        <p>${trap.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(ä¸‰)ã€ æ•™ç·´å¿ƒæ³•</h5>
                        <p class="bg-indigo-50 p-2 rounded text-indigo-800 font-bold italic">${mantra}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(å››)ã€ çŸ³é ­æˆ°ç•¥çµè«–</h5>
                        <p>${conclusion.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('aiContent').innerHTML = reportHTML;
            aiReportContent = `(ä¸€)ã€ ä¸»åŠ›å¿ƒç†é€è¦–
${psychology}
(äºŒ)ã€ æ•£æˆ¶å¿ƒç†é™·é˜±
${trap}
(ä¸‰)ã€ æ•™ç·´å¿ƒæ³•
${mantra}
(å››)ã€ çŸ³é ­æˆ°ç•¥çµè«–
${conclusion}`;
        }

        // --- Gemini API Functions ---

        async function askGeminiStrategy(key, stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1) {
            const promptText = `
                ä½ ç¾åœ¨æ˜¯ç²¾é€šã€ŒNå­—æˆ°æ³•ã€çš„è³‡æ·±æ“ç›¤æ‰‹æ•™ç·´ã€‚è«‹æ ¹æ“šä»¥ä¸‹æ•¸æ“šï¼Œç‚ºä½¿ç”¨è€…é€²è¡Œç›¤å‹¢å¿ƒç†åˆ†æèˆ‡æ“ä½œå»ºè­°ã€‚
                
                ã€ç•¶å‰æ•¸æ“šã€‘
                è‚¡åï¼š${stockName}
                ç¾åƒ¹ï¼š${closePrice}
                ç‹€æ…‹ï¼š${status === 'RED' ? 'å¤šæ–¹ (æŒæœ‰/æ”»æ“Š)' : 'ç©ºæ–¹ (è§€æœ›/æ•´ç†)'}
                æˆäº¤é‡ï¼š${todayVol} (å‡é‡: ${avgVol})
                é—œéµåƒ¹ä½ï¼šé ¸ç·š ${high3d}, è»‹ç©ºä½é˜²å®ˆé» ${breakoutLow}
                ç³»çµ±åˆ¤æ–·ï¼š${tacticalAdvice}
                æ¸¬å¹…ç›®æ¨™ï¼šä¸€é£½ ${target1}

                ã€ä»»å‹™è¦æ±‚ã€‘
                è«‹ç”¨ç›´ç™½ã€å°ˆæ¥­ã€ä¸èª‡é£¾çš„èªæ°£ (ç¹é«”ä¸­æ–‡)ï¼Œæä¾›ä»¥ä¸‹åˆ†æ (è«‹ä½¿ç”¨ Markdown æ ¼å¼)ï¼š
                
                è«‹åš´æ ¼ä¾ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼ˆä¸è¦æœ‰é¡å¤–çš„é–‹å ´ç™½ï¼‰ï¼š
                (ä¸€)ã€ ä¸»åŠ›å¿ƒç†é€è¦–
                (å…§å®¹ï¼šæ ¹æ“šé‡åƒ¹çµæ§‹ï¼Œæ¨æ¸¬ä¸»åŠ›æ˜¯åœ¨é€²è²¨ã€æ´—ç›¤é‚„æ˜¯å‡ºè²¨ï¼Ÿ)
                (äºŒ)ã€ æ•£æˆ¶å¿ƒç†é™·é˜±
                (å…§å®¹ï¼šç¾åœ¨æ•£æˆ¶å®¹æ˜“çŠ¯ä»€éº¼éŒ¯ï¼Ÿä¾‹å¦‚è¿½é«˜ã€ä¸æ•¢è²·ã€éæ—©ä¸‹è»Š)
                (ä¸‰)ã€ æ•™ç·´å¿ƒæ³•
                (å…§å®¹ï¼šä¸€å¥ç°¡çŸ­æœ‰åŠ›çš„æ“ä½œæ ¼è¨€)
                (å››)ã€ çŸ³é ­æˆ°ç•¥çµè«– (ç¬¬å››é»çµè«–æ³•)
                (å…§å®¹ï¼šè«‹ç”¨æ¢åˆ—å¼ç¸½çµ 1.ç›¤å‹¢å®šèª¿ 2.é—œéµæŒ‡æ¨™ 3.é˜²å®ˆåº•ç·š 4.æ“ä½œæ ¸å¿ƒ)
                
                è«‹ä¸è¦é‡è¤‡åˆ—å‡ºæ•¸æ“šï¼Œç›´æ¥é€²è¡Œå®šæ€§åˆ†æã€‚
            `;

            try {
                const responseText = await callGeminiAPI(key, promptText);
                document.getElementById('aiLoading').classList.add('hidden');
                aiReportContent = responseText;
                const htmlContent = marked.parse(responseText);
                document.getElementById('aiContent').innerHTML = htmlContent;
                document.getElementById('aiAnalysisBox').scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiContent').innerHTML = `<p class="text-red-500 font-bold">âš ï¸ é€£ç·šç•°å¸¸ (è«‹æª¢æŸ¥ Key): ${error.message} <br> <button onclick="generateLocalAnalysis(true, 'ğŸ”¥ å¼·è»‹ç©ºç›¤', 'RED')" class="text-blue-500 underline mt-2">åˆ‡æ›è‡³å…§å»ºé‚è¼¯åº«</button></p>`;
            }
        }

        async function callGeminiAPI(key, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if(response.status === 429) throw new Error("è«‹æ±‚éæ–¼é »ç¹ (429)ï¼Œè«‹ç¨å€™å†è©¦");
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•å–å¾—åˆ†æçµæœã€‚";
        }

        // --- NEW: Chatbot Function ---
        async function askCoach() {
            const key = localStorage.getItem('gemini_api_key');
            if (!key) return alert("è«‹å…ˆè¨­å®š API Key æ‰èƒ½ä½¿ç”¨æ•™ç·´åŠŸèƒ½ï¼");

            const inputEl = document.getElementById('chatInput');
            const userMsg = inputEl.value.trim();
            if (!userMsg) return;

            const chatHistory = document.getElementById('chatHistory');
            // æ¸…é™¤åˆå§‹æç¤º
            if(chatHistory.querySelector('.italic')) chatHistory.innerHTML = '';

            // User UI
            const userDiv = document.createElement('div');
            userDiv.className = "text-right";
            userDiv.innerHTML = `<span class="inline-block bg-slate-200 rounded px-2 py-1 text-slate-800">${userMsg}</span>`;
            chatHistory.appendChild(userDiv);
            inputEl.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Loading UI
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "text-left";
            loadingDiv.innerHTML = `<span class="inline-block bg-indigo-100 rounded px-2 py-1 text-indigo-800 text-[10px] animate-pulse">æ•™ç·´æ€è€ƒä¸­...</span>`;
            chatHistory.appendChild(loadingDiv);

            // Context Construction
            const ctx = globalContext;
            const contextPrompt = `
                ç¾åœ¨ä½¿ç”¨è€…é‡å°è‚¡ç¥¨ã€Œ${ctx.stockName}ã€æå•ã€‚
                èƒŒæ™¯æ•¸æ“šï¼šç¾åƒ¹ ${ctx.close}, ç‹€æ…‹ ${ctx.status}, å‡é‡ ${ctx.avgVol}, 
                ç³»çµ±åˆ¤å®šç‚ºã€Œ${ctx.trendVerdict}ã€ã€‚
                ä½¿ç”¨è€…çš„å•é¡Œæ˜¯ï¼šã€Œ${userMsg}ã€ã€‚
                è«‹ä»¥ N å­—æˆ°æ³•æ•™ç·´çš„èº«ä»½ï¼Œç°¡çŸ­å›ç­”ï¼ˆ50å­—ä»¥å…§ï¼‰ï¼Œçµ¦äºˆå…·é«”æ“ä½œå»ºè­°ã€‚
            `;

            try {
                const reply = await callGeminiAPI(key, contextPrompt);
                chatHistory.removeChild(loadingDiv);
                const aiDiv = document.createElement('div');
                aiDiv.className = "text-left";
                aiDiv.innerHTML = `<span class="inline-block bg-indigo-100 rounded px-2 py-1 text-indigo-900 font-bold">ğŸ¤– ${reply}</span>`;
                chatHistory.appendChild(aiDiv);
            } catch (err) {
                chatHistory.removeChild(loadingDiv);
                const errDiv = document.createElement('div');
                errDiv.innerHTML = `<span class="text-red-500 text-[10px]">é€£ç·šéŒ¯èª¤</span>`;
                chatHistory.appendChild(errDiv);
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- NEW: Text-to-Speech Function ---
        async function playAudioReport() {
            const key = localStorage.getItem('gemini_api_key');
            if (!key) return alert("è«‹å…ˆè¨­å®š API Keyï¼");
            
            if(!aiReportContent) return alert("è«‹å…ˆç”¢ç”Ÿåˆ†æå ±å‘Šï¼");

            const btn = document.getElementById('ttsBtn');
            const icon = document.getElementById('ttsIcon');
            const textSpan = document.getElementById('ttsText');
            const wave = document.getElementById('audioWave');

            btn.disabled = true;
            textSpan.innerText = "ç”ŸæˆèªéŸ³ä¸­...";
            
            // Construct text to say (Simplified for TTS)
            const textToSay = `
                çŸ³é ­æˆ°ç•¥èªéŸ³æŒ‡æ®å®˜å ±å‘Šã€‚
                è‚¡ç¥¨åç¨±ï¼š${globalContext.stockName}ã€‚
                ç›®å‰ç‹€æ…‹ï¼š${globalContext.status === 'RED' ? 'å¤šæ–¹æ”»æ“Š' : 'ç©ºæ–¹æ•´ç†'}ã€‚
                æˆ°ç•¥çµè«–ï¼š${globalContext.trendVerdict}ã€‚
                ${aiReportContent.replace(/[*#]/g, '').slice(0, 300)}... (ä»¥ä¸‹çœç•¥)
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: textToSay }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: {
                                voiceName: "Kore" // Energetic voice suitable for a coach
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(response.statusText);
                const data = await response.json();
                const audioData = data.candidates[0].content.parts[0].inlineData.data;
                
                // Play Audio
                playPCM(audioData);
                
                // UI Animation
                textSpan.innerText = "æ’­æ”¾ä¸­...";
                icon.innerText = "ğŸ”Š";
                wave.classList.remove('hidden');
                wave.classList.add('playing');

            } catch (error) {
                alert("èªéŸ³ç”Ÿæˆå¤±æ•—: " + error.message);
                btn.disabled = false;
                textSpan.innerText = "æ’­æ”¾èªéŸ³æŒ‡æ®å®˜";
            }
        }

        // Helper to handle PCM Audio from Gemini
        function playPCM(base64PCM) {
            const binaryString = window.atob(base64PCM);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const int16Array = new Int16Array(bytes.buffer);

            // Create AudioContext
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = audioCtx.createBuffer(1, int16Array.length, 24000); // Gemini TTS default is 24kHz
            const channelData = buffer.getChannelData(0);
            
            // Convert Int16 to Float32
            for (let i = 0; i < int16Array.length; i++) {
                channelData[i] = int16Array[i] / 32768.0;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start();

            source.onended = () => {
                const btn = document.getElementById('ttsBtn');
                const icon = document.getElementById('ttsIcon');
                const textSpan = document.getElementById('ttsText');
                const wave = document.getElementById('audioWave');
                
                btn.disabled = false;
                icon.innerText = "âœ¨";
                textSpan.innerText = "æ’­æ”¾èªéŸ³æŒ‡æ®å®˜";
                wave.classList.add('hidden');
                wave.classList.remove('playing');
            };
        }
    </script>
</body>
</html>
