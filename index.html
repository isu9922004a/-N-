<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N字戰法：三盤轉折判斷計算機 (V18.2 戰略版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 卷軸美化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .invalid-target { text-decoration: line-through; color: #9ca3af; }
        .input-error { border-color: #ef4444 !important; ring: 2px; ring-color: #ef4444; background-color: #fef2f2; }
        
        /* 閃爍提醒特效 */
        @keyframes highlightPulse {
            0% { background-color: #fff; }
            50% { background-color: #fef9c3; } /* yellow-100 */
            100% { background-color: #fff; }
        }
        .highlight-input { animation: highlightPulse 1s ease-in-out; }

        /* 摺疊選單樣式 */
        details > summary { list-style: none; cursor: pointer; transition: all 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { margin-bottom: 0.5rem; }
        details > summary:hover { background-color: #f8fafc; }

        /* AI Loading Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #6366f1;
            color: #6366f1;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #6366f1; }
            50%, 100% { background-color: #e0e7ff; }
        }
        
        /* Markdown Styles for AI Response */
        .ai-content h1, .ai-content h2, .ai-content h3 { font-weight: 800; margin-top: 0.5em; margin-bottom: 0.3em; color: #1e1b4b; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .ai-content p { margin-bottom: 0.5em; line-height: 1.6; }
        .ai-content strong { color: #b91c1c; }
        .ai-content table { border-collapse: collapse; width: 100%; margin-bottom: 1em; font-size: 0.9em; }
        .ai-content th, .ai-content td { border: 1px solid #e2e8f0; padding: 0.5em; text-align: left; }
        .ai-content th { background-color: #f1f5f9; font-weight: bold; }
        
        /* V18.2 Banner Style */
        .v18-badge {
            background: linear-gradient(135deg, #000000 0%, #434343 100%);
            color: #FFD700;
            text-shadow: 0px 1px 0px rgba(255,255,255,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid #FFD700;
        }
        
        /* Explicit hidden class for toggle */
        .hidden { display: none !important; }
    </style>
    <script>
        // Ensure toggle function is globally available
        function toggleEncyclopedia() {
            const content = document.getElementById('encyclopediaContent');
            if (content) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            } else {
                console.error("Encyclopedia content element not found!");
            }
        }
    </script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden border border-slate-300 relative">
        <!-- Header -->
        <div class="bg-slate-900 p-5 text-white text-center relative z-20">
            <h1 class="text-2xl font-black tracking-wider">N字戰法指揮中心 by.石頭 <span class="v18-badge px-2 py-0.5 rounded text-sm align-top ml-1 font-bold">V18.2</span></h1>
            <p class="text-xs text-slate-400 mt-1">主控盤態 x 高低折線 x 三分力道</p>
        </div>

        <!-- 戰法百科全書 (Accordion Menu) -->
        <div class="bg-slate-50 border-b border-slate-200">
            <!-- Ensure onclick logic is simple and ID matches -->
            <div id="encyclopediaToggleBtn" class="p-3 text-center bg-blue-700 text-white font-bold text-sm cursor-pointer hover:bg-blue-800 transition-colors" onclick="toggleEncyclopedia()">
                📖 點我打開：N字戰法全能百科 (圖解精華) ▼
            </div>
            
            <div id="encyclopediaContent" class="hidden max-h-[500px] overflow-y-auto p-4 space-y-3 shadow-inner bg-white">
                <!-- Part 1: 基礎趨勢 -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-2 mb-1">第一篇：基礎趨勢與轉折 (定多空)</div>
                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>1. 趨勢篇：末升低 & 末跌高</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">● 末升低 (Last Rising Low)：</span>多頭趨勢中，最後一波上漲的「起漲點」。<br><strong>意義：</strong>多頭最後防線。跌破 = 多翻空。</p>
                        <p><span class="font-bold text-green-600">● 末跌高 (Last Falling High)：</span>空頭趨勢中，最後一次反彈的「起跌點」。<br><strong>意義：</strong>空頭最後防線。突破 = 空翻多。</p>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>2. 轉折訊號：日出線 & 日落線</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p><span class="font-bold text-red-600">🌅 日出線 (Sunrise)：</span>高過昨高，收盤收高。<br>用途：回檔時的止跌買訊。</p>
                        <p><span class="font-bold text-green-600">🌇 日落線 (Sunset)：</span>低破昨低，收盤收低。<br>用途：上漲時的止漲賣訊。</p>
                        <p class="bg-indigo-50 p-1 rounded font-bold text-center">口訣：回檔找日出，上漲防日落。</p>
                    </div>
                </details>

                <details class="group border border-purple-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-purple-800 bg-purple-50 p-3">
                        <span>3. 防守篇：軋空低 & 翻紅定義</span>
                        <span class="text-purple-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                        <p><span class="font-bold bg-indigo-100 text-indigo-800 px-1 rounded">翻紅K棒：</span> 寶塔線由綠翻紅 (收盤 > 前三高) 當天的那根K棒。</p>
                        <p><span class="font-bold bg-purple-100 text-purple-800 px-1 rounded">軋空低：</span> 翻紅K棒的<span class="text-red-600 font-bold">最低點</span>。</p>
                        
                        <!-- 成本迷思解惑 -->
                        <div class="bg-red-50 p-2 rounded border border-red-200">
                            <p class="font-bold text-red-800 border-b border-red-200 pb-1 mb-1">💡 軋空低填哪一天？</p>
                            <p class="mb-1 text-slate-800 font-bold">N字戰法操作「當下」，不問成本！</p>
                            <div class="grid grid-cols-1 gap-2 mt-2">
                                <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                    <p class="font-bold text-yellow-800">📌 情境 A (空手想買)</p>
                                    <p>輸入：填 <span class="font-bold text-red-600">「今天」</span> 的盤中最低點。</p>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-200">
                                    <p class="font-bold text-green-800">📌 情境 B (持有續抱)</p>
                                    <p>輸入：填 <span class="font-bold text-red-600">「當初買進那天」</span> 的最低點。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                 <!-- NEW: 寶塔線邏輯 -->
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">第二篇：寶塔線與盤態圖解 (重點)</div>

                <details class="group border border-blue-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-blue-800 bg-blue-50 p-3">
                        <span>4. 原理篇：寶塔線 (TOW) 邏輯詳解</span>
                        <span class="text-blue-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                         <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                            <p class="font-bold text-yellow-900 border-b border-yellow-200 pb-1 mb-1">💡 為什麼觀察三天？ (參數=3)</p>
                            <ul class="list-decimal list-inside space-y-1 text-yellow-800">
                                <li><span class="font-bold">過濾假訊號：</span>避免「一日行情」。</li>
                                <li><span class="font-bold">心理防線：</span>Day 1 變盤，Day 2 延續，Day 3 確立。</li>
                                <li><span class="font-bold">操作精髓：</span>綠翻紅後，若連續三天不破 Day 1 低點，多頭確立。</li>
                            </ul>
                        </div>
                    </div>
                </details>

                <!-- Part 2: 盤態與攻擊 -->
                <details class="group border border-orange-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-orange-800 bg-orange-50 p-3">
                        <span>5. 心法篇：盤態分類 (圖解對照)</span>
                        <span class="text-orange-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-4">
                        <div>
                            <p class="font-bold bg-red-100 text-red-800 px-1 rounded inline-block mb-1">📈 多方趨勢 (Bullish)</p>
                            <div class="flex flex-col items-center my-2 p-2 border border-slate-200 rounded bg-white">
                                <div class="w-full text-center text-[10px] text-gray-500 mb-1">▼ 圖一：多方盤態與空頭抵抗 (按圖操作) ▼</div>
                                <div class="w-full h-auto rounded shadow-sm bg-gray-100 p-2 text-center text-xs text-gray-500 flex justify-around">
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-orange-600 mb-1">① 盤堅盤</div>
                                        <div class="text-[9px]">空頭抵抗強<br>回檔深<br>守軋空低</div>
                                    </div>
                                    <div class="w-1/3 border-r border-gray-300 px-1">
                                        <div class="font-bold text-blue-600 mb-1">② 軋空盤</div>
                                        <div class="text-[9px]">空頭抵抗弱<br>高檔旗型<br>以盤代跌</div>
                                    </div>
                                    <div class="w-1/3 px-1">
                                        <div class="font-bold text-red-600 mb-1">③ 強軋空</div>
                                        <div class="text-[9px]">抵抗失敗<br>不回頭<br>直接噴出</div>
                                    </div>
                                </div>
                                <div class="mt-2 text-left w-full space-y-1">
                                     <p>① <span class="font-bold text-orange-600">盤堅盤 (Accumulation)：</span> 回檔較深，黑K吞噬紅棒，但<span class="bg-orange-100 px-1 rounded font-bold">守住軋空低</span>。策略：耐心等待。</p>
                                     <p>② <span class="font-bold text-blue-600">軋空盤 (Squeeze)：</span> 高檔整理，<span class="bg-blue-100 px-1 rounded font-bold">空頭抵抗</span>出現但守住昨日高點。策略：續抱看一飽。</p>
                                     <p>③ <span class="font-bold text-red-600">強軋空 (Super Squeeze)：</span> <span class="bg-red-100 px-1 rounded font-bold">空頭抵抗失敗</span>(紅框處)，隔日開高走高。策略：死抱看五倍。</p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-200 pt-2">
                            <p class="font-bold bg-green-100 text-green-800 px-1 rounded inline-block mb-1">📉 空方趨勢 (Bearish)</p>
                            <ul class="space-y-2 ml-1">
                                <li>
                                    <span class="font-bold text-green-700">① 強殺多：</span>跳空向下，連黑K，完全無反彈。<br>
                                    <span class="text-slate-500">→ 策略：絕對不接刀，反彈就是空。</span>
                                </li>
                                <li>
                                    <span class="font-bold text-green-600">② 殺多盤：</span>弱勢整理再破底。<br>
                                    <span class="text-slate-500">→ 策略：利用反彈逃命，空方續抱。</span>
                                </li>
                                <li><span class="font-bold text-slate-600">③ 盤跌盤：</span>跌破後反彈深(假突破回頸線)，隨後再殺。<br>
                                    <span class="text-slate-500">→ 策略：區間操作，嚴設停損。</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </details>
                
                <div class="text-xs font-black text-slate-400 uppercase tracking-widest mt-4 mb-1">第三篇：實戰與離場 (SOP)</div>

                <details class="group border border-green-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-green-800 bg-green-50 p-3">
                        <span>6. 攻擊篇：N字測幅 (手稿公式)</span>
                        <span class="text-green-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p>參數：<span class="font-bold text-red-600">h2 (今日最高)</span>，<span class="font-bold text-green-600">L (前三低)</span></p>
                        <div class="bg-green-50 p-2 rounded border border-green-100 font-mono">
                            <p>● <span class="font-bold">一飽 (1N)：</span> h2 × 2 - L (V測距/翻箱)</p>
                            <p>● <span class="font-bold">二吐 (2N)：</span> 一飽 + (h2 - L) (強勢飆股)</p>
                            <p>● <span class="font-bold">五倍 (5x)：</span> h2 + 5 × (h2 - L) (摺疊翻箱)</p>
                            <p class="text-[10px] text-slate-500 mt-1 italic">註：系統採用主控盤 V 測距算法，比傳統 N 測距 (CD=AB) 更具攻擊性，專抓噴出段。</p>
                        </div>
                    </div>
                </details>

                <details class="group border border-indigo-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-indigo-800 bg-indigo-50 p-3">
                        <span>7. 進階篇：長紅隔日強弱判定</span>
                        <span class="text-indigo-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold">突破帶量長紅棒，隔日走勢至關重要：</p>
                        <ol class="list-decimal list-inside space-y-1 ml-1">
                            <li><span class="font-bold text-red-600">繼續漲：</span> 強勢 (Strong)。</li>
                            <li><span class="font-bold text-red-500">不破 1/3：</span> 次強 (Normal)。</li>
                            <li><span class="font-bold text-orange-500">不破 1/2：</span> 次次強 (Weak but Hold)。</li>
                            <li><span class="font-bold text-gray-500">跌破 1/2 或低點：</span> 假突破 (False Breakout)。</li>
                        </ol>
                    </div>
                </details>
                
                <details class="group border border-red-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-red-800 bg-red-50 p-3">
                        <span>8. 離場篇：世紀鋼 (9958) 賣訊</span>
                        <span class="text-red-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-700">賣出三部曲 (世紀鋼教訓)：</p>
                        <ol class="list-decimal list-inside ml-1">
                            <li><span class="font-bold">趨勢轉弱：</span>均線 (EMA 8/21/55) 上漲變緩或走平。</li>
                            <li><span class="font-bold">結構跌破：</span>三盤跌破 + 跌破所有均線。</li>
                            <li><span class="font-bold">指標確認：</span>落尾日落 + 寶塔翻綠。</li>
                        </ol>
                        <p class="bg-red-50 p-1 text-center font-bold text-red-900 mt-1">結論：多頭已死，果斷換股！</p>
                    </div>
                </details>
                
                <!-- 輸入指南 -->
                 <details class="group border border-gray-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-gray-800 bg-gray-50 p-3">
                        <span>9. SOP：盤中輸入指南</span>
                        <span class="text-gray-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white">
                        收盤價(跳動價)、今日最高(算目標)、軋空低(翻紅日低)、前三高/低(昨前大前)
                    </div>
                </details>

                <!-- NEW: 預判教學 -->
                <details class="group border border-sky-200 rounded overflow-hidden" open>
                    <summary class="flex justify-between items-center font-bold text-sky-800 bg-sky-50 p-3">
                        <span>10. 預判篇：如何模擬未來走勢？</span>
                        <span class="text-sky-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-2">
                        <p class="font-bold text-red-600 border-b border-sky-100 pb-1">Q: 怎麼預測明天？(模擬戰情室用法)</p>
                        <ol class="list-decimal list-inside ml-1 space-y-2">
                            <li><span class="font-bold bg-blue-100 text-blue-800 px-1 rounded">情境按鈕 (新手)：</span>
                                <div class="pl-4 text-slate-500 mt-1">
                                    上方藍色區塊的按鈕 (如：模擬極強)，是<span class="bg-yellow-100 text-slate-800 px-1">系統自動填入假數據</span>，按下去後請直接看最下方的「分析結果」，讓你練習「看到這種數據該怎麼做」。
                                </div>
                            </li>
                            <li><span class="font-bold bg-slate-800 text-white px-1 rounded">手動預演 (老手)：</span>
                                <ul class="list-none list-inside pl-4 text-slate-600 mt-1 space-y-1">
                                    <li>① 填入真實的 <span class="font-bold">前三高、前三低、均量</span> (這是已知歷史)。</li>
                                    <li>② 更改 <span class="text-blue-700 font-bold">目前價</span> (輸入：你假設明天會漲到的價格)。</li>
                                    <li>③ 更改 <span class="text-purple-700 font-bold">成交量</span> (輸入：你預估明天的量)。</li>
                                    <li>④ 按下黑色 <span class="font-bold bg-black text-white px-1 text-[10px] rounded">執行實戰推演</span> 按鈕。</li>
                                </ul>
                                <p class="text-center text-red-600 font-bold mt-1 bg-red-50 p-1">💡 結論：利用假想的明後天價格，先算出下一步策略！</p>
                            </li>
                        </ol>
                    </div>
                </details>

                <!-- NEW: 模組切換說明 -->
                <details class="group border border-teal-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-teal-800 bg-teal-50 p-3">
                        <span>11. 說明篇：模組切換使用說明 (必讀)</span>
                        <span class="text-teal-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">【模擬極強】(多頭最強勢)</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>模組切換原則：</strong></li>
                                <li>「突破 → 極強」需滿足連續攻擊量與結構不破</li>
                                <li>「極強 → 盤整」以量大不漲 / 動能鈍化為判準</li>
                                <li>「盤整 → 大跌」以帶量破箱底為確認</li>
                                <li class="text-red-600 font-bold">禁止跨模組混用指令</li>
                                <li>⚠️ 本模組僅在盤勢屬於【模擬極強】階段且結構不破軋空低點時適用</li>
                             </ul>
                        </div>
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">【模擬突破】(起漲第一天)</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>模組切換原則：</strong></li>
                                <li>「突破 → 極強」需滿足連續攻擊量與結構不破</li>
                                <li>「極強 → 盤整」以量大不漲 / 動能鈍化為判準</li>
                                <li>「盤整 → 大跌」以帶量破箱底為確認</li>
                                <li class="text-red-600 font-bold">禁止跨模組混用指令</li>
                                <li>⚠️ 本模組僅在股價帶量突破頸線且突破確認成立時適用</li>
                             </ul>
                        </div>
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">【模擬盤整】(觀望等待)</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>模組切換原則：</strong></li>
                                <li>「突破 → 極強」需滿足連續攻擊量與結構不破</li>
                                <li>「極強 → 盤整」以量大不漲 / 動能鈍化為判準</li>
                                <li>「盤整 → 大跌」以帶量破箱底為確認</li>
                                <li class="text-red-600 font-bold">禁止跨模組混用指令</li>
                                <li>⚠️ 本模組僅在股價處於箱型震盪、方向未明、且未帶量突破關鍵價位時適用</li>
                             </ul>
                        </div>
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">【模擬大跌】(空方崩盤)</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>模組切換原則：</strong></li>
                                <li>「突破 → 極強」需滿足連續攻擊量與結構不破</li>
                                <li>「極強 → 盤整」以量大不漲 / 動能鈍化為判準</li>
                                <li>「盤整 → 大跌」以帶量破箱底為確認</li>
                                <li class="text-red-600 font-bold">禁止跨模組混用指令</li>
                                <li>⚠️ 本模組僅在股價結構已壞、空方趨勢確認、且主力出貨帶量下殺時適用</li>
                             </ul>
                        </div>
                    </div>
                </details>
                
                <!-- NEW: N字戰法心法 (Newbie Friendly) -->
                <details class="group border border-pink-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-pink-800 bg-pink-50 p-3">
                        <span>12. 觀念篇：N字戰法心法邏輯說明 (新手白話版)</span>
                        <span class="text-pink-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">一、 什麼是「N字理論」？</p>
                             <p class="mb-2">想像一個人在跳高，他必須先「蹲下」累積能量，然後才能「跳起來」。股價也是一樣，上漲（跳起）之後，通常會回檔（蹲下），只要沒跌破起漲點（地板），下一次就能跳得更高！這個「上 -> 下 -> 上」的過程，畫出來就像英文字母 "N"。</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>實過 (Solid Pass)：</strong> 收盤價 > 前波高點收盤價。代表真突破。</li>
                                <li><strong>虛過 (Virtual Pass)：</strong> 盤中最高價 > 前波高點。僅是刺探，不算真突破。</li>
                                <li><strong>N字成立：</strong> 必須同時滿足「實過」與「虛過」。</li>
                             </ul>
                             <p class="bg-yellow-50 p-1 rounded mt-1 border border-yellow-200"><strong>💡 小白金句：</strong> 只有當股價走出「N」字形，衝過前波高點，才代表主力是真的要拉抬這檔股票！</p>
                        </div>

                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">二、 一飽二吐 (目標測量法)</p>
                             <p class="mb-2">這是預測股價會漲到哪裡的口訣。</p>
                             <ul class="list-decimal list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>一飽 (1-Sat)：</strong> 基礎目標。公式：<code>1N = 突破點 + (第一波漲幅)</code>。</li>
                                <li><strong>二吐 (2-Spit)：</strong> 進階目標。公式：<code>2N = 突破點 + (第一波漲幅 x 2)</code>。</li>
                             </ul>
                             <p class="text-slate-500 mt-1 italic">註：本計算機使用的 V測距 (h2 * 2 - L) 是一種更強勢的「一飽」變形，專門針對主力鎖碼股設計。</p>
                        </div>
                        
                        <div class="bg-slate-50 p-2 rounded border border-slate-200">
                             <p class="font-bold text-slate-800 mb-1">三、 實戰操作心法</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>買點：</strong> 突破 B 點 (前高) 時，或回測 C 點 (軋空低) 不破時。</li>
                                <li><strong>賣點：</strong> 跌破 C 點 (軋空低/關鍵紅棒低點)。</li>
                                <li><strong>倒N字：</strong> 若出現倒著寫的 N (跌破前低)，代表空頭來襲，快逃！</li>
                             </ul>
                        </div>
                        <div class="mt-4 border-t border-slate-200 pt-2">
                                <p class="font-bold text-slate-700 mb-2">▼ 空頭反轉型態參考圖 (Bearish Patterns) ▼</p>
                                <img src="bearish_pattern.jpg" alt="請將您的圖片命名為 bearish_pattern.jpg 並與此網頁放在同一資料夾，即可顯示圖片" class="w-full rounded shadow-sm border border-slate-200" onerror="this.src='https://placehold.co/600x400?text=Image+Not+Found';this.alt='圖片無法載入'">
                                <p class="text-[10px] text-gray-500 mt-1">※ 若無法顯示，請將圖片檔案命名為 <code>bearish_pattern.jpg</code> 並放在與本網頁相同的資料夾中。</p>
                            </div>
                    </div>
                </details>
                
                <!-- NEW: 第 13 篇：主控盤態精華 (V17.5 新增) -->
                 <details class="group border border-purple-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-purple-800 bg-purple-50 p-3">
                        <span>13. 實戰篇：主控盤態精華 (V17.5 核心筆記)</span>
                        <span class="text-purple-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                         <!-- 1. 突破與空頭抵抗 -->
                        <div class="bg-purple-50 p-2 rounded border border-purple-200">
                             <p class="font-bold text-purple-900 mb-1 border-b border-purple-200 pb-1">1. 突破與空頭抵抗 (Breakout Resistance)</p>
                             <p class="mb-1 text-slate-600">當股價突破前高(N字頸線)後，次日通常會出現「開高走低」或「避雷針」，這是前波解套賣壓造成的正常現象。</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>標準形態：</strong> 長紅突破 -> 次日避雷針 (佔70%)。</li>
                                <li><strong>軋空低取值：</strong> 取「實低」(當日最低) 與 「虛低」(跳空時取昨收) 之<strong>最低者</strong>作為防守點。</li>
                                <li><strong>抵抗成功：</strong> 若股價拉回不破軋空低，且後續再創新高，代表換手成功，多頭續攻。</li>
                             </ul>
                        </div>

                         <!-- 2. 跌破與多頭抵抗 -->
                        <div class="bg-green-50 p-2 rounded border border-green-200">
                             <p class="font-bold text-green-900 mb-1 border-b border-green-200 pb-1">2. 跌破與多頭抵抗 (Support Failure)</p>
                             <p class="mb-1 text-slate-600">當股價跌破關鍵支撐後，次日出現下影線或紅K試圖反彈，稱為多頭抵抗。</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>殺多高取值：</strong> 取「實高」(當日最高) 與 「虛高」(跳空時取昨收) 之<strong>最高者</strong>作為壓力點。</li>
                                <li><strong>抵抗失敗：</strong> 若反彈無法站回「殺多高」，或直接再破底，確認空頭趨勢，應立即停損或放空。</li>
                             </ul>
                        </div>

                        <!-- 3. 連續突破 -->
                        <div class="bg-blue-50 p-2 rounded border border-blue-200">
                             <p class="font-bold text-blue-900 mb-1 border-b border-blue-200 pb-1">3. 連續突破與該回不回</p>
                             <p class="mb-1 text-slate-600">若突破後次日完全沒有回檔（空頭抵抗失敗），直接開高走高，稱為「該回不回」，是超級強勢的噴出訊號！</p>
                        </div>
                    </div>
                </details>

                 <!-- NEW: 第 14 篇：主控盤進階 (V18 新增) -->
                 <details class="group border border-gray-200 rounded overflow-hidden">
                    <summary class="flex justify-between items-center font-bold text-gray-800 bg-gray-50 p-3">
                        <span>14. 宗師篇：主控盤核心理論 (V18 獨家)</span>
                        <span class="text-gray-500 transition-transform group-open:rotate-180">▼</span>
                    </summary>
                    <div class="p-3 text-xs text-slate-700 bg-white space-y-3">
                         <!-- 1. 趨勢與高低折線 -->
                        <div class="bg-gray-50 p-2 rounded border border-gray-200">
                             <p class="font-bold text-gray-900 mb-1 border-b border-gray-200 pb-1">1. 極短線轉折：出頭與落尾</p>
                             <ul class="list-disc list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>出頭 (止跌)：</strong> 今高 > 昨高。這是極短線的第一個止跌訊號。</li>
                                <li><strong>落尾 (止漲)：</strong> 今低 < 昨低。這是極短線的第一個轉弱訊號。</li>
                                <li><strong>高低折線：</strong> 連接「出頭」的低點與「落尾」的高點，可過濾盤中雜訊，精確抓出「末升低」與「末跌高」。</li>
                             </ul>
                        </div>

                         <!-- 2. 三分力道 -->
                        <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                             <p class="font-bold text-yellow-900 mb-1 border-b border-yellow-200 pb-1">2. 三分力道 (Retracement Strength)</p>
                             <p class="mb-1 text-slate-600">判斷回檔強弱的黃金法則 (高點至低點區間)：</p>
                             <ul class="list-decimal list-inside pl-1 text-slate-600 space-y-1">
                                <li><strong>強勢回檔 (1/3)：</strong> 僅回檔 1/3，多頭極強，買盤踴躍。</li>
                                <li><strong>中勢回檔 (1/2)：</strong> 回檔至一半，多空平衡。</li>
                                <li><strong>弱勢回檔 (2/3)：</strong> 回檔深達 2/3，多頭虛弱，需防反轉。</li>
                             </ul>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <div class="p-6 space-y-5 relative z-0">
            
            <!-- 模擬戰情室 (New) -->
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <h3 class="text-xs font-black text-blue-900 mb-2 flex items-center">
                    🎮 模擬戰情室 (快速演習)
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="simulate('strong')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        🚀 模擬極強
                    </button>
                    <button onclick="simulate('break')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        🔥 模擬突破
                    </button>
                    <button onclick="simulate('crash')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        💀 模擬大跌
                    </button>
                    <button onclick="simulate('flat')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded text-xs transition-colors flex items-center justify-center shadow-sm">
                        ➖ 模擬盤整
                    </button>
                </div>
            </div>
            
            <!-- 0. 股票代碼 -->
            <div>
                <label class="block text-slate-700 font-bold mb-1 text-sm">股票名稱/代號</label>
                <input type="text" id="stockName" class="w-full p-2 border-2 border-slate-200 rounded focus:ring-2 focus:ring-slate-500 font-bold placeholder-slate-300 transition-colors" placeholder="例如：世紀鋼 (9958)">
            </div>

            <!-- 1. 狀態選擇 -->
            <div>
                <label class="block text-slate-700 font-bold mb-2 text-sm">1. 目前寶塔線顏色 (狀態)</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setStatus('GREEN')" id="btn-green" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100">
                        🟩 綠色 (空手/盤整)
                    </button>
                    <button onclick="setStatus('RED')" id="btn-red" class="py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60">
                        🟥 紅色 (持有/多方)
                    </button>
                </div>
                <input type="hidden" id="currentStatus" value="GREEN">
            </div>

            <!-- 2. 核心價格 -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-blue-600 pl-2">核心價格 (Price Action)</h3>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-blue-900 font-bold mb-1 text-xs">目前價 (Current)</label>
                            <input type="number" step="0.01" id="closePrice" class="w-full p-2 border-2 border-blue-200 rounded focus:ring-blue-500 text-lg font-mono font-bold text-blue-900" placeholder="跳動價">
                        </div>
                        <div>
                            <label class="block text-red-700 font-bold mb-1 text-xs">今日最高 <span class="bg-red-100 px-1 rounded">h2</span></label>
                            <input type="number" step="0.01" id="todayHigh" class="w-full p-2 border-2 border-red-200 rounded focus:ring-red-500 text-lg font-mono font-bold text-red-700" placeholder="動態測幅用">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">前三高 (頸線)</label>
                        <input type="number" step="0.01" id="high3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="昨/前/大前">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">前三低 (L)</label>
                        <input type="number" step="0.01" id="low3d" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="昨/前/大前">
                    </div>
                    
                    <!-- 軋空低欄位 -->
                    <div class="col-span-2 bg-red-50 p-3 rounded-lg border-2 border-red-300 mt-2 relative overflow-hidden shadow-sm ring-2 ring-red-100">
                         <div class="absolute right-0 top-0 text-[60px] opacity-10 pointer-events-none transform rotate-12">🛡️</div>
                         <div class="flex justify-between items-center mb-1">
                             <label class="block text-purple-900 font-black mb-1 text-sm">★ 軋空低 (翻紅K棒最低點)</label>
                             <button onclick="toggleEncyclopedia()" class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded hover:bg-red-700 cursor-pointer shadow">❓ 填哪一天？</button>
                         </div>
                        <input type="number" step="0.01" id="breakoutLow" class="w-full p-2 border-2 border-purple-300 rounded font-mono text-lg text-purple-900 font-bold bg-white focus:ring-2 focus:ring-purple-500" placeholder="目標價生存線">
                        
                        <div class="mt-2 space-y-2 text-[11px] font-bold text-slate-600 bg-white/60 p-2 rounded border border-red-100">
                             <div class="flex items-start">
                                <span class="text-red-600 mr-1">A.</span>
                                <span><span class="text-red-700 bg-red-100 px-1 rounded">空手想買：</span>請填寫「今天」的盤中最低點。</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-green-600 mr-1">B.</span>
                                <span><span class="text-green-700 bg-green-100 px-1 rounded">持有續抱：</span>請填寫「當初買進那天」的最低點。</span>
                            </div>
                            <p class="text-red-500 mt-1 border-t border-red-200 pt-1 flex items-center justify-center">
                                <span class="text-lg mr-1">⚡</span> 跌破此價 = 攻擊失敗 (需停損/離場)
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. 成交量 -->
            <div class="border-t border-slate-200 pt-4">
                <h3 class="text-sm font-black text-slate-800 mb-3 border-l-4 border-purple-600 pl-2">成交量結構 (Volume)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-purple-900 font-bold mb-1 text-xs">今日成交量 (Today Vol)</label>
                        <input type="number" id="todayVol" class="w-full p-2 border-2 border-purple-200 rounded focus:ring-purple-500 font-mono text-lg font-bold text-purple-900" placeholder="預估量">
                    </div>
                    <div>
                        <label class="block text-slate-500 font-bold mb-1 text-xs">過去三日均量 (Avg Vol)</label>
                        <input type="number" id="avgVol" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="輸入5T數值">
                    </div>
                </div>
            </div>

            <!-- 4. 強勢股判定參數 (含長紅強弱判定) -->
            <div id="advancedInputs" class="hidden bg-indigo-50 p-3 rounded-lg mt-4 border border-indigo-100">
                <h3 class="text-sm font-black text-indigo-900 mb-2">★ 盤態強弱判定參數 (選填)</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日收盤</label>
                        <input type="number" id="prevClose" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="昨收">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">今日最低</label>
                        <input type="number" id="todayLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="今低">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日最低</label>
                        <input type="number" id="prevLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="昨低">
                    </div>
                    <div class="col-span-3 mt-1 pt-2 border-t border-indigo-200">
                        <label class="block text-[10px] text-gray-500 font-bold mb-1">昨日長紅低點 (用於隔日強弱判定)</label>
                        <input type="number" id="prevLongRedLow" class="w-full p-1.5 border border-indigo-200 rounded text-sm text-center" placeholder="若昨日收黑則免填">
                    </div>
                </div>
            </div>

            <!-- 賣出檢核 -->
            <div id="sellChecklist" class="hidden bg-red-50 p-3 rounded border-2 border-red-200 mt-3">
                <h4 class="font-bold text-red-800 text-xs mb-2 flex items-center">📉 換股操作檢核</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkTrend" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">均線上漲趨勢緩</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkMA" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">三盤跌破所有均線</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-red-100">
                        <input type="checkbox" id="checkSunset" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="text-xs text-slate-800 font-bold">落尾日落 & 寶塔翻綠</span>
                    </label>
                </div>
                <div id="sellAdvice" class="hidden mt-2 p-3 bg-red-600 text-white text-sm font-black rounded text-center animate-pulse shadow-lg transform scale-105">
                    🚨 條件成立：收回資金，換股操作！
                </div>
            </div>

            <!-- 操作按鈕區 -->
            <div class="grid grid-cols-5 gap-2 mt-4">
                <button onclick="calculateStrategy()" class="col-span-3 bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-lg tracking-widest border border-slate-700">
                    執行實戰推演
                </button>
                <button onclick="clearInputs()" class="col-span-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl shadow-md transition-all active:scale-95 text-base border border-gray-300 flex items-center justify-center">
                    🔄 清除重置
                </button>
            </div>

            <!-- 結果顯示區 -->
            <div id="resultArea" class="hidden fade-in mt-4 pb-10">
                <div id="resultBox" class="p-5 rounded-xl border-l-8 shadow-md bg-white relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span id="stockBadge" class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded font-bold mb-1 inline-block"></span>
                                <h2 id="resultTitle" class="text-xl font-black leading-tight"></h2>
                            </div>
                            <span id="resultIcon" class="text-3xl"></span>
                        </div>

                        <div class="mb-3 flex flex-wrap gap-2">
                            <span id="trendTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="volTag" class="text-xs font-bold px-2 py-1 rounded border"></span>
                            <span id="patternTag" class="hidden text-xs font-bold px-2 py-1 rounded border"></span>
                        </div>
                        
                        <p id="resultAction" class="text-2xl font-black mb-3 border-b pb-2"></p>
                        
                        <!-- N字測幅目標區 -->
                        <div id="targetBox" class="hidden bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm transition-all">
                            <h5 id="targetHeader" class="font-bold text-green-800 border-b border-green-200 pb-1 mb-2 flex justify-between">
                                <span>🎯 動態測幅目標 (h2=<span id="valH2"></span>, L=<span id="valL"></span>)</span>
                                <span id="targetStatusBadge" class="text-[10px] bg-green-200 px-1 rounded text-green-800">Active</span>
                            </h5>
                            <div id="targetList" class="space-y-1 font-mono text-slate-700">
                                <div class="flex justify-between">
                                    <span>一飽 (1N)：</span>
                                    <span class="font-bold text-green-700" id="target1"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>二吐 (2N)：</span>
                                    <span class="font-bold text-green-700" id="target2"></span>
                                </div>
                                <div class="flex justify-between bg-green-100 -mx-1 px-1 rounded">
                                    <span class="font-bold text-purple-700">五倍 (5N)：</span>
                                    <span class="font-bold text-purple-700" id="target5"></span>
                                </div>
                            </div>
                            <div id="targetInvalidMsg" class="hidden mt-2 text-center bg-gray-200 text-gray-500 font-bold py-1 rounded text-xs border border-gray-300">
                                ❌ 跌破軋空低，目標已抵銷
                            </div>
                        </div>

                        <div id="inferenceBox" class="hidden bg-slate-50 p-2 rounded border border-slate-200 mb-3 text-xs font-mono text-slate-600"></div>

                        <div class="bg-white/60 p-3 rounded border border-slate-200 mb-4 backdrop-blur-sm shadow-sm">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">★ 戰術指引 (Tactical Advice)</p>
                            <p id="resultAdvice" class="text-sm text-slate-800 font-medium leading-relaxed"></p>
                        </div>
                        
                        <div id="aiAnalysisBox" class="hidden mt-3 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-slate-700 shadow-inner relative">
                            <div class="absolute top-0 right-0 p-1 opacity-20 text-4xl">🤖</div>
                            <h4 id="aiReportTitle" class="font-black text-indigo-900 mb-2 border-b border-indigo-200 pb-1 flex items-center">
                                🧠 石頭戰略分析報告
                            </h4>
                            <div id="aiContent" class="ai-content">
                                <!-- AI Content will be injected here -->
                            </div>
                            <div id="aiLoading" class="hidden flex flex-col items-center justify-center py-4">
                                <div class="dot-flashing"></div>
                                <p class="text-xs text-indigo-400 mt-3 animate-pulse">正在解讀盤勢心理...</p>
                            </div>
                        </div>

                        <div class="mt-2">
                             <button onclick="copyReport()" id="copyBtn" class="w-full flex items-center justify-center space-x-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg transition-colors text-sm border border-slate-300 shadow-sm">
                                <span>📋 複製完整戰報</span>
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- API Key 設定區 (選用) -->
            <details class="group mt-4 bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                <summary class="flex justify-between items-center font-bold text-gray-700 p-3 cursor-pointer hover:bg-gray-100">
                    <span>⚙️ 設定 API Key (選用：解鎖 AI 功能)</span>
                    <span class="text-gray-400 transition-transform group-open:rotate-180">▼</span>
                </summary>
                <div class="p-3 bg-white">
                    <p class="text-xs text-gray-500 mb-2">本系統已內建「石頭戰略邏輯庫」，不需 Key 也能產出完整報告！<br>
                    <span class="text-indigo-600 font-bold">✨ 若需啟用「完整 AI 分析」，請填入 Gemini API Key。</span></p>
                    <input type="password" id="userApiKey" class="w-full p-2 border border-gray-300 rounded text-sm mb-2" placeholder="貼上 API Key (選填)">
                    <button onclick="saveApiKey()" class="bg-gray-800 text-white text-xs px-3 py-1.5 rounded hover:bg-gray-900 transition-colors w-full">💾 儲存設定</button>
                </div>
            </details>

        </div>
    </div>

    <script>
        const apiKey = ""; // Keep empty for local usage logic
        let baseReportText = "";
        let aiReportContent = "";
        let currentSimulationType = null; // Track current simulation mode

        // 初始化：讀取儲存的 API Key
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('userApiKey').value = savedKey;
            }
            
            // Add listeners to input fields to reset simulation type on manual edit
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    if (currentSimulationType) {
                        currentSimulationType = null;
                    }
                });
            });
        });
        
        // --- 核心複製功能 (V12.9.1 iOS 修正版) ---
        async function copyReport() {
            if (!baseReportText) {
                alert("請先執行運算以生成戰報！");
                return;
            }

            let fullReport = baseReportText;
            if (aiReportContent) {
                // FIXED: Explicitly add the header for the AI section
                fullReport += `\n\n【四、🧠 石頭戰略分析報告】\n${aiReportContent}`;
            }

            try {
                await navigator.clipboard.writeText(fullReport);
                showCopySuccess();
                return;
            } catch (err) {
                console.warn('Clipboard API failed, trying fallback...', err);
            }

            const textarea = document.createElement('textarea');
            textarea.value = fullReport;
            textarea.style.position = 'fixed'; 
            textarea.style.bottom = '0';
            textarea.style.left = '0';
            textarea.style.width = '2em';
            textarea.style.height = '2em';
            textarea.style.padding = '0';
            textarea.style.border = 'none';
            textarea.style.outline = 'none';
            textarea.style.boxShadow = 'none';
            textarea.style.background = 'transparent';
            textarea.setAttribute('readonly', '');
            document.body.appendChild(textarea);

            if (navigator.userAgent.match(/ipad|iphone/i)) {
                const range = document.createRange();
                range.selectNodeContents(textarea); 
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textarea.setSelectionRange(0, 999999);
            } else {
                textarea.select();
            }

            try {
                const successful = document.execCommand('copy');
                if (successful) showCopySuccess();
                else alert('複製失敗，請長按文字手動複製');
            } catch (err) {
                alert('複製失敗，瀏覽器不支援');
            }

            document.body.removeChild(textarea);
        }

        function showCopySuccess() {
           const btn = document.getElementById('copyBtn');
           const originalText = btn.innerHTML;
           btn.innerHTML = '<span class="text-green-600">✅ 已複製到剪貼簿！</span>';
           setTimeout(() => btn.innerHTML = originalText, 2000);
        }
        
        window.copyReport = copyReport;

        function saveApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert("✅ API Key 已儲存！已啟用增強版 AI 分析功能。");
            } else {
                localStorage.removeItem('gemini_api_key');
                alert("⚠️ API Key 已清除，將切換回內建戰略邏輯庫。");
            }
        }

        function simulate(type) {
            clearInputs(false); 
            currentSimulationType = type; 

            if (type === 'strong') {
                document.getElementById('stockName').value = "模擬個股 (TEST)";
                document.getElementById('high3d').value = 100;
                document.getElementById('low3d').value = 90; 
                document.getElementById('avgVol').value = 1000;
                setStatus('RED');
                document.getElementById('closePrice').value = 108;
                document.getElementById('todayHigh').value = 108; 
                document.getElementById('breakoutLow').value = 98; 
                document.getElementById('todayVol').value = 2000;
                document.getElementById('prevClose').value = 100; 
                document.getElementById('todayLow').value = 105;
                document.getElementById('prevLow').value = 98;
            } else if (type === 'break') {
                document.getElementById('stockName').value = "模擬個股 (TEST)";
                document.getElementById('high3d').value = 100;
                document.getElementById('low3d').value = 90; 
                document.getElementById('avgVol').value = 1000;
                setStatus('GREEN'); 
                document.getElementById('closePrice').value = 103;
                document.getElementById('todayHigh').value = 103;
                document.getElementById('breakoutLow').value = 100;
                document.getElementById('todayVol').value = 1500;
            } else if (type === 'crash') {
                document.getElementById('stockName').value = "模擬個股 (TEST)";
                document.getElementById('high3d').value = 100;
                document.getElementById('low3d').value = 90; 
                document.getElementById('avgVol').value = 1000;
                setStatus('RED'); 
                document.getElementById('closePrice').value = 85; 
                document.getElementById('todayHigh').value = 92;
                document.getElementById('breakoutLow').value = 95; 
                document.getElementById('todayVol').value = 3000;
            } else if (type === 'flat') {
                document.getElementById('stockName').value = "模擬個股 (TEST)";
                document.getElementById('high3d').value = 100;
                document.getElementById('low3d').value = 90; 
                document.getElementById('avgVol').value = 1000;
                setStatus('GREEN');
                document.getElementById('closePrice').value = 98; 
                document.getElementById('todayHigh').value = 99;
                document.getElementById('breakoutLow').value = 95;
                document.getElementById('todayVol').value = 600;
            }

            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.classList.remove('highlight-input');
                void input.offsetWidth;
                input.classList.add('highlight-input');
            });
            
            setTimeout(() => {
                calculateStrategy();
                const resultArea = document.getElementById('resultArea');
                resultArea.classList.remove('hidden');
                resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        const checkboxes = document.querySelectorAll('#sellChecklist input[type="checkbox"]');
        const adviceBox = document.getElementById('sellAdvice');
        checkboxes.forEach(chk => {
            chk.addEventListener('change', () => {
                const allChecked = Array.from(checkboxes).every(c => c.checked);
                if (allChecked) adviceBox.classList.remove('hidden');
                else adviceBox.classList.add('hidden');
            });
        });

        function clearInputs(hideResult = true) {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
            document.querySelectorAll('input[type="checkbox"]').forEach(box => box.checked = false);
            adviceBox.classList.add('hidden');
            document.getElementById('aiAnalysisBox').classList.add('hidden');
            document.getElementById('aiContent').innerHTML = '';
            aiReportContent = ""; 
            currentSimulationType = null; 
            if(hideResult) document.getElementById('resultArea').classList.add('hidden');
            setStatus('GREEN');
            if(hideResult) window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        function formatPrice(num) {
            return parseFloat(num).toFixed(2);
        }
        function setStatus(status) {
            document.getElementById('currentStatus').value = status;
            document.getElementById('btn-green').className = status === 'GREEN' ? "py-3 px-4 border-2 rounded-lg font-bold transition-all border-green-500 bg-green-50 text-green-700 shadow-inner ring-2 ring-green-100 opacity-100" : "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            document.getElementById('btn-red').className = status === 'RED' ? "py-3 px-4 border-2 rounded-lg font-bold transition-all border-red-500 bg-red-50 text-red-700 shadow-inner ring-2 ring-red-100 opacity-100" : "py-3 px-4 border-2 rounded-lg font-bold transition-all border-slate-200 text-slate-400 hover:bg-slate-50 opacity-60";
            
            if(status === 'GREEN') {
                document.getElementById('advancedInputs').classList.add('hidden');
                document.getElementById('sellChecklist').classList.add('hidden');
            } else {
                document.getElementById('advancedInputs').classList.remove('hidden');
                document.getElementById('sellChecklist').classList.remove('hidden');
            }
        }

        function calculateStrategy() {
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-error'));
            document.getElementById('aiAnalysisBox').classList.add('hidden');
            document.getElementById('aiContent').innerHTML = '';
            aiReportContent = "";

            // Use the generic logic, but also support manual overrides
            // If currentSimulationType is set, force that type.
            // Otherwise, determine type from user inputs dynamically.
            
            const stockName = document.getElementById('stockName').value || "未輸入股名";
            const status = document.getElementById('currentStatus').value;
            const close = parseFloat(document.getElementById('closePrice').value);
            const todayH = parseFloat(document.getElementById('todayHigh').value); 
            const high3d = parseFloat(document.getElementById('high3d').value); 
            const L = parseFloat(document.getElementById('low3d').value);    
            const breakoutLow = parseFloat(document.getElementById('breakoutLow').value); 
            const todayVol = parseFloat(document.getElementById('todayVol').value);
            const avgVol = parseFloat(document.getElementById('avgVol').value);
            const isFullSell = Array.from(checkboxes).every(c => c.checked);
            const prevClose = parseFloat(document.getElementById('prevClose').value);
            const todayLow = parseFloat(document.getElementById('todayLow').value);
            const prevLow = parseFloat(document.getElementById('prevLow').value);
            const prevLongRedLow = parseFloat(document.getElementById('prevLongRedLow').value);

            let hasError = false;
            let errorMsg = "請檢查紅框欄位：\n";
            if (!status) { errorMsg += "- 請選擇目前狀態\n"; hasError = true; }
            if (isNaN(close)) { document.getElementById('closePrice').classList.add('input-error'); errorMsg += "- 請輸入目前價\n"; hasError = true; }
            if (isNaN(high3d)) { document.getElementById('high3d').classList.add('input-error'); errorMsg += "- 請輸入前三高\n"; hasError = true; }
            if (isNaN(L)) { document.getElementById('low3d').classList.add('input-error'); errorMsg += "- 請輸入前三低\n"; hasError = true; }
            if (hasError) { alert(errorMsg); return; }

            let h2 = isNaN(todayH) ? close : todayH; 
            if(h2 < close) h2 = close;
            const gap = h2 - L;
            let target1 = 0, target2 = 0, target5 = 0;
            let isTargetValid = true;
            if (!isNaN(breakoutLow) && close < breakoutLow) isTargetValid = false; 

            if (gap > 0) {
                target1 = h2 + gap;
                target2 = h2 + (2 * gap);
                target5 = h2 + (5 * gap);
                document.getElementById('valH2').innerText = h2;
                document.getElementById('valL').innerText = L;
                document.getElementById('target1').innerText = formatPrice(target1);
                document.getElementById('target2').innerText = formatPrice(target2);
                document.getElementById('target5').innerText = formatPrice(target5);
                const targetBox = document.getElementById('targetBox');
                targetBox.classList.remove('hidden');
                if (isTargetValid) {
                    targetBox.className = "bg-green-50 p-3 rounded border border-green-200 mb-3 text-xs shadow-sm";
                    document.getElementById('targetList').classList.remove('invalid-target');
                    document.getElementById('targetInvalidMsg').classList.add('hidden');
                    document.getElementById('targetStatusBadge').innerText = "Active";
                    document.getElementById('targetStatusBadge').className = "text-[10px] bg-green-200 px-1 rounded text-green-800";
                } else {
                    targetBox.className = "bg-gray-100 p-3 rounded border border-gray-300 mb-3 text-xs shadow-sm opacity-75";
                    document.getElementById('targetList').classList.add('invalid-target');
                    document.getElementById('targetInvalidMsg').classList.remove('hidden');
                    document.getElementById('targetStatusBadge').innerText = "Invalid";
                    document.getElementById('targetStatusBadge').className = "text-[10px] bg-gray-300 px-1 rounded text-gray-700";
                }
            } else {
                document.getElementById('targetBox').classList.add('hidden');
            }

            // Determine Pattern Type for Standard Calculation
            let isStrong = false;
            let isBreakout = false;
            let isBreakdown = false;
            let determinedType = 'flat'; // default

            if (status === 'RED') {
                if (close < L) {
                    isBreakdown = true; 
                    determinedType = 'crash';
                } else {
                    if (!isNaN(prevClose) && !isNaN(todayLow) && !isNaN(prevLow)) {
                        if (close > prevClose && todayLow > prevLow) {
                            isStrong = true;
                            determinedType = 'strong';
                        } else if (close >= high3d) {
                            // Can be breakout or strong, let's say breakout if close to high3d, strong if way above?
                            // Actually 'breakout' is usually Day 1.
                            // If status is RED (Holding), it might be strong or breakout.
                            // Let's use Strong template for Holding RED.
                            determinedType = 'strong'; 
                        } else {
                            // Accumulation / Pan-Jian
                            determinedType = 'flat'; // Or a separate 'accumulation' type if we had one
                        }
                    } else {
                        if (close > high3d) {
                            determinedType = 'strong';
                        } else {
                            determinedType = 'flat';
                        }
                    }
                }
            } 
            
            if (isBreakdown || (status === 'RED' && close < L) || (status === 'GREEN' && close < L)) {
                  isBreakdown = true;
                  determinedType = 'crash';
            }

            if (status === 'GREEN' && close > high3d) {
                isBreakout = true; 
                determinedType = 'break';
            } else if (status === 'GREEN' && !isBreakout && !isBreakdown) {
                determinedType = 'flat';
            }

            // If explicit simulation, use that type. Otherwise use determined type from inputs.
            const typeToRender = currentSimulationType ? currentSimulationType : determinedType;
            
            // Map determinedType to specific styles for renderV16Simulation
            // Because renderV16Simulation now handles ALL logic dynamically based on inputs
            renderV16Simulation(typeToRender);
        }

        // --- New V16 Rendering Logic ---
        function renderV16Simulation(type) {
             const resultArea = document.getElementById('resultArea');
             resultArea.classList.remove('hidden');
             const resultBox = document.getElementById('resultBox');
             
             // Get values directly from inputs to make it dynamic (floating)
             const stockName = document.getElementById('stockName').value || "模擬個股";
             const close = parseFloat(document.getElementById('closePrice').value);
             const todayH = parseFloat(document.getElementById('todayHigh').value); 
             const high3d = parseFloat(document.getElementById('high3d').value); 
             const L = parseFloat(document.getElementById('low3d').value);    
             const breakoutLow = parseFloat(document.getElementById('breakoutLow').value); 
             const avgVol = parseFloat(document.getElementById('avgVol').value);
             
             // Calculations for dynamic text
             const gap = todayH - L;
             const target1 = todayH + gap;
             const target2 = todayH + (2 * gap);
             const target5 = todayH + (5 * gap);
             
             const v_break = Math.round(avgVol * 1.3);
             const v_strong = Math.round(avgVol * 1.5);
             const v_wash = Math.round(avgVol * 0.8);
             
             // Base Report Text Variables
             let rTitleText = "", rActionText = "", rBoxClass = "", rTitleClass = "", rActionClass = "", rIconText = "", rTrendText = "", rVolText = "", rAdviceText = "", rInfText = "";
             let v16BaseReport = "";
             let v16AIReport = "";

             // Helper for safe formatting
             const fP = (num) => isNaN(num) ? "---" : formatPrice(num);
             const fN = (num) => isNaN(num) ? "---" : formatNumber(num);

             if (type === 'strong') {
                rTitleText = "🔥 強軋空盤";
                rActionText = "死抱不放 (限模擬極強模組)";
                rBoxClass = "bg-red-100 border-red-600";
                rTitleClass = "text-xl font-bold text-red-700";
                rActionClass = "text-2xl font-black text-red-800 border-b border-red-300 pb-2 mb-2";
                rIconText = "💎";
                rTrendText = "🔥 強軋空盤 (主力鎖碼)";
                rVolText = "極強攻擊量 (1.5 倍↑)";
                
                const washPrice7 = (close * 0.93).toFixed(2); // 7% down
                const greyLow = (close * 0.97).toFixed(2);
                const greyHigh = (close * 0.99).toFixed(2);

                v16BaseReport = `1. 【模擬極強】(多頭最強勢 - 獲利極大化)

嗨，我是石頭，希望我的 N 字戰法分析系統能讓你大幅提升勝率📈💯

N 字戰法指揮中心 by.石頭 V18.2

「本策略僅為個人分析參考，投資有風險，操作需自負盈虧」

股名：${stockName}

【一、個股現況分析】

📌 操作指令：【 死抱不放（限模擬極強模組） 】

(請確認模組狀態符合條件再操作)

⚡ 量能狀態： 極強攻擊量 (1.5 倍↑)

💰 當前現價： ${fP(close)}

📉 7% 洗盤：跌到${washPrice7}$ (當日盤中最大容忍值)

📈 盤勢型態： 🔥 強軋空盤 (主力鎖碼)

✅ 波段目標： 5N (${fP(target5)})

⚠️ 結構防守： ${fP(breakoutLow)} (以收盤價為最終判準，不破此點上述目標才有效)

⚠️ 提醒：「死抱」僅適用於盤勢仍屬於【模擬極強】期間，一旦盤勢降級，該指令立即失效。

★ 量價推演 (均量指過去 5 日平均成交量 ${fN(avgVol)})：

🔥 攻擊門檻 (1.3x)：${fN(v_break)}（達標）✅

🚿 洗盤門檻 (0.8x)：${fN(v_wash)}

📌 小結： 本檔「${stockName}」處於主升段，此時最大的敵人，仍然是「想提早下車的自己」。

🎯 動態測幅基準 (起點以 ${fP(L)} 為例，h2 = ${fP(todayH)}，公式：目標價 = h2 + N × (h2 - 起點))

一飽 (1N)： ${fP(target1)}（非賣點，僅測幅）

二吐 (2N)： ${fP(target2)}（加碼單可減碼）

五倍 (5N)： ${fP(target5)}（波段終極目標）

【二、明日開盤・量能作戰劇本】

💡 戰術小卡： 預估量 = 09:15 成交量 × 8

🔴 劇本 A（極強鎖攻）

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 預估量 > ${fN(v_strong)} 張 (1.5x↑)

👉 指令： 抱緊 (Hold)，若直接鎖漲停，排隊小幅加碼。(請確認模組狀態符合條件再操作)

🟢 劇本 B（續強推進）

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 預估量 ${fN(v_break)}～${fN(v_strong)} 張 (1.3x ~ 1.5x)

👉 指令： 續抱 (Hold)，盤中震盪屬於健康換手。(請確認模組狀態符合條件再操作)

🟡 劇本 C（量縮整理）

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 預估量 < ${fN(v_wash)} 張 (0.8x↓)

⚠️ 註：極強盤量縮標準為 <0.8x，與盤整盤不同。

👉 指令： 續抱 (Hold)。後續若「再出量」站穩當日均價線，方可加碼。

⚫ 劇本 D（高檔警訊）

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 爆量 (> ${fN(Math.round(avgVol * 2))} 張，約 2.0x↑) 且收黑 K

👉 指令： 減碼 (Trim)，高檔爆量為潛在出貨前兆。(請確認模組狀態符合條件再操作)

⚠️ 實戰灰色地帶補強 (SOP 外的應變)

量價背離的灰色區（劇本 A 與 B 之間）：

狀況： 量能預估落在 ${fN(v_break)}~${fN(v_strong)} 張（攻擊量），但價格卻軟腳跌至 ${greyLow}~${greyHigh}。

應變： 暫不加碼。雖然有量，但價格不強，僅觀察是否為換手洗盤。

量縮的真假判斷（劇本 C 的細節）：

狀況： 預估量 < ${fN(v_wash)} 張（量縮）。

應變：

若價格仍 > ${fP(breakoutLow)} (結構防守點) → 健康洗盤，續抱。

若價格跌破 ${fP(breakoutLow)} → 動能減弱，考慮降碼。

盤中急殺的幅度定義：

狀況： 盤中急殺幅度在 7%~8% 之間（以當前股價 ${fP(close)} 計算約來到 ${washPrice7} 元附近），尚未觸及 ${fP(breakoutLow)} 防守點。

應變： 嚴守收盤價。盤中不恐慌殺低，若收盤無法拉回 ${washPrice7} 以上，視為轉弱訊號。

【三、📌 極強盤操作策略專屬・關鍵三問】

❓ Q1：漲這麼多了，我很怕，能不能先賣一趟？

邏輯說明（不建議過早下車）： 在軋空主升段中，最容易犯的錯誤是「因為怕高而賣在主升段中途」。只要未出現否決條款，現在賣出，後續漲幅將與你無關。

操作建議：

價格未跌破 ${fP(breakoutLow)} → 堅持抱（Hold）

若已漲至 ${fP(target2)}~${fP(target5)} → 可考慮部分減碼，但仍以結構不破為主。

❓ Q2：盤中如果急殺跳水，要不要跑？

邏輯： 看收盤，不看盤中。強勢股常見「洗盤急殺」。只要收盤未破結構防守，盤中急殺屬於換手與洗籌，不構成趨勢反轉。

❓ Q3：什麼情況下，死抱會失效？

極強盤否決條款（任一成立 → 降級處理）：

爆量但無法創高： 成交量 ≥ ${fN(v_strong)} (1.5x↑均量) 但股價未創新高 → 降級。

連續兩日量增，但高點停滯： 連續兩日量增（>${fN(v_break)} 張）但高點推不動 → 降級。

跌破結構防守點： 收盤跌破 ${fP(breakoutLow)} → 必須減碼。`;

                v16AIReport = `(一) 主力心理透視： 主力仍處於拉抬主升段，但會透過震盪與洗盤測試市場耐心。
(二) 散戶心理陷阱： 過早獲利了結；把「極強盤」當成永遠不會結束的信仰。
(三) 教練心法： 「死抱是紀律，不是信仰；抱的是趨勢，不是幻想。」
(四) 石頭戰略結論：
● 盤勢定調： 軋空主升段（尚未結束）
🎯 核心策略：
結構不破 → 抱
動能鈍化 → 降
模組切換 → 全面重新評估`;

             } else if (type === 'break') {
                rTitleText = "🔥 三盤突破 (翻紅)";
                rActionText = "積極進場";
                rBoxClass = "bg-red-50 border-red-500";
                rTitleClass = "text-xl font-bold text-red-600";
                rActionClass = "text-2xl font-black text-red-700 border-b border-red-200 pb-2 mb-2";
                rIconText = "🚀";
                rTrendText = "🚀 突破頸線 (N字起點)";
                rVolText = "帶量突破 (Day 1)";
                
                const greyBreakLow = (close * 0.98).toFixed(2); // approximate 2% range for grey area

                v16BaseReport = `2. 【模擬突破】(起漲第一天)

嗨，我是石頭，希望我的 N 字戰法分析系統能讓你大幅提升勝率📈💯

N 字戰法指揮中心 by.石頭 V18.2

「本策略僅為個人分析參考，投資有風險，操作需自負盈虧」

股名：${stockName}

【一、個股現況分析】

📌 操作指令：【 積極進場 】

(請確認模組狀態符合條件再操作)

⚡ 量能狀態： 帶量突破 (Day 1)

💰 當前現價： ${fP(close)}

🛡️ 防守頸線： ${fP(breakoutLow)} (跳空缺口或頸線)

📈 盤勢型態： 🚀 突破頸線 (N字起點)

✅ 目標直指： 1N (${fP(target1)})

★ 量價推演 (均量指過去 5 日平均成交量 ${fN(avgVol)})：

🔥 攻擊門檻 (1.3x)：${fN(v_break)}（達標）✅

🚿 洗盤門檻 (0.8x)：${fN(v_wash)}

📌 小結： 本檔「${stockName}」今日正式表態，脫離盤整區，為最佳進場時機。

🎯 動態測幅基準 (起點以 ${fP(L)} 為例，h2 = ${fP(todayH)}，公式：目標價 = h2 + N × (h2 - 起點))

一飽(1N)： ${fP(target1)} (初步獲利點)

二吐(2N)： ${fP(target2)} (加碼單減碼點)

五倍(5N)： ${fP(target5)} (波段終極目標)

【二、明日開盤・量能作戰劇本】

💡 戰術小卡： 預估量 = 09:15 成交量 × 8

🔴 劇本 A (跳空開高)

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 預估量 > ${fN(v_strong)} 張 (1.5x↑) 且 開盤價 > ${fP(close)}

👉 指令： 市價追 (Buy)，強勢缺口不補，行情噴出。

🟢 劇本 B (平盤震盪)

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 預估量 ${fN(v_break)} 張左右 (約 1.3x)

👉 指令： 佈局 (Buy)，趁盤中拉回 101~102 建立基本部位。

🟡 劇本 C (量縮回測)

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 預估量 < ${fN(v_wash)} 張 (0.8x↓)

👉 指令： 觀察 (Wait)，若收盤不破 ${fP(breakoutLow)}，尾盤可小買。

⚫ 劇本 D (假突破)

🔹 防守價：${fP(breakoutLow)}

🔹 條件： 收盤跌破 ${fP(breakoutLow)} 且 爆量收黑

👉 指令： 停損 (Stop Loss)，確認為假突破騙線。

⚠️ 實戰灰色地帶補強 (SOP 外的應變)

量不足的尷尬區（劇本 B 與 C 之間）：

狀況： 預估量落在 ${fN(v_wash)} ~ ${fN(v_break)} 張。

應變： 動能未完全確認，僅限小量佈局或觀望，嚴禁追價。

開盤漲幅的尷尬區：

狀況： 開盤漲幅約 4%（3%~5%之間），且預估量 < ${fN(v_strong)} 張。

應變： 不要市價追。高機率會回測均價線，請耐心等待回檔再接。

【三、📌 突破操作策略明日實戰・關鍵三問】

❓ Q1：昨天沒買到，明天開高可以直接追嗎？

建議：

開盤漲幅 ≤ 3% → 市價直接追買。

開盤漲幅 > 5% → 等盤中回測均價線（101~102）再接。

❓ Q2：怎麼判斷突破是真的還是假？

判斷標準： 三天原則 + 頸線防守 (頸線價位：${fP(breakoutLow)})

❓ Q3：買進後開始盤跌怎麼辦？

防守策略： 嚴守 ${fP(breakoutLow)} 元整數關卡

停損點： 收盤跌破 ${fP(breakoutLow)} → 無條件停損出場。

盤中回測情況： 盤中回測區間 (${fP(breakoutLow)}~${greyBreakLow}，約突破價 ±1%) → 視為健康回測，暫不動作。`;

                v16AIReport = `(一) 主力心理透視： 主力剛花錢吃掉頸線賣壓，成本就在這附近。現在進場是「跟著主力成本一起跑」。
(二) 散戶心理陷阱： 猶豫不決，想等「拉回再買」，結果股價一去不回頭。
(三) 教練心法： 「第一根突破不買，後面你就買不下手了。寧可買錯停損，不可錯過飆股。」
(四) 石頭戰略結論：
● 盤勢定調： 趨勢反轉確認 (由盤整轉多)。
🎯 核心策略： 大膽建立部位，嚴格設定停損。`;

             } else if (type === 'flat') {
                rTitleText = "💤 盤整延續";
                rActionText = "觀望 / 空手";
                rBoxClass = "bg-green-50 border-green-500";
                rTitleClass = "text-xl font-bold text-green-700";
                rActionClass = "text-2xl font-black text-green-800 border-b border-green-200 pb-2 mb-2";
                rIconText = "🐢";
                rTrendText = "💤 箱型震盪 (方向未明)";
                rVolText = "量縮整理 (人氣退潮)";

                // Use high3d as box top, breakoutLow as box bottom if present, else fallback
                const boxTop = isNaN(high3d) ? close * 1.05 : high3d;
                const boxBottom = isNaN(breakoutLow) ? close * 0.95 : breakoutLow;
                const v_break_flat = Math.round(avgVol * 1.3);
                const v_wash_flat = Math.round(avgVol * 0.8);

                v16BaseReport = `3. 【模擬盤整】(觀望等待)

嗨，我是石頭，希望我的 N 字戰法分析系統能讓你大幅提升勝率📈💯

N 字戰法指揮中心 by.石頭 V18.2

「本策略僅為個人分析參考，投資有風險，操作需自負盈虧」

股名：${stockName}

【一、個股現況分析】

📌 操作指令：【 觀望 / 空手 】

(請確認模組狀態符合條件再操作)

⚡ 量能狀態： 量縮整理 (人氣退潮)

💰 當前現價： ${fP(close)}

📦 箱體區間： ${fP(boxBottom)} (底) ~ ${fP(boxTop)} (頂)

📈 盤勢型態： 💤 箱型震盪 (方向未明)

✅ 觀察重點： 能否帶量突破 ${fP(boxTop)}

⚠️ 防守要點： 箱底支撐 ${fP(boxBottom)} 不可破

★ 量價推演 (均量指過去 5 日平均成交量 ${fN(avgVol)})：

🔥 攻擊門檻 (1.3x)：${fN(v_break)} (未達標)

🚿 洗盤門檻 (0.8x)：${fN(v_wash)} (達標)

📌 小結： ✅ 本檔「${stockName}」目前處於盤整等待期，主力正在磨耐心。

🎯 動態測幅基準

暫無目標價，因趨勢未發動。

當前任務：盯緊 09:15 預估量。

【二、明日開盤・量能作戰劇本】

💡 戰術小卡： 預估量 = 09:15 成交量 × 8

🔴 劇本 A (點火攻擊)

🔹 防守價：${fP(boxBottom)}

🔹 條件： 預估量 > ${fN(v_break)} 張 (1.3x↑) 且 價格突破 ${fP(boxTop)}

👉 指令： 進場 (Buy)，盤整結束，多頭發起進攻。

🟢 劇本 B (持續盤整)

🔹 防守價：${fP(boxBottom)}

🔹 條件： 預估量 ${fN(v_wash)} ~ ${fN(avgVol)} 張 (0.8x ~ 1.0x)，價格在 ${fP(boxBottom)}-${fP(boxTop)} 間

👉 指令： 睡覺 (Sleep)，不要浪費資金與時間。

🟡 劇本 C (極致量縮)

🔹 防守價：${fP(boxBottom)}

🔹 條件： 預估量 < ${fN(Math.round(avgVol * 0.5))} 張 (0.5x↓)

⚠️ 註：盤整盤量縮標準為 <0.5x，與極強盤不同。

👉 指令： 關注 (Watch)，變盤前兆。若盤中量能暴增，即轉【模擬突破】劇本。

⚫ 劇本 D (破底危機)

🔹 防守價：${fP(boxBottom)}

🔹 條件： 跌破 ${fP(boxBottom)}

👉 指令： 刪自選 (Delete)。

⚠️ 特別說明：帶量破底 (>${fN(Math.round(avgVol * 1.2))} 張) 為絕對出場點；若無量跌破箱底 (<${fN(Math.round(avgVol * 1.2))} 張)，雖暫不一定立即停損，但視為趨勢轉弱警訊，需減持觀望。

⚠️ 實戰灰色地帶補強 (SOP 外的應變)

箱頂附近的灰色誘惑：

狀況： 價格來到 ${fP(boxTop)}附近，但量能只有 ${fN(v_wash_flat)}~${fN(avgVol)} 張（未達攻擊量）。

應變： 不要偷跑。必須嚴格遵守「量突破 ${fN(v_break)} 且 價格確認站上 ${fP(boxTop)}」才能進場。

【三、📌盤整操作策略專屬明日實戰・關鍵三問】

❓ Q1：現在價格好便宜，我能不能先買起來放？

建議： ❌ 不建議現在買！資金有機會成本。

❓ Q2：要看到什麼訊號，才代表盤整結束？

🔥 點火訊號： 第一根帶量紅 K 棒。

判斷條件： 成交量 ≥ ${fN(Math.round(avgVol * 1.5))} 且 收盤價強勢站上箱頂 ${fP(boxTop)} 元。

❓ Q3：成交量越來越少，是不是沒人玩了？

💡 解讀： 量縮其實是好事，代表籌碼沉澱。「極致量縮」往往是變盤的前兆。`;

                v16AIReport = `(一) 主力心理透視： 主力正在吸納籌碼，透過長時間的磨盤，讓沒耐心的散戶離場。
(二) 散戶心理陷阱： 耐不住寂寞隨意進場，結果被雙巴（追高殺低）。
(三) 教練心法： 「獵人最重要不是槍法，是等待獵物出現的耐心。看不懂就休息，現金為王。」
(四) 石頭戰略結論：
● 盤勢定調： 籌碼沉澱期。
🎯 核心策略： 設好「價格警示」(${fP(boxTop)}元)，響了再來看。`;

             } else if (type === 'crash') {
                rTitleText = "⚠️ 三盤跌破";
                rActionText = "停損 / 反手放空";
                rBoxClass = "bg-green-100 border-green-600";
                rTitleClass = "text-xl font-bold text-green-900";
                rActionClass = "text-2xl font-black text-green-900 underline border-b border-green-300 pb-2 mb-2";
                rIconText = "📉";
                rTrendText = "📉 頭部完成 (空方趨勢)";
                rVolText = "帶量下殺 (主力出貨)";

                const drop20 = (close * 0.8).toFixed(2);
                // In simulation inputs, breakoutLow is used as pressure
                const pressure = isNaN(breakoutLow) ? close * 1.05 : breakoutLow;
                // Use todayHigh as h2 in crash simulation logic if available
                const crash_h2 = todayH;
                const down_target = L - (todayH - L); // Basic measured move
                const pressure_low = (pressure * 0.98).toFixed(2);

                v16BaseReport = `4. 【模擬大跌】(空方崩盤)

嗨，我是石頭，希望我的 N 字戰法分析系統能讓你大幅提升勝率📈💯

N 字戰法指揮中心 by.石頭 V17.2

「本策略僅為個人分析參考，投資有風險，操作需自負盈虧」

股名：${stockName}

【一、個股現況分析】

📌 操作指令：【 停損 / 反手放空 】

(請確認模組狀態符合條件再操作)

⚡ 量能狀態： 帶量下殺 (主力出貨)

💰 當前現價： ${fP(close)}

📉 20% 跌幅： 跌到${drop20}$ (無底深淵)

📈 盤勢型態： 📉 頭部完成 (空方趨勢)

✅ 下檔支撐： 深不可測 (勿猜底)

⚠️ 壓力關卡： ${fP(pressure)} (原支撐變壓力)

★ 量價推演 (均量指過去 5 日平均成交量 ${fN(avgVol)})：

🔥 下殺攻擊量 (1.3x)：${fN(v_break)}（達標）✅

📌 小結： 本檔「${stockName}」結構已壞，任何反彈皆是空點。

🎯 動態測幅基準 (h2=${fP(crash_h2)}，公式：目標價 = h2 - N × (頭部 - h2))

反壓目標： 90.00 (逃命點)

下殺測幅： ${fP(down_target)} (第一階段滿足點)

【二、明日開盤・量能作戰劇本】

💡 戰術小卡： 預估量 = 09:15 成交量 × 8

🔴 劇本 A (跳空大跌)

🔹 防守壓力：${fP(pressure)}

🔹 條件： 預估量 > ${fN(v_strong)} 張 (1.5x↑) 且 開低。

👉 指令： 若帶量確認跌破前低，可追空 (Short)，嚴防無量空殺。

🟢 劇本 B (弱勢反彈)

🔹 防守壓力：${fP(pressure)}

🔹 條件： 量縮 (${fN(v_wash)}張，約 0.8x) 紅盤。

👉 指令： 逃命 (Exit)，保留資金等待下一波下跌。

🟡 劇本 C (量縮緩跌)

🔹 防守壓力：${fP(pressure)}

🔹 條件： 預估量 < ${fN(v_wash)} 張 (0.8x↓)。

👉 指令： 空單續抱 (Hold Short)。

⚫ 劇本 D (V型反轉)

🔹 防守壓力：${fP(pressure)}

🔹 條件： 收盤站回 ${fP(pressure)}、量能達 ${fN(v_break)} (1.3x↑) 且 連續兩日量增

👉 指令： 回補空單 (Cover)，可能為假跌破，先退場觀望。

⚠️ 實戰灰色地帶補強 (SOP 外的應變)

反彈壓力區：

狀況： 股價反彈至 ${fP(pressure)} 附近，且爆出大量，但收盤剛好卡在 ${fP(pressure)} 或微幅跌破。

應變： 建議先回補 1/3 空單鎖住利潤，剩下的觀察明日是否站穩 ${fP(pressure)}。

【三、📌 大跌盤操作策略專屬明日實戰・關鍵三問】

❓ Q1：已經跌了，能不能進場攤平？

當前價： ${fP(close)}

20% 跌幅對照： (從 ${fP(close)} 算起 20% 為 ${drop20} 元)

❌ 警告： 這是自殺行為！不要接刀子。

❓ Q2：我想放空，哪裡是最好的空點？

反彈壓力區： ${pressure_low}~${fP(pressure)}

📈 建議操作： 等待股價反彈至壓力區卻漲不動，出現上影線時為勝率最高的空點。

❓ Q3：如果明天開紅盤，是不是代表止跌了？

❌ 迷思： 紅盤 ≠ 止跌。

關鍵判斷： 若股價仍 < ${fP(pressure)} → 只是死貓跳，空頭趨勢未改。`;

                v16AIReport = `(一) 主力心理透視： 主力早已在高檔出貨完畢，現在是讓散戶互相踩踏。
(二) 散戶心理陷阱： 不甘心虧損，患得患失。
(三) 教練心法： 「留得青山在，不怕沒柴燒。截斷虧損，讓利潤奔跑。」
(四) 石頭戰略結論：
● 盤勢定調： 空方主跌段。
🎯 核心策略： 只出不進，甚至反手做空。嚴禁抄底。`;
             }
             
             // Update UI
             resultBox.className = `p-5 rounded-xl border-l-8 shadow-md relative overflow-hidden ${rBoxClass}`;
             document.getElementById('stockBadge').innerText = stockName;
             document.getElementById('resultTitle').innerText = rTitleText;
             document.getElementById('resultTitle').className = rTitleClass;
             document.getElementById('resultAction').innerText = rActionText;
             document.getElementById('resultAction').className = rActionClass;
             document.getElementById('resultIcon').innerText = rIconText;
             document.getElementById('trendTag').innerText = rTrendText;
             document.getElementById('trendTag').className = "text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-700 border border-slate-200"; 
             document.getElementById('volTag').innerText = rVolText;
             document.getElementById('volTag').className = "text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-700 border border-slate-200";
             document.getElementById('patternTag').classList.add('hidden'); // Hide for custom V16 sim
             document.getElementById('inferenceBox').classList.add('hidden'); // Content already in V16 text
             document.getElementById('resultAdvice').innerText = "請參閱下方完整 V18.2 戰略報告。";
             
             // Hide specific calc parts as they are in text
             document.getElementById('targetBox').classList.add('hidden');

             // Render AI Part
             document.getElementById('aiAnalysisBox').classList.remove('hidden');
             document.getElementById('aiLoading').classList.add('hidden');
             document.getElementById('aiReportTitle').innerText = `🧠 石頭戰略(${stockName}) V18.2 分析報告`;
             
             // Parse Markdown for AI Report
             const htmlContent = marked.parse(v16AIReport);
             document.getElementById('aiContent').innerHTML = htmlContent;

             // Set Base Report Text for Copy
             baseReportText = v16BaseReport;
             aiReportContent = v16AIReport; // For appending later
        }

        // --- Functions missing in previous version that caused ReferenceError ---

        async function triggerAnalysis(stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, patternType, isBreakout, isBreakdown, isStrong) {
            const userKey = localStorage.getItem('gemini_api_key');
            document.getElementById('aiAnalysisBox').classList.remove('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiReportTitle').innerText = `🧠 石頭戰略(${stockName})分析報告`;

            if (userKey) {
                await askGeminiStrategy(userKey, stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isBreakout, isBreakdown, isStrong);
            } else {
                setTimeout(() => generateLocalAnalysis(isStrong, patternType, status, isBreakout, isBreakdown), 800);
            }
        }

        function generateLocalAnalysis(isStrong, patternType, status, isBreakout, isBreakdown) {
            document.getElementById('aiLoading').classList.add('hidden');
            let psychology = "", trap = "", mantra = "", conclusion = "";

            if (isBreakdown) {
                psychology = "主力已在高檔完成出貨，目前的下跌是為了打壓股價以利未來（可能是數月後）的低檔回補。現階段主力不會護盤，甚至會利用利空消息加速趕底。";
                trap = "「定錨效應」作祟。散戶會記得這檔股票曾經 108 元，覺得現在 85 元打了八折「好划算」，卻忽略了趨勢已經反轉向下。";
                mantra = "「新手死在追高，老手死在抄底。空頭趨勢中，現金是最好的部位。」";
                conclusion = "● 盤勢定調：空方主跌段 (需避開)。\n● 操作核心：\n1. 持有者：反彈至 90 以上分批停損，保留資金。\n2. 空手者：刪除自選股，眼不見為淨，尋找其他剛起漲的 N 字型態個股。\n3. 紀律：承認錯誤是交易的一部分，留得青山在，不怕沒柴燒。";
            } else if (isBreakout) {
                psychology = "主力花費成本帶量攻過整數關卡，顯示其作價意願強烈。目前的拉抬是為了吸引市場目光，引發追價買盤以利推升股價，此時主力與散戶利益暫時一致。";
                trap = "「懼高症」。散戶看到股價創高會害怕，想等回檔深一點再買，結果往往目送股價噴出，最後受不了在 1N 位置追高被套。";
                mantra = "「突破第一根，寧可追錯，不能放過。買錯了有停損保護，錯過了就是目送獲利。」";
                conclusion = "● 盤勢定調：多頭起漲確認 (N字第一波)。\n● 操作核心：\n1. 持有者：移動停利設在紅棒低點，不破不賣，讓利潤奔跑。\n2. 空手者：明日開盤市價建立部位，回測頸線是加碼禮物。\n3. 紀律：收盤若跌破突破低點，承認是假突破，果斷離場。";
            } else if (status === 'RED' && !isBreakdown) {
                if (isStrong) {
                    psychology = "根據量價結構，主力正進行積極操作。現價穩站頸線與軋空低防守點，成交量放大顯示資金積極湧入而非震盪。主力的目的在於利用買盤壓力迫使空單回補，目前處於明確的「進貨拉抬階段」，並非出貨。";
                    trap = "在強軋空行情中，新手最容易犯兩個錯：\n1. 過早下車：看到紅棒就想跑，結果賣在起漲點，錯失後面 5N 的大魚身。\n2. 預設高點：自己嚇自己，覺得「漲太多了」，結果股價越過高點繼續噴。";
                    mantra = "「趨勢確立後，最大的風險不是下跌，而是你『不在車上』。守住防守點，死抱是功德。」";
                    conclusion = "● 盤勢定調：目前處於「軋空主升段」，多方控盤力度極強。\n● 操作核心：\n1. 持有者：只要不破防守點，請將目標放遠至 5N，不要賺一點就跑。\n2. 空手者：明天若見「量增」且「價格過高」，可勇敢進場建立基本部位。\n3. 風險控制：嚴格執行停損指令，這條線是你的保命符。";
                } else if (patternType.includes("軋空")) {
                    psychology = "目前主力採取「穩健推升」策略，透過盤中震盪消化獲利了結賣壓。成交量溫和放大，顯示主力控盤穩定，意在清洗浮額而非拉高出貨。";
                    trap = "散戶容易因盤中震盪而失去耐心，誤將主力洗盤視為轉弱訊號而提早離場。";
                    mantra = "「買在分歧，抱在一致。」";
                    conclusion = "● 盤勢定調：多方架構完整，屬於標準攻擊型態。\n● 操作核心：續抱，移動停損點至今日低點。";
                } else {
                    psychology = "主力目前進行防守型操作，雖未發動猛攻，但堅守關鍵支撐位。此階段多為蓄力期，測試下方買盤支撐力道。";
                    trap = "容易陷入「不耐久盤」的心理，在發動攻擊前夕因無聊而賣出。";
                    mantra = "「耐心是交易者的美德。」";
                    conclusion = "● 盤勢定調：多方整理，等待放量攻擊訊號。";
                }
            } else {
                  psychology = "多空不明或處於盤整區間，主力觀望意願濃厚，量能不足以發動攻擊。";
                  trap = "容易在盤整區間內追高殺低，耗損資金與信心。";
                  mantra = "「看不懂就休息，不交易也是一種交易。」";
                  conclusion = "● 盤勢定調：盤整或空方抵抗。\n● 操作核心：等待明確突破訊號 (日出+過頸線) 再進場。";
            }

            const reportHTML = `
                <div class="space-y-4">
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(一)、 主力心理透視</h5>
                        <p>${psychology}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(二)、 散戶心理陷阱</h5>
                        <p>${trap.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(三)、 教練心法</h5>
                        <p class="bg-indigo-50 p-2 rounded text-indigo-800 font-bold italic">${mantra}</p>
                    </div>
                    <div>
                        <h5 class="font-bold text-indigo-900 border-l-4 border-indigo-500 pl-2 mb-1">(四)、 石頭戰略結論 (客製化建議)</h5>
                        <p>${conclusion.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('aiContent').innerHTML = reportHTML;
            aiReportContent = `(一)、 主力心理透視
${psychology}
(二)、 散戶心理陷阱
${trap}
(三)、 教練心法
${mantra}
(四)、 石頭戰略結論 (客製化建議)
${conclusion}`;
             
             // Update base report for manual calc so it includes AI part
             baseReportText += `\n\n【四、🧠 石頭戰略分析報告】\n${aiReportContent}`;
        }

        async function askGeminiStrategy(key, stockName, closePrice, status, todayVol, avgVol, high3d, breakoutLow, tacticalAdvice, target1, isBreakout, isBreakdown, isStrong) {
            
            let phaseDesc = status === 'RED' ? '多方 (持有/攻擊)' : '空方 (觀望/整理)';
            if(isBreakout) phaseDesc = "多方攻擊 (剛突破前高)";
            if(isBreakdown) phaseDesc = "空方殺多 (跌破防守點)";
            if(isStrong) phaseDesc = "極強軋空 (噴出段)";

            const promptText = `
                你現在是精通「N字戰法」的資深操盤手教練。請根據以下數據，為使用者進行盤勢心理分析與操作建議。
                
                【當前數據】
                股名：${stockName}
                現價：${closePrice}
                目前盤勢階段：${phaseDesc}
                成交量：${todayVol} (均量: ${avgVol})
                關鍵價位：頸線 ${high3d}, 軋空低防守點 ${breakoutLow}
                系統判斷：${tacticalAdvice}
                測幅目標：一飽 ${target1}

                【任務要求】
                請使用直白、不誇飾、具備高度資訊密度的繁體中文。
                請嚴格依照以下格式輸出（不要有額外的開場白，直接輸出內容）：
                
                (一)、 主力心理透視
                (內容：根據量價結構，推測主力是在進貨、洗盤還是出貨？)
                (二)、 散戶心理陷阱
                (內容：在當前這種盤勢下，新手最容易犯什麼錯？例如過早下車或預設高點？)
                (三)、 教練心法
                (內容：一句簡短有力、具有視覺化語言的操作格言)
                (四)、 石頭戰略結論 (客製化建議)
                (內容：請使用「第四點結論法」，條列式總結以下幾點：
                ● 盤勢定調：(例如：處於軋空主升段)
                ● 操作核心：
                1. 持有者策略
                2. 空手者策略
                3. 風險控制 (強調防守點))
            `;

            try {
                const responseText = await callGeminiAPI(key, promptText);
                document.getElementById('aiLoading').classList.add('hidden');
                aiReportContent = responseText;
                const htmlContent = marked.parse(responseText);
                document.getElementById('aiContent').innerHTML = htmlContent;
                document.getElementById('aiAnalysisBox').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Update base report text for manual calc
                baseReportText += `\n\n【四、🧠 石頭戰略分析報告】\n${aiReportContent}`;

            } catch (error) {
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiContent').innerHTML = `<p class="text-red-500 font-bold">⚠️ 連線異常 (請檢查 Key): ${error.message} <br> <button onclick="generateLocalAnalysis(${isStrong}, '${patternType}', '${status}', ${isBreakout}, ${isBreakdown})" class="text-blue-500 underline mt-2">切換至內建邏輯庫</button></p>`;
            }
        }

        async function callGeminiAPI(key, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if(response.status === 429) throw new Error("請求過於頻繁 (429)，請稍候再試");
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "無法取得分析結果。";
        }
    </script>
</body>
</html>
